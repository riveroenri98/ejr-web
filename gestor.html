<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Env√≠os y CRM con Ranking de Productos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { border-top-color: #4f46e5; animation: spin 1s linear infinite; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .ai-spinner { border-top-color: #10b981; animation: spin 0.8s linear infinite; }
        
        #main-map, #modal-map, #start-point-map, #clients-map, #client-modal-map { 
            width: 100%; 
            border-radius: 0.75rem; 
            border: 1px solid #d1d5db; 
            background-color: #e5e7eb; /* Color de fondo mientras carga el mapa */
        }
        #main-map, #clients-map { height: 65vh; min-height: 500px; }
        #modal-map, #start-point-map, #client-modal-map { height: 300px; }
        .nav-tab[aria-selected="true"] {
            background-color: #4f46e5;
            color: white;
        }
        .nav-tab {
            transition: background-color 0.2s, color 0.2s;
        }

        @media (max-width: 768px) {
            .table-responsive thead { display: none; }
            .table-responsive tr { display: block; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            .table-responsive td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid #eee; }
            .table-responsive td:last-child { border-bottom: none; }
            .table-responsive td::before { content: attr(data-label); font-weight: 600; margin-right: 1rem; text-align: left; }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Pantalla de Login -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="w-full max-w-md p-8 space-y-8 bg-white shadow-xl rounded-2xl">
            <div>
                <h2 class="text-3xl font-extrabold text-center text-gray-900">Iniciar Sesi√≥n</h2>
                <p class="mt-2 text-center text-sm text-gray-600">Accede a tu panel de gesti√≥n</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Correo electr√≥nico</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="relative block w-full px-3 py-3 text-gray-900 placeholder-gray-500 border border-gray-300 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Correo electr√≥nico">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Contrase√±a</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="relative block w-full px-3 py-3 text-gray-900 placeholder-gray-500 border border-gray-300 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Contrase√±a">
                    </div>
                </div>
                <div id="login-error" class="text-sm text-red-600 font-medium hidden"></div>
                <div>
                    <button type="submit" class="relative flex justify-center w-full px-4 py-3 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md group hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Entrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex-col justify-center items-center z-50 hidden">
        <div class="ai-spinner w-10 h-10 rounded-full border-4 border-gray-200"></div>
        <p class="mt-4 text-gray-700 font-medium">Procesando con IA...</p>
    </div>

    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8 hidden">
        <div id="initial-loading-screen" class="fixed inset-0 bg-white flex flex-col justify-center items-center z-50">
            <div class="spinner w-12 h-12 rounded-full border-4 border-gray-200"></div>
            <p class="mt-4 text-gray-600">Cargando tu gestor de env√≠os...</p>
        </div>

        <div id="app-content" class="max-w-screen-2xl mx-auto hidden">
             <header class="mb-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Panel Log√≠stico y CRM con IA</h1>
                        <p class="mt-1 text-gray-500">Gestiona tus pedidos y analiza tu base de clientes.</p>
                    </div>
                    <div>
                        <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </header>

            <!-- Pesta√±as de Navegaci√≥n -->
            <div class="mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                        <button id="tab-logistics" class="nav-tab whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg" aria-selected="true">Log√≠stica y Rutas</button>
                        <button id="tab-clients" class="nav-tab whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg bg-white text-gray-500 hover:text-gray-700 hover:bg-gray-50" aria-selected="false">Clientes</button>
                        <button id="tab-analysis" class="nav-tab whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg bg-white text-gray-500 hover:text-gray-700 hover:bg-gray-50" aria-selected="false">An√°lisis</button>
                    </nav>
                </div>
            </div>

            <!-- Contenido de Log√≠stica -->
            <div id="logistics-view">
                 <div class="flex flex-wrap items-center gap-x-3 gap-y-2 mb-4">
                     <button id="set-start-point-btn" class="flex items-center justify-center bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        Definir Inicio
                     </button>
                     <button id="generate-route-btn" class="flex items-center justify-center bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M18 10c-2.4 0-4.7.9-6.5 2.5a12.4 12.4 0 0 0-6.5 7.5"/><path d="M18 10V4.5a2.5 2.5 0 0 0-5 0V10"/><path d="M12 22a2 2 0 1 0 4 0 2 2 0 1 0-4 0Z"/><path d="M16 4.5a2.5 2.5 0 0 0-5 0V10"/><path d="M10 22a2 2 0 1 0 4 0 2 2 0 1 0-4 0Z"/><path d="M18 10h1a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-1"/><path d="M6 10H5a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h1"/></svg>
                        Crear Hoja de Ruta
                    </button>
                    <button id="add-order-btn" class="flex items-center justify-center bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Agregar Pedido
                    </button>
                </div>
                 <div class="mb-4 text-sm text-gray-600 bg-gray-100 p-2 rounded-md flex items-center justify-between">
                    <p><span class="font-semibold">Punto de partida:</span> <span id="start-point-display" class="italic">No definido</span></p>
                    <p><span class="font-semibold">Usuario:</span> <span id="user-email-display"></span></p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 lg:gap-8">
                    <div class="flex flex-col">
                         <main class="bg-white rounded-xl shadow-lg overflow-hidden flex-grow">
                            <div id="order-list-container" class="overflow-x-auto h-full">
                                <div id="empty-state" class="text-center p-12 hidden">
                                    <h3 class="mt-4 text-xl font-semibold text-gray-800">No hay pedidos todav√≠a</h3>
                                    <p class="mt-1 text-gray-500">Haz clic en "Agregar Pedido" para empezar.</p>
                                </div>
                                <table class="min-w-full divide-y divide-gray-200 table-responsive">
                                    <thead class="bg-gray-50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalle del Pedido</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th></tr></thead>
                                    <tbody id="order-list" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </main>
                    </div>
                    <div class="mt-8 lg:mt-0 space-y-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-700 mb-2">Mapa de Entregas</h3>
                            <div id="main-map" class="shadow-lg"></div>
                        </div>
                        <div id="route-itinerary-container" class="hidden">
                            <h3 class="text-lg font-medium text-gray-700 mb-2">Hoja de Ruta Detallada</h3>
                            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm max-h-60 overflow-y-auto">
                                <ol id="route-itinerary-list" class="space-y-3 text-sm"></ol>
                            </div>
                        </div>
                        <div id="ai-summary-container" class="hidden">
                             <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-medium text-gray-700">An√°lisis de Ruta por IA</h3>
                                <button id="get-ai-route-summary-btn" class="flex items-center justify-center bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors text-sm">
                                    ‚ú® Analizar Ruta
                                </button>
                            </div>
                            <div id="ai-route-summary-content" class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm text-gray-600 min-h-[100px] whitespace-pre-wrap"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido de Clientes -->
            <div id="clients-view" class="hidden">
                <div class="mb-4 flex flex-wrap gap-3">
                     <button id="add-client-btn" class="flex items-center justify-center bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                        Agregar Cliente
                    </button>
                    <button id="analyze-clients-btn" class="flex items-center justify-center bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                         ‚ú® Analizar Zona de Clientes
                    </button>
                </div>
                <!-- Barra de B√∫squeda y Filtros -->
                <div class="mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">
                        <!-- B√∫squeda por Nombre/Direcci√≥n -->
                        <div class="md:col-span-2 lg:col-span-2">
                            <label for="client-search-input" class="block text-sm font-medium text-gray-700">Buscar por Nombre o Direcci√≥n</label>
                            <input type="text" id="client-search-input" placeholder="Escriba para buscar..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <!-- Filtro por Compra Promedio -->
                        <div>
                            <label for="min-avg-purchase-input" class="block text-sm font-medium text-gray-700">Compra Prom. M√≠n.</label>
                            <input type="number" id="min-avg-purchase-input" placeholder="Desde $" min="0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="max-avg-purchase-input" class="block text-sm font-medium text-gray-700">Compra Prom. M√°x.</label>
                            <div class="flex items-center">
                                <input type="number" id="max-avg-purchase-input" placeholder="Hasta $" min="0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <button id="clear-client-filters-btn" class="mt-1 px-3 py-2 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md text-gray-600 hover:bg-gray-300">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                 <div id="client-analysis-container" class="mb-6 hidden">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">An√°lisis de Clientes por IA</h3>
                    <div id="client-analysis-content" class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm text-gray-600 min-h-[100px] whitespace-pre-wrap"></div>
                 </div>
                 <div class="grid grid-cols-1 lg:grid-cols-2 lg:gap-8">
                     <div class="flex flex-col">
                         <h3 class="text-lg font-medium text-gray-700 mb-2">Base de Datos de Clientes</h3>
                         <main class="bg-white rounded-xl shadow-lg overflow-hidden flex-grow">
                             <div id="clients-list-container" class="overflow-auto" style="height: 65vh;">
                                <div id="clients-empty-state" class="text-center p-12 hidden">
                                    <h3 class="mt-4 text-xl font-semibold text-gray-800">No hay clientes guardados</h3>
                                    <p class="mt-1 text-gray-500">Agrega un pedido o un cliente nuevo para empezar.</p>
                                </div>
                                <ul id="clients-list" class="divide-y divide-gray-200"></ul>
                            </div>
                         </main>
                     </div>
                     <div class="mt-8 lg:mt-0">
                         <h3 class="text-lg font-medium text-gray-700 mb-2">Mapa de Concentraci√≥n de Clientes</h3>
                         <div id="clients-map" class="shadow-lg"></div>
                     </div>
                 </div>
            </div>
            
            <!-- Contenido de An√°lisis -->
            <div id="analysis-view" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">An√°lisis de Rendimiento Global</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-semibold text-xl mb-4 text-gray-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-purple-600" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 00-2 0v4a1 1 0 102 0V9zm4 0a1 1 0 10-2 0v4a1 1 0 102 0V9zm2-2a1 1 0 100 2h.01a1 1 0 100-2H13z" clip-rule="evenodd" /></svg>
                                Ranking de Productos
                            </h3>
                            <div class="space-y-6">
                                <div>
                                    <h4 class="font-medium text-lg mb-3 text-gray-700">üèÜ Top 5 por Cantidad Vendida</h4>
                                    <div id="ranking-by-quantity" class="space-y-3"></div>
                                </div>
                                <div>
                                    <h4 class="font-medium text-lg mb-3 text-gray-700">üí∞ Top 5 por Ingresos Generados</h4>
                                    <div id="ranking-by-revenue" class="space-y-3"></div>
                                </div>
                            </div>
                        </div>
                         <div>
                            <h3 class="font-semibold text-xl mb-4 text-gray-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-teal-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                Ranking de Clientes
                            </h3>
                            <div class="space-y-6">
                                <div>
                                    <h4 class="font-medium text-lg mb-3 text-gray-700">‚≠ê Top 5 por Gasto Total</h4>
                                    <div id="ranking-clients-by-spent" class="space-y-3"></div>
                                </div>
                                <div>
                                    <h4 class="font-medium text-lg mb-3 text-gray-700">üõí Top 5 por N¬∞ de Compras</h4>
                                    <div id="ranking-clients-by-purchases" class="space-y-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <!-- MODALES -->
        <div id="order-modal" class="fixed inset-0 z-40 hidden items-center justify-center p-4 modal-backdrop">
             <div id="order-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-3xl transform transition-all opacity-0 -translate-y-10 max-h-[90vh] overflow-y-auto">
                <form id="order-form" class="p-6 sm:p-8">
                     <h2 id="order-modal-title" class="text-2xl font-bold text-gray-900 mb-6">Agregar Nuevo Pedido</h2>
                    <input type="hidden" id="order-id">
                    <div class="grid grid-cols-1 gap-x-6 gap-y-8">
                        <div class="space-y-5">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="pedidoIdInput" class="block text-sm font-medium text-gray-700">N¬∞ de Pedido</label><input type="text" id="pedidoIdInput" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: #1024" required></div>
                                <div><label for="clienteInput" class="block text-sm font-medium text-gray-700">Nombre del Cliente</label><input type="text" id="clienteInput" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: Ana P√©rez" required></div>
                            </div>
                             <div>
                                <label for="importeInput" class="block text-sm font-medium text-gray-700">Importe Total de la Compra</label>
                                <div class="relative mt-1">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">$</span></div>
                                    <input type="number" id="importeInput" class="block w-full rounded-md border-gray-300 pl-7 pr-12 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="0.00" step="0.01" min="0">
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="direccionInput" class="block text-sm font-medium text-gray-700">Direcci√≥n / Instrucciones de Env√≠o</label>
                                    <button type="button" id="improve-instructions-btn" class="text-sm text-indigo-600 font-semibold hover:text-indigo-800">‚ú® Mejorar Instrucciones</button>
                                </div>
                                <textarea id="direccionInput" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Calle Falsa 123, Springfield. Tocar timbre A." required></textarea>
                            </div>
                             <div>
                                <label for="productosInput" class="block text-sm font-medium text-gray-700">Productos y Cantidades</label>
                                <textarea id="productosInput" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Pegue aqu√≠ el pedido completo del cliente..."></textarea>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="estadoInput" class="block text-sm font-medium text-gray-700">Estado</label><select id="estadoInput" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"><option>Pendiente</option><option>En Preparaci√≥n</option><option>Enviado</option><option>Entregado</option></select></div>
                                 <div><label for="trackingInput" class="block text-sm font-medium text-gray-700">N¬∞ Seguimiento</label><input type="text" id="trackingInput" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Opcional"></div>
                            </div>
                             <div id="confirmation-message-container" class="hidden">
                                <div class="flex justify-between items-center">
                                    <label for="confirmationMessage" class="block text-sm font-medium text-gray-700">Mensaje de Confirmaci√≥n (Generado por IA)</label>
                                     <button type="button" id="copy-confirmation-btn" class="text-sm text-indigo-600 font-semibold hover:text-indigo-800">Copiar</button>
                                </div>
                                 <textarea id="confirmationMessage" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Marcar Ubicaci√≥n</label>
                             <div class="flex items-center gap-2 mb-2">
                                <p class="text-xs text-gray-500 flex-grow">Usa el campo 'Direcci√≥n' y 'Buscar' o haz clic en el mapa.</p>
                                <button type="button" id="search-address-btn" class="bg-indigo-100 text-indigo-700 font-semibold py-1 px-3 rounded-md hover:bg-indigo-200 text-sm whitespace-nowrap">Buscar</button>
                            </div>
                            <div id="modal-map"></div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-between items-center">
                        <button type="button" id="generate-confirmation-btn" class="flex items-center justify-center bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors text-sm">
                            ‚ú® Generar Mensaje de Confirmaci√≥n
                        </button>
                        <div class="flex space-x-3">
                            <button type="button" id="cancel-order-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancelar</button>
                            <button type="submit" id="save-order-btn" class="inline-flex justify-center py-2 px-4 border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Guardar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div id="client-modal" class="fixed inset-0 z-40 hidden items-center justify-center p-4 modal-backdrop">
             <div id="client-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all opacity-0 -translate-y-10 max-h-[90vh] overflow-y-auto">
                <form id="client-form" class="p-6 sm:p-8">
                     <input type="hidden" id="clientIdInput">
                     <h2 id="client-modal-title" class="text-2xl font-bold text-gray-900 mb-6">Agregar Nuevo Cliente</h2>
                     <div class="space-y-6">
                        <div>
                             <label for="clientNameInput" class="block text-sm font-medium text-gray-700">Nombre del Cliente</label>
                             <input type="text" id="clientNameInput" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label for="clientAddressInput" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                            <textarea id="clientAddressInput" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Marcar Ubicaci√≥n</label>
                             <div class="flex items-center gap-2 mb-2">
                                <p class="text-xs text-gray-500 flex-grow">Usa el campo 'Direcci√≥n' y 'Buscar' o haz clic en el mapa.</p>
                                <button type="button" id="search-client-address-btn" class="bg-indigo-100 text-indigo-700 font-semibold py-1 px-3 rounded-md hover:bg-indigo-200 text-sm whitespace-nowrap">Buscar</button>
                            </div>
                            <div id="client-modal-map"></div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="cancel-client-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Guardar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="start-point-modal" class="fixed inset-0 z-40 hidden items-center justify-center p-4 modal-backdrop">
            <div id="start-point-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all opacity-0 -translate-y-10">
                <div class="p-6 sm:p-8">
                     <h2 class="text-2xl font-bold text-gray-900 mb-6">Definir Punto de Partida</h2>
                     <div class="space-y-4">
                        <div>
                            <label for="start-address-input" class="block text-sm font-medium text-gray-700">Buscar Direcci√≥n de Inicio</label>
                            <div class="mt-1 flex gap-2">
                                <input type="text" id="start-address-input" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Mi oficina, Av. Principal 500">
                                <button type="button" id="search-start-address-btn" class="bg-blue-100 text-blue-700 font-semibold py-1 px-3 rounded-md hover:bg-blue-200 text-sm whitespace-nowrap">Buscar</button>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">O haz clic en el mapa para marcar la ubicaci√≥n.</p>
                            <div id="start-point-map" class="mt-2"></div>
                        </div>
                     </div>
                     <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="cancel-start-point-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="button" id="save-start-point-btn" class="inline-flex justify-center py-2 px-4 border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Guardar Inicio</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="add-purchase-modal" class="fixed inset-0 z-40 hidden items-center justify-center p-4 modal-backdrop">
            <div id="add-purchase-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all opacity-0 -translate-y-10 max-h-[90vh] overflow-y-auto">
                <form id="add-purchase-form" class="p-6 sm:p-8">
                    <h2 id="add-purchase-modal-title" class="text-2xl font-bold text-gray-900 mb-6">Agregar Compra</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="purchaseDateInput" class="block text-sm font-medium text-gray-700">Fecha de Compra</label>
                            <input type="date" id="purchaseDateInput" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="purchaseProductsInput" class="block text-sm font-medium text-gray-700">Productos y Cantidades</label>
                            <textarea id="purchaseProductsInput" rows="5" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Pegue aqu√≠ el pedido completo del cliente..."></textarea>
                            <p class="mt-1 text-xs text-gray-500">El importe total se calcular√° autom√°ticamente desde aqu√≠.</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="purchaseAmountInput" class="block text-sm font-medium text-gray-700">Importe Total</label>
                                <div class="relative mt-1">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">$</span></div>
                                    <input type="number" id="purchaseAmountInput" class="block w-full rounded-md border-gray-300 pl-7 pr-12 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-gray-50" placeholder="0.00" step="0.01" min="0">
                                </div>
                            </div>
                            <div>
                                <label for="purchaseAmountPaidInput" class="block text-sm font-medium text-gray-700">Importe Abonado</label>
                                <div class="relative mt-1">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">$</span></div>
                                    <input type="number" id="purchaseAmountPaidInput" class="block w-full rounded-md border-gray-300 pl-7 pr-12 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="0.00" step="0.01" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="cancel-add-purchase-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">Guardar Compra</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="purchase-history-modal" class="fixed inset-0 z-40 hidden items-center justify-center p-4 modal-backdrop">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all opacity-0 -translate-y-10 max-h-[90vh] flex flex-col">
                <h2 id="purchase-history-modal-title" class="text-2xl font-bold text-gray-900 p-6 border-b">Historial de Compras</h2>
                <div id="purchase-history-list-container" class="p-6 overflow-y-auto">
                    <!-- El contenido se generar√° din√°micamente -->
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end">
                    <button type="button" id="close-purchase-history-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cerrar</button>
                </div>
            </div>
        </div>
        <div id="edit-purchase-modal" class="fixed inset-0 z-40 hidden items-center justify-center p-4 modal-backdrop">
            <div id="edit-purchase-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all opacity-0 -translate-y-10 max-h-[90vh] overflow-y-auto">
                <form id="edit-purchase-form" class="p-6 sm:p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Editar Compra</h2>
                    <input type="hidden" id="editPurchaseId">
                    <div class="space-y-4">
                        <div>
                            <label for="editPurchaseDateInput" class="block text-sm font-medium text-gray-700">Fecha de Compra</label>
                            <input type="date" id="editPurchaseDateInput" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="editPurchaseProductsInput" class="block text-sm font-medium text-gray-700">Productos y Cantidades</label>
                            <textarea id="editPurchaseProductsInput" rows="5" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Formato: Cantidad x Nombre @ Precio Unitario"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="editPurchaseAmountInput" class="block text-sm font-medium text-gray-700">Importe Total</label>
                                <div class="relative mt-1">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">$</span></div>
                                    <input type="number" id="editPurchaseAmountInput" class="block w-full rounded-md border-gray-300 pl-7 pr-12 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-gray-50" placeholder="0.00" step="0.01" min="0">
                                </div>
                            </div>
                            <div>
                                <label for="editPurchaseAmountPaidInput" class="block text-sm font-medium text-gray-700">Importe Abonado</label>
                                <div class="relative mt-1">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">$</span></div>
                                    <input type="number" id="editPurchaseAmountPaidInput" class="block w-full rounded-md border-gray-300 pl-7 pr-12 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="0.00" step="0.01" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="cancel-edit-purchase-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Modal de Ranking de Productos por Cliente -->
        <div id="client-ranking-modal" class="fixed inset-0 z-40 hidden items-center justify-center p-4 modal-backdrop">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all opacity-0 -translate-y-10 max-h-[90vh] flex flex-col">
                <h2 id="client-ranking-modal-title" class="text-2xl font-bold text-gray-900 p-6 border-b">Ranking de Productos</h2>
                <div class="p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-semibold text-lg mb-3 text-gray-800">üèÜ Top por Cantidad Vendida</h3>
                        <ol id="client-ranking-by-quantity" class="list-decimal list-inside space-y-2"></ol>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-3 text-gray-800">üí∞ Top por Ingresos Generados</h3>
                        <ol id="client-ranking-by-revenue" class="list-decimal list-inside space-y-2"></ol>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end">
                    <button type="button" id="close-client-ranking-modal-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, updateDoc, deleteDoc, query, serverTimestamp, orderBy, where, getDocs, writeBatch, increment, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURACI√ìN ---
        const firebaseConfig = {
          apiKey: "AIzaSyAJbCC1pR-CQTpOXBicC59Jqm32Rr7q9M8",
          authDomain: "sistemafidelidad-super-21.firebaseapp.com",
          projectId: "sistemafidelidad-super-21",
          storageBucket: "sistemafidelidad-super-21.firebasestorage.app",
          messagingSenderId: "221163223090",
          appId: "1:221163223090:web:ffe60b7a75758d591c242b",
          measurementId: "G-79RSPJE5L8"
        };
        const Maps_API_KEY = "AIzaSyD9d0wzamU3rHdnfjVHeT0ZQWBz1-1bvd8"; 

        // --- VARIABLES GLOBALES ---
        let db, auth, mainMap, modalMap, startPointMap, clientsMap, clientModalMap, heatmap, geocoder;
        let modalMarker, startPointMarker, clientModalMarker, directionsService, directionsRenderer;
        let mainMapMarkers = [], clientMapMarkers = [];
        let infoWindow;
        let currentUserId = null, ordersUnsubscribe = null, clientsUnsubscribe = null;
        let allOrders = [], allClients = [];
        let modalLatLng = null, startPointLatLng = null, clientModalLatLng = null, startPoint = null;
        let activePurchaseContext = {}; // { clientId, purchaseId, oldPurchaseData }
        const appId = "gestor-envios-super21"; 

        const ui = {
            loginScreen: document.getElementById('login-screen'),
            loginForm: document.getElementById('login-form'),
            loginError: document.getElementById('login-error'),
            app: document.getElementById('app'),
            logoutBtn: document.getElementById('logout-btn'),
            userEmailDisplay: document.getElementById('user-email-display'),
            loadingOverlay: document.getElementById('loading-overlay'),
            initialLoadingScreen: document.getElementById('initial-loading-screen'), 
            appContent: document.getElementById('app-content'),
            orderList: document.getElementById('order-list'), 
            emptyState: document.getElementById('empty-state'),
            clientsList: document.getElementById('clients-list'), 
            clientsEmptyState: document.getElementById('clients-empty-state'),
            startPointDisplay: document.getElementById('start-point-display'),
            orderModal: document.getElementById('order-modal'), 
            orderModalContent: document.getElementById('order-modal-content'),
            orderForm: document.getElementById('order-form'), 
            orderModalTitle: document.getElementById('order-modal-title'),
            addOrderBtn: document.getElementById('add-order-btn'), 
            cancelOrderBtn: document.getElementById('cancel-order-btn'),
            saveOrderBtn: document.getElementById('save-order-btn'), 
            searchAddressBtn: document.getElementById('search-address-btn'),
            clientModal: document.getElementById('client-modal'), 
            clientModalContent: document.getElementById('client-modal-content'),
            clientForm: document.getElementById('client-form'), 
            addClientBtn: document.getElementById('add-client-btn'),
            cancelClientBtn: document.getElementById('cancel-client-btn'),
            searchClientAddressBtn: document.getElementById('search-client-address-btn'),
            analyzeClientsBtn: document.getElementById('analyze-clients-btn'),
            clientAnalysisContainer: document.getElementById('client-analysis-container'),
            clientAnalysisContent: document.getElementById('client-analysis-content'),
            improveInstructionsBtn: document.getElementById('improve-instructions-btn'),
            generateRouteBtn: document.getElementById('generate-route-btn'),
            routeItineraryContainer: document.getElementById('route-itinerary-container'),
            routeItineraryList: document.getElementById('route-itinerary-list'),
            aiSummaryContainer: document.getElementById('ai-summary-container'),
            getAiRouteSummaryBtn: document.getElementById('get-ai-route-summary-btn'),
            aiRouteSummaryContent: document.getElementById('ai-route-summary-content'),
            confirmationMessageContainer: document.getElementById('confirmation-message-container'),
            generateConfirmationBtn: document.getElementById('generate-confirmation-btn'),
            copyConfirmationBtn: document.getElementById('copy-confirmation-btn'),
            confirmationMessage: document.getElementById('confirmationMessage'),
            startPointModal: document.getElementById('start-point-modal'), 
            startPointModalContent: document.getElementById('start-point-modal-content'),
            setStartPointBtn: document.getElementById('set-start-point-btn'), 
            searchStartAddrBtn: document.getElementById('search-start-address-btn'),
            cancelStartPointBtn: document.getElementById('cancel-start-point-btn'), 
            saveStartPointBtn: document.getElementById('save-start-point-btn'),
            tabLogistics: document.getElementById('tab-logistics'), 
            tabClients: document.getElementById('tab-clients'),
            tabAnalysis: document.getElementById('tab-analysis'),
            logisticsView: document.getElementById('logistics-view'), 
            clientsView: document.getElementById('clients-view'),
            analysisView: document.getElementById('analysis-view'),
            addPurchaseModal: document.getElementById('add-purchase-modal'),
            addPurchaseForm: document.getElementById('add-purchase-form'),
            cancelAddPurchaseBtn: document.getElementById('cancel-add-purchase-btn'),
            purchaseHistoryModal: document.getElementById('purchase-history-modal'),
            purchaseHistoryListContainer: document.getElementById('purchase-history-list-container'),
            closePurchaseHistoryBtn: document.getElementById('close-purchase-history-btn'),
            editPurchaseModal: document.getElementById('edit-purchase-modal'),
            editPurchaseForm: document.getElementById('edit-purchase-form'),
            cancelEditPurchaseBtn: document.getElementById('cancel-edit-purchase-btn'),
            rankingByQuantity: document.getElementById('ranking-by-quantity'),
            rankingByRevenue: document.getElementById('ranking-by-revenue'),
            rankingClientsBySpent: document.getElementById('ranking-clients-by-spent'),
            rankingClientsByPurchases: document.getElementById('ranking-clients-by-purchases'),
            clientRankingModal: document.getElementById('client-ranking-modal'),
            clientRankingModalTitle: document.getElementById('client-ranking-modal-title'),
            clientRankingByQuantity: document.getElementById('client-ranking-by-quantity'),
            clientRankingByRevenue: document.getElementById('client-ranking-by-revenue'),
            closeClientRankingModalBtn: document.getElementById('close-client-ranking-modal-btn'),
            clientSearchInput: document.getElementById('client-search-input'),
            minAvgPurchaseInput: document.getElementById('min-avg-purchase-input'),
            maxAvgPurchaseInput: document.getElementById('max-avg-purchase-input'),
            clearClientFiltersBtn: document.getElementById('clear-client-filters-btn'),
        };
        
        // --- LLAMADA A LA API DE GEMINI ---
        async function callGemini(prompt, retries = 3, delay = 1000) {
            ui.loadingOverlay.classList.remove('hidden'); ui.loadingOverlay.classList.add('flex');
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                         ui.loadingOverlay.classList.add('hidden'); ui.loadingOverlay.classList.remove('flex');
                        return result.candidates[0].content.parts[0].text;
                    }
                    else throw new Error("Respuesta inv√°lida de la API de Gemini.");
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) { 
                        console.error('No se pudo obtener una respuesta de la IA.'); 
                        ui.loadingOverlay.classList.add('hidden'); ui.loadingOverlay.classList.remove('flex');
                        return null; 
                    }
                    await new Promise(res => setTimeout(res, delay)); delay *= 2;
                }
            }
        }
        
        // --- INICIALIZACI√ìN Y AUTENTICACI√ìN ---
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    ui.userEmailDisplay.textContent = user.email;
                    ui.loginScreen.classList.add('hidden');
                    ui.app.classList.remove('hidden');
                    if (!mainMap) {
                        runStartupChecks();
                    } else {
                        ui.initialLoadingScreen.classList.add('hidden');
                        ui.appContent.classList.remove('hidden');
                        listenToOrders();
                        listenToClients();
                    }
                } else {
                    currentUserId = null;
                    if (ordersUnsubscribe) ordersUnsubscribe();
                    if (clientsUnsubscribe) clientsUnsubscribe();
                    ui.loginScreen.classList.remove('hidden');
                    ui.app.classList.add('hidden');
                    ui.initialLoadingScreen.classList.remove('hidden');
                    ui.appContent.classList.add('hidden');
                }
            });
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = ui.loginForm['email-address'].value;
            const password = ui.loginForm.password.value;
            ui.loginError.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Error de inicio de sesi√≥n:", error.code);
                let errorMessage = "Error desconocido. Revisa la consola para m√°s detalles.";
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/invalid-email':
                        errorMessage = "No se encontr√≥ ning√∫n usuario con este correo electr√≥nico.";
                        break;
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        errorMessage = "La contrase√±a es incorrecta. Por favor, int√©ntalo de nuevo.";
                        break;
                    case 'auth/operation-not-allowed':
                         errorMessage = "El inicio de sesi√≥n por correo/contrase√±a no est√° habilitado en Firebase.";
                         break;
                }
                ui.loginError.textContent = errorMessage;
                ui.loginError.classList.remove('hidden');
            }
        }

        function handleLogout() {
            signOut(auth).catch(error => console.error("Error al cerrar sesi√≥n:", error));
        }

        function initializeGoogleMapsServices() {
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, polylineOptions: { strokeColor: '#4f46e5', strokeWeight: 5, strokeOpacity: 0.8 }});
            infoWindow = new google.maps.InfoWindow();
        }

        function initializeMaps() {
            const mapOptions = { center: { lat: -34.6037, lng: -58.3816 }, zoom: 12, mapTypeControl: false, streetViewControl: false };
            mainMap = new google.maps.Map(document.getElementById('main-map'), mapOptions);
            directionsRenderer.setMap(mainMap);
            clientsMap = new google.maps.Map(document.getElementById('clients-map'), mapOptions);
        }

        // --- L√ìGICA DE DATOS (FIRESTORE) ---
        function listenToOrders() {
             if (ordersUnsubscribe) ordersUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/pedidos`), orderBy("timestamp", "desc"));
            ordersUnsubscribe = onSnapshot(q, (querySnapshot) => {
                allOrders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrders();
                updateMainMapMarkers();
            }, (error) => console.error("Error al escuchar pedidos:", error));
        }
        function listenToClients() {
            if (clientsUnsubscribe) clientsUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/clients`));
            clientsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                allClients = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyAndRenderClientFilters();
                updateRankings();
            }, (error) => console.error("Error al escuchar clientes:", error));
        }
        
        async function updateProductStats(products, operation = 'add') {
            if (!products || products.length === 0) return;

            const batch = writeBatch(db);
            const multiplier = operation === 'add' ? 1 : -1;

            products.forEach(product => {
                const sanitizedName = product.name.trim().toLowerCase().replace(/\s+/g, '-');
                if (!sanitizedName) return;
                const productRef = doc(db, `artifacts/${appId}/users/${currentUserId}/products/${sanitizedName}`);
                
                batch.set(productRef, {
                    name: product.name.trim(),
                    totalQuantitySold: increment(product.quantity * multiplier),
                    totalRevenue: increment(product.quantity * product.price * multiplier)
                }, { merge: true });
            });

            await batch.commit();
            updateRankings(); // Actualizar rankings despu√©s de cambiar productos
        }

        async function findOrCreateClientForOrder(orderData) {
            const clientsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/clients`);
            const normalizedName = orderData.cliente.toLowerCase().replace(/\s+/g, ' ').trim();
            const q = query(clientsRef, where("normalizedName", "==", normalizedName));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                const newClientRef = await addDoc(clientsRef, {
                    cliente: orderData.cliente.trim(),
                    normalizedName: normalizedName,
                    direccion: orderData.direccion,
                    latitude: orderData.latitude,
                    longitude: orderData.longitude,
                    totalSpent: 0, 
                    purchaseCount: 0,
                    balance: 0, 
                    firstSeen: serverTimestamp()
                });
                return newClientRef.id;
            } else {
                const docRef = querySnapshot.docs[0].ref;
                const clientData = querySnapshot.docs[0].data();
                if (clientData.direccion !== orderData.direccion) {
                    await updateDoc(docRef, {
                        direccion: orderData.direccion,
                        latitude: orderData.latitude,
                        longitude: orderData.longitude,
                    });
                }
                return docRef.id;
            }
        }

        // --- C√ÅLCULO DE FRECUENCIA ---
        async function getClientPurchaseHistory(clientId) {
            const purchasesRef = collection(db, `artifacts/${appId}/users/${currentUserId}/clients/${clientId}/purchases`);
            const snapshot = await getDocs(query(purchasesRef, orderBy("date", "desc")));
            return snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        }

        function calculateFrequency(purchases) {
            if (!purchases || purchases.length < 2) {
                return null;
            }
            const dates = purchases.map(p => new Date(p.date).getTime()).sort((a, b) => a - b);
            const differences = [];
            for (let i = 1; i < dates.length; i++) {
                const diff = dates[i] - dates[i - 1];
                differences.push(diff);
            }
            if (differences.length === 0) return null;
            const avgMilliseconds = differences.reduce((sum, current) => sum + current, 0) / differences.length;
            const avgDays = Math.round(avgMilliseconds / (1000 * 60 * 60 * 24));
            return avgDays;
        }


        // --- RENDERIZADO Y UI ---
        const getStatusColors = (status) => {
            switch (status) {
                case 'Pendiente': return { bg: 'bg-yellow-100', text: 'text-yellow-800' };
                case 'En Preparaci√≥n': return { bg: 'bg-blue-100', text: 'text-blue-800' };
                case 'Enviado': return { bg: 'bg-green-100', text: 'text-green-800' };
                case 'Entregado': return { bg: 'bg-purple-100', text: 'text-purple-800' };
                default: return { bg: 'bg-gray-100', text: 'text-gray-800' };
            }
        };
        const getPaymentStatusColors = (status) => {
            switch (status) {
                case 'Pagado': return { bg: 'bg-green-100', text: 'text-green-800' };
                case 'Pago Parcial': return { bg: 'bg-yellow-100', text: 'text-yellow-800' };
                case 'Pendiente': return { bg: 'bg-red-100', text: 'text-red-800' };
                default: return { bg: 'bg-gray-100', text: 'text-gray-800' };
            }
        };
        function renderOrders() {
             ui.orderList.innerHTML = '';
            const hasOrders = allOrders.length > 0;
            ui.emptyState.classList.toggle('hidden', hasOrders);
            ui.orderList.closest('table').classList.toggle('hidden', !hasOrders);

            allOrders.forEach(order => {
                const colors = getStatusColors(order.estado);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td data-label="Detalle del Pedido" class="px-6 py-4 align-top">
                    <div class="text-sm font-semibold text-gray-900">${order.cliente}</div>
                    <div class="text-xs text-gray-500">${order.pedidoId || ''}</div>
                    <div class="text-xs font-bold text-green-600">${formatCurrency(order.importe)}</div>
                    <div class="text-xs text-gray-600 mt-1">${order.direccion}</div>
                    ${order.productos ? `<div class="mt-2 text-xs text-gray-700 bg-gray-50 p-2 rounded-md border border-gray-200 whitespace-pre-wrap">${order.productos}</div>` : ''}
                </td>
                <td data-label="Estado" class="px-6 py-4 align-top whitespace-nowrap"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${colors.bg} ${colors.text}">${order.estado}</span></td>
                <td data-label="Acciones" class="px-6 py-4 align-top whitespace-nowrap text-right text-sm font-medium"><div class="flex items-center space-x-2 justify-end"><button class="edit-btn text-indigo-600 hover:text-indigo-900" data-id="${order.id}">Editar</button><span class="text-gray-300">|</span><button class="delete-btn text-red-600 hover:text-red-900" data-id="${order.id}">Eliminar</button></div></td>`;
                ui.orderList.appendChild(tr);
            });
            addTableButtonListeners();
        }
        function renderClientsList(clientsToRender) {
            if (clientsToRender === undefined) {
                clientsToRender = allClients;
            }
            ui.clientsList.innerHTML = '';
            
            ui.clientsEmptyState.classList.toggle('hidden', allClients.length > 0);
            
            if (allClients.length > 0 && clientsToRender.length === 0) {
                ui.clientsList.innerHTML = `<li class="p-8 text-center text-gray-500">No se encontraron clientes que coincidan con los filtros.</li>`;
            } else {
                clientsToRender.forEach(async (client) => {
                    const avgPurchase = (client.purchaseCount > 0) ? (client.totalSpent || 0) / client.purchaseCount : 0;
                    
                    const purchases = await getClientPurchaseHistory(client.id);
                    const frequency = calculateFrequency(purchases);
                    const frequencyText = frequency !== null ? `Cada ${frequency} d√≠as (aprox)` : 'N/A';
                    const balance = client.balance || 0;
                    const balanceColor = balance > 0 ? 'text-red-600' : 'text-gray-600';

                    const li = document.createElement('li');
                    li.className = "p-4 hover:bg-gray-50";
                    li.innerHTML = `
                        <div class="flex items-center justify-between space-x-4">
                            <div class="flex-1 min-w-0 flex items-center space-x-4">
                                <div class="flex-shrink-0"><span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-indigo-100 text-indigo-700 font-bold">${client.cliente.charAt(0)}</span></div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${client.cliente}</p>
                                    <p class="text-sm text-gray-500 truncate">${client.direccion}</p>
                                    <div class="flex flex-wrap gap-x-4 text-sm">
                                        <p class="text-green-600 font-semibold truncate">Promedio: ${formatCurrency(avgPurchase)}</p>
                                        <p class="${balanceColor} font-semibold truncate">Saldo Deudor: ${formatCurrency(balance)}</p>
                                    </div>
                                    <p class="text-sm text-blue-600 font-semibold truncate">Frecuencia: ${frequencyText}</p>
                                </div>
                            </div>
                            <div class="flex-shrink-0 flex items-center space-x-1 sm:space-x-2 text-sm flex-wrap justify-end">
                                <button class="add-purchase-btn font-medium text-green-600 hover:text-green-900 p-1" data-id="${client.id}">+ Compra</button>
                                <button class="view-history-btn font-medium text-gray-600 hover:text-gray-900 p-1" data-id="${client.id}">Historial</button>
                                <button class="client-ranking-btn font-medium text-purple-600 hover:text-purple-900 p-1" data-id="${client.id}">Ranking</button>
                                <button class="edit-client-btn font-medium text-indigo-600 hover:text-indigo-900 p-1" data-id="${client.id}">Editar</button>
                                <button class="delete-client-btn font-medium text-red-600 hover:text-red-900 p-1" data-id="${client.id}">Eliminar</button>
                            </div>
                        </div>
                    `;
                    ui.clientsList.appendChild(li);
                });
            }
        }
        
        function renderClientMap(clientsToRender) {
             if (clientsToRender === undefined) {
                clientsToRender = allClients;
            }
             clientMapMarkers.forEach(marker => marker.setMap(null));
             clientMapMarkers = [];
             
             const points = clientsToRender.filter(c => c.latitude).map(client => new google.maps.LatLng(client.latitude, client.longitude));
             
            if (heatmap) {
                heatmap.setData(points);
            } else if (points.length > 0) {
                heatmap = new google.maps.visualization.HeatmapLayer({
                    data: points, map: clientsMap, radius: 30, opacity: 0.8
                });
            }

            clientsToRender.forEach(client => {
                if (!client.latitude) return;
                const avgPurchase = (client.purchaseCount > 0) ? (client.totalSpent || 0) / client.purchaseCount : 0;
                const position = new google.maps.LatLng(client.latitude, client.longitude);
                const marker = new google.maps.Marker({ position, map: clientsMap, title: client.cliente });
                
                marker.addListener('click', async () => { 
                    const purchases = await getClientPurchaseHistory(client.id);
                    const frequency = calculateFrequency(purchases);
                    const frequencyText = frequency !== null ? `Cada ${frequency} d√≠as (aprox)` : 'N/A';

                    const contentString = `
                        <div class="p-1">
                            <p class="font-bold">${client.cliente}</p>
                            <p>${client.direccion}</p>
                            <p class="font-semibold text-green-600">Promedio: ${formatCurrency(avgPurchase)}</p>
                            <p class="font-semibold text-blue-600">Frecuencia: ${frequencyText}</p>
                        </div>`;
                    infoWindow.setContent(contentString); 
                    infoWindow.open(clientsMap, marker); 
                });
                clientMapMarkers.push(marker);
            });
        }

        // --- L√ìGICA DE GOOGLE MAPS ---
        function clearRoute() {
            directionsRenderer.setMap(null);
            directionsRenderer.setDirections({routes: []});
            directionsRenderer.setMap(mainMap);
            ui.routeItineraryContainer.classList.add('hidden');
            ui.aiSummaryContainer.classList.add('hidden');
        }
        function clearMarkers() {
            mainMapMarkers.forEach(marker => marker.setMap(null));
            mainMapMarkers = [];
        }
        function updateMainMapMarkers() {
             clearMarkers();
            const bounds = new google.maps.LatLngBounds();
            
            if (startPoint) {
                const startMarker = new google.maps.Marker({
                    position: startPoint,
                    map: mainMap,
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#16a34a', fillOpacity: 1, strokeColor: 'white', strokeWeight: 2 },
                    title: 'Punto de Partida'
                });
                mainMapMarkers.push(startMarker);
                bounds.extend(startPoint);
            }

            allOrders.filter(order => order.estado === 'Pendiente' && order.latitude).forEach(order => {
                const position = new google.maps.LatLng(order.latitude, order.longitude);
                const marker = new google.maps.Marker({ position, map: mainMap, title: order.cliente });
                marker.addListener('click', () => { infoWindow.setContent(`<strong>${order.cliente}</strong><br>${order.direccion}`); infoWindow.open(mainMap, marker); });
                mainMapMarkers.push(marker);
                bounds.extend(position);
            });
            
            if (mainMapMarkers.length > 0) mainMap.fitBounds(bounds);
        }
        function generateRoute() {
            clearRoute();
            const pendingOrders = allOrders.filter(order => order.estado === 'Pendiente' && order.latitude);
            if (pendingOrders.length < 1) { 
                alert("No hay pedidos pendientes con ubicaci√≥n para generar una ruta.");
                return;
            }
            if (!startPoint) { 
                alert("Por favor, define un punto de partida.");
                return; 
            }

            const waypoints = pendingOrders.map(order => ({ location: new google.maps.LatLng(order.latitude, order.longitude), stopover: true }));
            const request = {
                origin: startPoint,
                destination: startPoint,
                waypoints: waypoints,
                optimizeWaypoints: true,
                travelMode: google.maps.TravelMode.DRIVING
            };
            
            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    displayItinerary(result, pendingOrders);
                } else { 
                    console.error('Directions request failed due to ' + status);
                    alert('Error al generar la ruta: ' + status);
                }
            });
        }
        function displayItinerary(result, pendingOrders) {
            ui.routeItineraryList.innerHTML = '';
            ui.routeItineraryContainer.classList.remove('hidden');
            ui.aiSummaryContainer.classList.remove('hidden');
            ui.aiRouteSummaryContent.textContent = 'Haz clic en "Analizar Ruta" para obtener consejos de la IA.';

            const route = result.routes[0];
            const optimizedOrder = route.waypoint_order;

            const startLi = document.createElement('li');
            startLi.className = "flex items-start";
            startLi.innerHTML = `<div class="flex-shrink-0"><span class="flex items-center justify-center h-6 w-6 rounded-full bg-green-500 text-white font-bold text-xs">INICIO</span></div><p class="ml-3 font-semibold text-gray-700">Punto de Partida</p>`;
            ui.routeItineraryList.appendChild(startLi);

            optimizedOrder.forEach((waypointIndex, i) => {
                const order = pendingOrders[waypointIndex];
                const li = document.createElement('li');
                li.className = "flex items-start";
                const markerLabel = String.fromCharCode(65 + i);
                li.innerHTML = `
                    <div class="flex-shrink-0"><span class="flex items-center justify-center h-6 w-6 rounded-full bg-gray-700 text-white font-bold text-xs">${markerLabel}</span></div>
                    <div class="ml-3">
                        <p class="font-semibold text-gray-800">${order.cliente}</p>
                        <p class="text-gray-500">${order.direccion}</p>
                    </div>`;
                ui.routeItineraryList.appendChild(li);
            });
        }
        function geocodeSearch(address, map, successCallback, failureCallback = null) {
             if (!address) return;
             geocoder.geocode({ 'address': address }, (results, status) => {
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                    map.setZoom(16);
                    successCallback(results[0].geometry.location);
                } else { 
                    if (failureCallback) failureCallback();
                    else alert('La direcci√≥n no fue encontrada por el siguiente motivo: ' + status);
                    console.error('Geocode was not successful for the following reason: ' + status);
                 }
             });
        }
        
        // --- FUNCIONES DE IA ---
        async function handleAnalyzeRoute() {
            const currentRoute = directionsRenderer.getDirections()?.routes[0];
            if (!currentRoute) { alert("Primero genera una ruta."); return; }
            const addresses = currentRoute.legs.map(leg => leg.end_address).join('; ');
            const prompt = `Como experto en log√≠stica, analiza la siguiente ruta de entrega en una ciudad: ${addresses}. Proporciona un resumen conciso y 3 consejos pr√°cticos para optimizar el reparto, considerando posibles demoras por tr√°fico, tipo de zona (residencial/comercial) o secuencia de paradas.`;
            const summary = await callGemini(prompt);
            ui.aiRouteSummaryContent.textContent = summary || "No se pudo generar el an√°lisis de la ruta.";
        }

        async function handleImproveInstructions() {
            const client = ui.orderForm.clienteInput.value;
            const address = ui.orderForm.direccionInput.value;
            if (!client || !address) { alert("Ingresa el nombre del cliente y la direcci√≥n primero."); return; }
            const prompt = `Act√∫a como un asistente de env√≠os. Mejora y clarifica las siguientes instrucciones de entrega para un repartidor. Aseg√∫rate de que sean cortas, claras y directas.\nCliente: ${client}\nDirecci√≥n: ${address}`;
            const improvedAddress = await callGemini(prompt);
            if (improvedAddress) ui.orderForm.direccionInput.value = improvedAddress;
        }
        
        async function handleGenerateConfirmation() {
            const client = ui.orderForm.clienteInput.value;
            const orderId = ui.orderForm.pedidoIdInput.value;
            const products = ui.orderForm.productosInput.value;
            if (!client || !products) { alert("Ingresa el nombre del cliente y los productos primero."); return; }
            const prompt = `Genera un mensaje de confirmaci√≥n de pedido corto y amigable para WhatsApp. Debe incluir el nombre del cliente, el ID del pedido (si existe) y un resumen de los productos.\nCliente: ${client}\nID Pedido: ${orderId}\nProductos:\n${products}`;
            const message = await callGemini(prompt);
            if(message) {
                ui.confirmationMessage.value = message;
                ui.confirmationMessageContainer.classList.remove('hidden');
            }
        }

        async function handleAnalyzeClients() {
            if (allClients.length === 0) { alert("No hay clientes para analizar."); return; }
            const addressList = allClients.map(c => c.direccion).join('\n');
            const prompt = `Como analista de negocios, examina la siguiente lista de direcciones de clientes. Identifica patrones, como barrios o zonas de alta concentraci√≥n. Basado en esto, proporciona un breve an√°lisis de mercado y 2 sugerencias de marketing para este negocio.\n\nDirecciones:\n${addressList}`;
            const analysis = await callGemini(prompt);
            if (analysis) {
                ui.clientAnalysisContent.textContent = analysis;
                ui.clientAnalysisContainer.classList.remove('hidden');
            }
        }
        
        // --- L√ìGICA DE MODALES ---
        function setupModalMap(mapContainerId, clickCallback) {
            const mapOptions = { center: { lat: -34.6037, lng: -58.3816 }, zoom: 12, mapTypeControl: false, streetViewControl: false };
            const map = new google.maps.Map(document.getElementById(mapContainerId), mapOptions);
            map.addListener('click', (e) => clickCallback(e.latLng));
            return map;
        }
        
        function toggleOrderModal(show) {
            if (show) {
                ui.confirmationMessageContainer.classList.add('hidden');
                ui.confirmationMessage.value = '';
                ui.orderModal.classList.remove('hidden'); ui.orderModal.classList.add('flex');
                setTimeout(() => {
                    ui.orderModalContent.classList.remove('opacity-0', '-translate-y-10');
                    if (!modalMap) modalMap = setupModalMap('modal-map', (latLng) => updateModalMarker(latLng));
                    google.maps.event.trigger(modalMap, 'resize');
                }, 10);
            } else {
                ui.orderModalContent.classList.add('opacity-0', '-translate-y-10');
                setTimeout(() => ui.orderModal.classList.add('hidden'), 300);
            }
        }
        function updateModalMarker(latLng) {
            modalLatLng = latLng;
            if (modalMarker) modalMarker.setPosition(latLng); else modalMarker = new google.maps.Marker({ position: latLng, map: modalMap });
        }
        async function handleSaveOrder(e) {
            e.preventDefault();
            const orderDocId = document.getElementById('order-id').value;
            const productsText = document.getElementById('productosInput').value;
            const { products } = parseProductsInput(productsText);
            
            const importeFinal = parseFloat(document.getElementById('importeInput').value) || 0;

            const data = {
                pedidoId: document.getElementById('pedidoIdInput').value, 
                cliente: document.getElementById('clienteInput').value,
                direccion: document.getElementById('direccionInput').value, 
                productos: formatProductsToText(products),
                estado: document.getElementById('estadoInput').value, 
                tracking: document.getElementById('trackingInput').value,
                importe: importeFinal
            };
            if(modalLatLng) { 
                data.latitude = modalLatLng.lat(); 
                data.longitude = modalLatLng.lng(); 
            }
            try {
                let savedOrderId = orderDocId;
                if (orderDocId) {
                    await updateDoc(doc(db,`artifacts/${appId}/users/${currentUserId}/pedidos`,orderDocId), data);
                } else { 
                    data.timestamp = serverTimestamp(); 
                    const newOrderRef = await addDoc(collection(db,`artifacts/${appId}/users/${currentUserId}/pedidos`), data); 
                    savedOrderId = newOrderRef.id;
                }
                
                if (data.latitude && data.importe > 0) {
                    const clientId = await findOrCreateClientForOrder(data);
                    await logPurchase(clientId, data.importe, new Date().toISOString().split('T')[0], 'order', products, 0, savedOrderId);
                }
                
                toggleOrderModal(false);
            } catch (error) { console.error("Error al guardar:", error); alert("Error al guardar el pedido.");}
        }
        function openModalInMode(mode, docId = null) {
            ui.orderForm.reset();
            if (modalMarker) modalMarker.setMap(null);
            modalMarker = null;
            modalLatLng = null;

            if (mode === 'add') {
                ui.orderModalTitle.textContent = 'Agregar Nuevo Pedido';
                document.getElementById('order-id').value = '';
                toggleOrderModal(true);
            } else if (mode === 'edit' && docId) {
                ui.orderModalTitle.textContent = 'Editar Pedido';
                const order = allOrders.find(o => o.id === docId);
                if (order) {
                    document.getElementById('order-id').value = order.id;
                    document.getElementById('pedidoIdInput').value = order.pedidoId || '';
                    document.getElementById('clienteInput').value = order.cliente || '';
                    document.getElementById('importeInput').value = order.importe || '';
                    document.getElementById('direccionInput').value = order.direccion || '';
                    document.getElementById('productosInput').value = order.productos || '';
                    document.getElementById('estadoInput').value = order.estado || 'Pendiente';
                    document.getElementById('trackingInput').value = order.tracking || '';
                    if (order.latitude) {
                        modalLatLng = new google.maps.LatLng(order.latitude, order.longitude);
                    }
                    toggleOrderModal(true);
                    if (modalLatLng) {
                        setTimeout(() => {
                           modalMap.setCenter(modalLatLng);
                           modalMap.setZoom(16);
                           updateModalMarker(modalLatLng);
                        }, 200);
                    }
                }
            }
        }
        async function handleDelete(docId) {
            // Note: Deleting an order does not automatically reverse the purchase stats. This could be a future enhancement.
            if (confirm('¬øEst√°s seguro de que quieres eliminar este pedido?')) {
                try { 
                    await deleteDoc(doc(db,`artifacts/${appId}/users/${currentUserId}/pedidos`,docId));
                } catch(e) { 
                    console.error(e);
                    alert("Error al eliminar el pedido.");
                }
            }
        }
        
        function toggleClientModal(show) {
             if (show) {
                ui.clientModal.classList.remove('hidden'); ui.clientModal.classList.add('flex');
                setTimeout(() => {
                    ui.clientModalContent.classList.remove('opacity-0', '-translate-y-10');
                    if (!clientModalMap) clientModalMap = setupModalMap('client-modal-map', (latLng) => updateClientModalMarker(latLng));
                    google.maps.event.trigger(clientModalMap, 'resize');
                }, 10);
            } else {
                ui.clientModalContent.classList.add('opacity-0', '-translate-y-10');
                setTimeout(() => ui.clientModal.classList.add('hidden'), 300);
            }
        }
        function updateClientModalMarker(latLng) {
            clientModalLatLng = latLng;
            if (clientModalMarker) clientModalMarker.setPosition(latLng); 
            else clientModalMarker = new google.maps.Marker({ position: latLng, map: clientModalMap });
        }
        async function handleSaveClient(e) {
            e.preventDefault();
            const clientId = document.getElementById('clientIdInput').value;
            const clientName = document.getElementById('clientNameInput').value.trim();
            const clientAddress = document.getElementById('clientAddressInput').value.trim();

            if(!clientName || !clientAddress) { 
                alert("Nombre y direcci√≥n son requeridos."); 
                return;
            }

            const normalizedName = clientName.toLowerCase().replace(/\s+/g, ' ').trim();
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/clients`), where("normalizedName", "==", normalizedName));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const existingClient = querySnapshot.docs[0];
                if (!clientId || (clientId && existingClient.id !== clientId)) {
                    alert(`Error: Ya existe un cliente con el nombre "${clientName}".`);
                    return;
                }
            }

            const saveData = async (location) => {
                const data = {
                    cliente: clientName,
                    normalizedName: normalizedName,
                    direccion: clientAddress,
                    latitude: location.lat(),
                    longitude: location.lng(),
                };
                try {
                    if (clientId) {
                        await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/clients`, clientId), data);
                    } else {
                        data.firstSeen = serverTimestamp();
                        data.totalSpent = 0;
                        data.purchaseCount = 0;
                        data.balance = 0;
                        await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/clients`), data);
                    }
                    toggleClientModal(false);
                } catch (error) {
                    console.error("Error al guardar cliente:", error);
                    alert("Error al guardar el cliente.");
                }
            };

            if (clientModalLatLng) {
                await saveData(clientModalLatLng);
            } else {
                geocodeSearch(clientAddress, clientModalMap, (location) => {
                    updateClientModalMarker(location);
                    saveData(location);
                }, () => {
                    alert('No se pudo encontrar la direcci√≥n. Por favor, m√°rcala manualmente en el mapa y haz clic en Guardar.');
                });
            }
        }
        function openClientModalInMode(mode, docId = null) {
            ui.clientForm.reset();
            document.getElementById('clientIdInput').value = '';
            if (clientModalMarker) clientModalMarker.setMap(null);
            clientModalMarker = null;
            clientModalLatLng = null;

            if (mode === 'add') {
                document.getElementById('client-modal-title').textContent = 'Agregar Nuevo Cliente';
                toggleClientModal(true);
            } else if (mode === 'edit' && docId) {
                document.getElementById('client-modal-title').textContent = 'Editar Cliente';
                const client = allClients.find(c => c.id === docId);
                if (client) {
                    document.getElementById('clientIdInput').value = client.id;
                    document.getElementById('clientNameInput').value = client.cliente;
                    document.getElementById('clientAddressInput').value = client.direccion;
                    if (client.latitude && client.longitude) {
                        clientModalLatLng = new google.maps.LatLng(client.latitude, client.longitude);
                    }
                    toggleClientModal(true);
                    if (clientModalLatLng) {
                         setTimeout(() => {
                           clientModalMap.setCenter(clientModalLatLng);
                           clientModalMap.setZoom(16);
                           updateClientModalMarker(clientModalLatLng);
                        }, 200);
                    }
                }
            }
        }
        async function handleDeleteClient(docId) {
            const clientToDelete = allClients.find(c => c.id === docId);
            if (!clientToDelete) return;

            if (confirm(`¬øEst√°s seguro de que quieres eliminar a ${clientToDelete.cliente}? Esta acci√≥n tambi√©n eliminar√° su historial de compras y afectar√° las estad√≠sticas de productos.`)) {
                try {
                    await runTransaction(db, async (transaction) => {
                        const clientRef = doc(db, `artifacts/${appId}/users/${currentUserId}/clients`, docId);
                        
                        // Revertir estad√≠sticas de productos de todas las compras de este cliente
                        const purchasesRef = collection(clientRef, "purchases");
                        const purchasesSnapshot = await getDocs(query(purchasesRef));

                        for (const purchaseDoc of purchasesSnapshot.docs) {
                            const purchaseData = purchaseDoc.data();
                            if (purchaseData.products && purchaseData.products.length > 0) {
                                purchaseData.products.forEach(product => {
                                    const sanitizedName = product.name.trim().toLowerCase().replace(/\s+/g, '-');
                                    if (!sanitizedName) return;
                                    const productRef = doc(db, `artifacts/${appId}/users/${currentUserId}/products/${sanitizedName}`);
                                    transaction.set(productRef, {
                                        totalQuantitySold: increment(-product.quantity),
                                        totalRevenue: increment(-(product.quantity * product.price))
                                    }, { merge: true });
                                });
                            }
                            // Eliminar el documento de la compra
                            transaction.delete(purchaseDoc.ref);
                        }
                        
                        // Finalmente, eliminar el cliente
                        transaction.delete(clientRef);
                    });
                    console.log("Cliente y sus datos asociados eliminados correctamente.");
                } catch(e) { 
                    console.error("Error al eliminar el cliente y sus datos:", e);
                    alert("Error al eliminar el cliente.");
                }
            }
        }

        function toggleStartPointModal(show) {
            if (show) {
                ui.startPointModal.classList.remove('hidden'); ui.startPointModal.classList.add('flex');
                setTimeout(() => {
                    ui.startPointModalContent.classList.remove('opacity-0', '-translate-y-10');
                    if (!startPointMap) startPointMap = setupModalMap('start-point-map', (latLng) => updateStartPointMarker(latLng));
                    google.maps.event.trigger(startPointMap, 'resize');
                    if (startPointLatLng) {
                        startPointMap.setCenter(startPointLatLng);
                        startPointMap.setZoom(16);
                        updateStartPointMarker(startPointLatLng);
                    }
                }, 10);
            } else {
                ui.startPointModalContent.classList.add('opacity-0', '-translate-y-10');
                setTimeout(() => ui.startPointModal.classList.add('hidden'), 300);
            }
        }
        function updateStartPointMarker(latLng) {
            startPointLatLng = latLng;
            if (startPointMarker) startPointMarker.setPosition(latLng);
            else startPointMarker = new google.maps.Marker({ position: latLng, map: startPointMap });
        }
        async function handleSaveStartPoint() {
            if (!startPointLatLng) { alert("Marca un punto de partida en el mapa."); return; }
            startPoint = { lat: startPointLatLng.lat(), lng: startPointLatLng.lng() };
            geocoder.geocode({ 'location': startPoint }, (results, status) => {
                ui.startPointDisplay.textContent = (status === 'OK' && results[0]) ? results[0].formatted_address : `Lat: ${startPoint.lat.toFixed(4)}, Lng: ${startPoint.lng.toFixed(4)}`;
            });
            updateMainMapMarkers();
            toggleStartPointModal(false);
        }

        // --- MANEJADORES DE EVENTOS ---
        function addTableButtonListeners() {
            document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', (e) => openModalInMode('edit', e.currentTarget.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', (e) => handleDelete(e.currentTarget.dataset.id)));
        }
        function openAddPurchaseModal(clientId) {
            const client = allClients.find(c => c.id === clientId);
            if (!client) return;

            activePurchaseContext.clientId = clientId;
            document.getElementById('add-purchase-modal-title').textContent = `Agregar Compra a ${client.cliente}`;
            ui.addPurchaseForm.reset();
            document.getElementById('purchaseDateInput').value = new Date().toISOString().slice(0, 10);
            
            ui.addPurchaseModal.classList.remove('hidden');
            ui.addPurchaseModal.classList.add('flex');
            setTimeout(() => {
                ui.addPurchaseModal.querySelector('#add-purchase-modal-content').classList.remove('opacity-0', '-translate-y-10');
            }, 10);
        }
        function closeAddPurchaseModal() {
            const modal = document.getElementById('add-purchase-modal');
            modal.querySelector('#add-purchase-modal-content').classList.add('opacity-0', '-translate-y-10');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        async function handleSavePurchase(e) {
            e.preventDefault();
            
            const date = document.getElementById('purchaseDateInput').value;
            const productsText = document.getElementById('purchaseProductsInput').value;
            const amountPaid = parseFloat(document.getElementById('purchaseAmountPaidInput').value) || 0;
            const { products } = parseProductsInput(productsText);
            const totalAmount = parseFloat(document.getElementById('purchaseAmountInput').value) || 0;
            
            if (totalAmount <= 0 || !date) {
                alert("Por favor, ingresa una fecha y un importe total v√°lido.");
                return;
            }
            
            await logPurchase(activePurchaseContext.clientId, totalAmount, date, 'manual', products, amountPaid);
            closeAddPurchaseModal();
        }

        async function logPurchase(clientId, amount, date, type, products = [], amountPaid = amount, sourceId = null) {
            if (!clientId || !amount || !date || !type) return;

            const batch = writeBatch(db);
            const clientRef = doc(db, `artifacts/${appId}/users/${currentUserId}/clients/${clientId}`);
            const purchasesRef = collection(clientRef, "purchases");

            const balanceDifference = amount - amountPaid;
            let status = 'Pendiente';
            if (balanceDifference <= 0) {
                status = 'Pagado';
            } else if (amountPaid > 0) {
                status = 'Pago Parcial';
            }

            const newPurchaseRef = doc(purchasesRef);
            const purchaseData = {
                amount: amount,
                amountPaid: amountPaid,
                date: date,
                type: type, 
                status: status,
                createdAt: serverTimestamp()
            };
            if (products.length > 0) {
                purchaseData.products = products;
            }
            if (type === 'order' && sourceId) {
                purchaseData.orderId = sourceId;
            }
            batch.set(newPurchaseRef, purchaseData);

            batch.update(clientRef, {
                totalSpent: increment(amount),
                purchaseCount: increment(1),
                balance: increment(balanceDifference)
            });
            
            await batch.commit();
            await updateProductStats(products, 'add');
        }

        async function openPurchaseHistoryModal(clientId) {
            const client = allClients.find(c => c.id === clientId);
            if (!client) return;
            activePurchaseContext.clientId = clientId;
            document.getElementById('purchase-history-modal-title').textContent = `Historial de ${client.cliente}`;
            
            const purchases = await getClientPurchaseHistory(clientId);
            renderPurchaseHistory(purchases);

            const modal = ui.purchaseHistoryModal;
            modal.classList.remove('hidden'); modal.classList.add('flex');
            setTimeout(() => {
                modal.querySelector('.bg-white').classList.remove('opacity-0', '-translate-y-10');
            }, 10);
        }

        function renderPurchaseHistory(purchases) {
             const container = ui.purchaseHistoryListContainer;
             container.innerHTML = '';
             if(purchases.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">No hay compras registradas.</p>`;
                return;
             }

             const list = document.createElement('ul');
             list.className = "divide-y divide-gray-200";
             
             purchases.forEach(p => {
                const li = document.createElement('li');
                li.className = "py-4";
                const productsHtml = p.products ? p.products.map(prod => 
                    `<li class="text-xs text-gray-600 ml-4">${prod.quantity} x ${prod.name} (${formatCurrency(prod.price)})</li>`
                ).join('') : '';
                const paymentStatus = p.status || 'N/A';
                const colors = getPaymentStatusColors(paymentStatus);

                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-3">
                                <p class="text-sm text-gray-800 font-medium">${p.date}</p>
                                <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${colors.bg} ${colors.text}">${paymentStatus}</span>
                            </div>
                            <p class="text-lg font-bold text-green-600">${formatCurrency(p.amount)}</p>
                            <p class="text-sm font-medium text-gray-700">Abonado: ${formatCurrency(p.amountPaid)}</p>
                            ${p.products ? `<ul class="mt-2 list-disc list-inside">${productsHtml}</ul>` : ''}
                        </div>
                        <div class="flex-shrink-0 flex items-center space-x-2">
                            <button data-id="${p.id}" class="edit-purchase-btn text-indigo-600 hover:text-indigo-900 p-1">Editar</button>
                            <button data-id="${p.id}" class="delete-purchase-btn text-red-600 hover:text-red-900 p-1">Eliminar</button>
                        </div>
                    </div>
                `;
                list.appendChild(li);
             });
             container.appendChild(list);

             container.querySelectorAll('.edit-purchase-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const purchase = purchases.find(p => p.id === btn.dataset.id);
                    openEditPurchaseModal(purchase);
                });
             });
             container.querySelectorAll('.delete-purchase-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const purchase = purchases.find(p => p.id === btn.dataset.id);
                    handleDeletePurchase(purchase);
                });
             });
        }
        
        function closePurchaseHistoryModal() {
            const modal = ui.purchaseHistoryModal;
            modal.querySelector('.bg-white').classList.add('opacity-0', '-translate-y-10');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function openEditPurchaseModal(purchase) {
             activePurchaseContext.purchaseId = purchase.id;
             activePurchaseContext.oldPurchaseData = purchase;

             document.getElementById('editPurchaseId').value = purchase.id;
             document.getElementById('editPurchaseDateInput').value = purchase.date;
             document.getElementById('editPurchaseProductsInput').value = formatProductsToText(purchase.products);
             document.getElementById('editPurchaseAmountInput').value = purchase.amount.toFixed(2);
             document.getElementById('editPurchaseAmountPaidInput').value = purchase.amountPaid.toFixed(2);
             
             const modal = ui.editPurchaseModal;
             modal.classList.remove('hidden'); modal.classList.add('flex');
             setTimeout(() => {
                modal.querySelector('#edit-purchase-modal-content').classList.remove('opacity-0', '-translate-y-10');
            }, 10);
        }
        function closeEditPurchaseModal() {
            const modal = ui.editPurchaseModal;
            modal.querySelector('#edit-purchase-modal-content').classList.add('opacity-0', '-translate-y-10');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        async function handleUpdatePurchase(e) {
            e.preventDefault();
            const { clientId, purchaseId, oldPurchaseData } = activePurchaseContext;
            const newDate = document.getElementById('editPurchaseDateInput').value;
            const newProductsText = document.getElementById('editPurchaseProductsInput').value;
            const newAmountPaid = parseFloat(document.getElementById('editPurchaseAmountPaidInput').value) || 0;
            const { products: newProducts, totalAmount: newAmount } = parseProductsInput(newProductsText);

            if (newProducts.length === 0 || newAmount <= 0 || !newDate) {
                 alert("Por favor, ingresa un importe y fecha v√°lidos.");
                return;
            }

            try {
                await runTransaction(db, async (transaction) => {
                    const clientRef = doc(db, `artifacts/${appId}/users/${currentUserId}/clients/${clientId}`);
                    const purchaseRef = doc(clientRef, "purchases", purchaseId);

                    // Calcular el nuevo estado de pago
                    const newBalanceDifference = newAmount - newAmountPaid;
                    let newStatus = 'Pendiente';
                    if (newBalanceDifference <= 0) newStatus = 'Pagado';
                    else if (newAmountPaid > 0) newStatus = 'Pago Parcial';

                    // 1. Actualizar el documento de compra
                    transaction.update(purchaseRef, { 
                        date: newDate, 
                        products: newProducts, 
                        amount: newAmount, 
                        amountPaid: newAmountPaid,
                        status: newStatus
                    });

                    // 2. Ajustar las estad√≠sticas del cliente
                    const amountDifference = newAmount - oldPurchaseData.amount;
                    const oldBalanceDifference = oldPurchaseData.amount - (oldPurchaseData.amountPaid || 0);
                    const balanceAdjustment = newBalanceDifference - oldBalanceDifference;
                    
                    transaction.update(clientRef, { 
                        totalSpent: increment(amountDifference),
                        balance: increment(balanceAdjustment)
                    });
                    
                    // 3. Revertir estad√≠sticas de productos antiguos
                    if (oldPurchaseData.products) {
                        oldPurchaseData.products.forEach(product => {
                            const sanitizedName = product.name.trim().toLowerCase().replace(/\s+/g, '-');
                            const productRef = doc(db, `artifacts/${appId}/users/${currentUserId}/products/${sanitizedName}`);
                            transaction.set(productRef, {
                                totalQuantitySold: increment(-product.quantity),
                                totalRevenue: increment(-(product.quantity * product.price))
                            }, { merge: true });
                        });
                    }
                    
                    // 4. Aplicar estad√≠sticas de nuevos productos
                    newProducts.forEach(product => {
                        const sanitizedName = product.name.trim().toLowerCase().replace(/\s+/g, '-');
                        const productRef = doc(db, `artifacts/${appId}/users/${currentUserId}/products/${sanitizedName}`);
                        transaction.set(productRef, {
                            name: product.name.trim(),
                            totalQuantitySold: increment(product.quantity),
                            totalRevenue: increment(product.quantity * product.price)
                        }, { merge: true });
                    });
                });
                
                closeEditPurchaseModal();
                await openPurchaseHistoryModal(clientId); // Refresh history
                await updateRankings();
            } catch (error) {
                console.error("Error al actualizar la compra:", error);
                alert("Error al guardar los cambios.");
            }
        }
        async function handleDeletePurchase(purchase) {
            if (!purchase) return;
            if (confirm(`¬øSeguro que quieres eliminar la compra del ${purchase.date} por ${formatCurrency(purchase.amount)}?`)) {
                 const { clientId } = activePurchaseContext;
                 const clientRef = doc(db, `artifacts/${appId}/users/${currentUserId}/clients/${clientId}`);
                 const purchaseRef = doc(clientRef, "purchases", purchase.id);

                 const balanceToRevert = purchase.amount - (purchase.amountPaid || 0);

                 const batch = writeBatch(db);
                 // 1. Eliminar el documento de la compra
                 batch.delete(purchaseRef);

                 // 2. Ajustar las estad√≠sticas en el documento del cliente
                 batch.update(clientRef, {
                    totalSpent: increment(-purchase.amount),
                    purchaseCount: increment(-1),
                    balance: increment(-balanceToRevert)
                 });
                 
                 try {
                    await batch.commit();
                    await updateProductStats(purchase.products, 'subtract');
                    await openPurchaseHistoryModal(clientId); // Refresh
                 } catch (error) {
                    console.error("Error al eliminar compra:", error);
                    alert("No se pudo eliminar la compra.");
                 }
            }
        }

        function setupEventListeners() {
            ui.loginForm.addEventListener('submit', handleLogin);
            ui.logoutBtn.addEventListener('click', handleLogout);
            ui.addOrderBtn.addEventListener('click', () => openModalInMode('add'));
            ui.cancelOrderBtn.addEventListener('click', () => toggleOrderModal(false));
            ui.orderModal.addEventListener('click', (e) => { if (e.target === ui.orderModal) toggleOrderModal(false); });
            ui.orderForm.addEventListener('submit', handleSaveOrder);
            ui.searchAddressBtn.addEventListener('click', () => geocodeSearch(document.getElementById('direccionInput').value, modalMap, updateModalMarker));

            ui.addClientBtn.addEventListener('click', () => openClientModalInMode('add'));
            ui.cancelClientBtn.addEventListener('click', () => toggleClientModal(false));
            ui.clientModal.addEventListener('click', (e) => { if (e.target === ui.clientModal) toggleClientModal(false); });
            ui.clientForm.addEventListener('submit', handleSaveClient);
            ui.clientsList.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-client-btn');
                const deleteBtn = e.target.closest('.delete-client-btn');
                const addPurchaseBtn = e.target.closest('.add-purchase-btn');
                const historyBtn = e.target.closest('.view-history-btn');
                const rankingBtn = e.target.closest('.client-ranking-btn');
                
                if (editBtn) openClientModalInMode('edit', editBtn.dataset.id);
                else if (deleteBtn) handleDeleteClient(deleteBtn.dataset.id);
                else if (addPurchaseBtn) openAddPurchaseModal(addPurchaseBtn.dataset.id);
                else if (historyBtn) openPurchaseHistoryModal(historyBtn.dataset.id);
                else if (rankingBtn) showClientProductRanking(rankingBtn.dataset.id);
            });
            ui.searchClientAddressBtn.addEventListener('click', () => geocodeSearch(document.getElementById('clientAddressInput').value, clientModalMap, updateClientModalMarker));
            
            ui.setStartPointBtn.addEventListener('click', () => toggleStartPointModal(true));
            ui.cancelStartPointBtn.addEventListener('click', () => toggleStartPointModal(false));
            ui.startPointModal.addEventListener('click', (e) => { if (e.target === ui.startPointModal) toggleStartPointModal(false); });
            ui.saveStartPointBtn.addEventListener('click', handleSaveStartPoint);
            ui.searchStartAddrBtn.addEventListener('click', () => geocodeSearch(document.getElementById('start-address-input').value, startPointMap, updateStartPointMarker));

            ui.improveInstructionsBtn.addEventListener('click', handleImproveInstructions);
            ui.generateRouteBtn.addEventListener('click', generateRoute);
            ui.getAiRouteSummaryBtn.addEventListener('click', handleAnalyzeRoute);
            ui.analyzeClientsBtn.addEventListener('click', handleAnalyzeClients);
            ui.generateConfirmationBtn.addEventListener('click', handleGenerateConfirmation);
            ui.copyConfirmationBtn.addEventListener('click', () => {
                ui.confirmationMessage.select();
                document.execCommand('copy');
            });

            ui.addPurchaseForm.addEventListener('submit', handleSavePurchase);
            document.getElementById('purchaseProductsInput').addEventListener('input', (e) => {
                const { totalAmount } = parseProductsInput(e.target.value);
                document.getElementById('purchaseAmountInput').value = totalAmount.toFixed(2);
                document.getElementById('purchaseAmountPaidInput').value = totalAmount.toFixed(2);
            });
            ui.cancelAddPurchaseBtn.addEventListener('click', closeAddPurchaseModal);
            ui.addPurchaseModal.addEventListener('click', (e) => { if (e.target.id === 'add-purchase-modal') closeAddPurchaseModal(); });

            ui.closePurchaseHistoryBtn.addEventListener('click', closePurchaseHistoryModal);
            ui.purchaseHistoryModal.addEventListener('click', (e) => { if(e.target.id === 'purchase-history-modal') closePurchaseHistoryModal(); });
            
            ui.editPurchaseForm.addEventListener('submit', handleUpdatePurchase);
            document.getElementById('editPurchaseProductsInput').addEventListener('input', (e) => {
                const { totalAmount } = parseProductsInput(e.target.value);
                document.getElementById('editPurchaseAmountInput').value = totalAmount.toFixed(2);
            });
            ui.cancelEditPurchaseBtn.addEventListener('click', closeEditPurchaseModal);
            ui.editPurchaseModal.addEventListener('click', (e) => { if(e.target.id === 'edit-purchase-modal') closeEditPurchaseModal(); });

            
            ui.tabLogistics.addEventListener('click', () => switchTab('logistics'));
            ui.tabClients.addEventListener('click', () => switchTab('clients'));
            ui.tabAnalysis.addEventListener('click', () => switchTab('analysis'));

            ui.closeClientRankingModalBtn.addEventListener('click', closeClientRankingModal);
            ui.clientRankingModal.addEventListener('click', (e) => { if(e.target.id === 'client-ranking-modal') closeClientRankingModal(); });

            // Listeners para los filtros de clientes
            ui.clientSearchInput.addEventListener('input', applyAndRenderClientFilters);
            ui.minAvgPurchaseInput.addEventListener('input', applyAndRenderClientFilters);
            ui.maxAvgPurchaseInput.addEventListener('input', applyAndRenderClientFilters);
            ui.clearClientFiltersBtn.addEventListener('click', () => {
                ui.clientSearchInput.value = '';
                ui.minAvgPurchaseInput.value = '';
                ui.maxAvgPurchaseInput.value = '';
                applyAndRenderClientFilters();
            });

            // Listener para el modal de pedidos
            document.getElementById('productosInput').addEventListener('input', (e) => {
                const { totalAmount } = parseProductsInput(e.target.value);
                if (totalAmount > 0) {
                    document.getElementById('importeInput').value = totalAmount.toFixed(2);
                }
            });
        }
        
        function switchTab(tabName) {
            ui.logisticsView.classList.add('hidden');
            ui.clientsView.classList.add('hidden');
            ui.analysisView.classList.add('hidden');

            ui.tabLogistics.setAttribute('aria-selected', 'false');
            ui.tabClients.setAttribute('aria-selected', 'false');
            ui.tabAnalysis.setAttribute('aria-selected', 'false');
            ui.tabLogistics.classList.remove('bg-indigo-600', 'text-white');
            ui.tabClients.classList.remove('bg-indigo-600', 'text-white');
            ui.tabAnalysis.classList.remove('bg-indigo-600', 'text-white');

            if (tabName === 'logistics') {
                ui.logisticsView.classList.remove('hidden');
                ui.tabLogistics.setAttribute('aria-selected', 'true');
                ui.tabLogistics.classList.add('bg-indigo-600', 'text-white');
                google.maps.event.trigger(mainMap, 'resize');
            } else if (tabName === 'clients') {
                ui.clientsView.classList.remove('hidden');
                ui.tabClients.setAttribute('aria-selected', 'true');
                ui.tabClients.classList.add('bg-indigo-600', 'text-white');
                google.maps.event.trigger(clientsMap, 'resize');
            } else if (tabName === 'analysis') {
                ui.analysisView.classList.remove('hidden');
                ui.tabAnalysis.setAttribute('aria-selected', 'true');
                ui.tabAnalysis.classList.add('bg-indigo-600', 'text-white');
                updateRankings();
            }
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value || 0);
        }

        function parseProductsInput(text) {
            if (!text || !text.trim()) return { products: [], totalAmount: 0 };
            
            const lines = text.trim().split('\n');
            const products = [];
            let totalAmount = 0;

            // Regex para capturar: ‚û°Ô∏è 1 x Nombre del Producto ($1234.56) o ($1.234,56)
            const productRegex = /‚û°Ô∏è\s*(\d+)\s*x\s*(.*?)\s*\(\$([\d,.]+)\)/;

            lines.forEach(line => {
                const match = line.match(productRegex);
                if (match) {
                    try {
                        const quantity = parseInt(match[1], 10);
                        const name = match[2].trim();
                        const priceString = match[3];

                        // L√≥gica mejorada para interpretar el precio, manejando tanto '.' como ',' como separador decimal.
                        const normalizePrice = (pStr) => {
                            const lastComma = pStr.lastIndexOf(',');
                            const lastDot = pStr.lastIndexOf('.');

                            if (lastComma > lastDot) {
                                // Formato como 1.234,56 (coma es decimal)
                                return parseFloat(pStr.replace(/\./g, '').replace(',', '.'));
                            } else if (lastDot > lastComma) {
                                // Formato como 1,234.56 o 1234.56 (punto es decimal)
                                return parseFloat(pStr.replace(/,/g, ''));
                            } else {
                                // Sin separadores o formato no est√°ndar
                                return parseFloat(pStr.replace(/,/g, ''));
                            }
                        };
                        
                        const lineTotalPrice = normalizePrice(priceString);
                        
                        if (!isNaN(quantity) && !isNaN(lineTotalPrice) && name && quantity > 0) {
                            // Calcular el precio unitario
                            const price = lineTotalPrice / quantity;
                            products.push({ name, quantity, price });
                            totalAmount += lineTotalPrice;
                        }
                    } catch (e) {
                        console.warn("L√≠nea de producto mal formateada:", line, e);
                    }
                }
            });
            
            return { products, totalAmount };
        }


        function formatProductsToText(products) {
            if (!products || products.length === 0) return '';
            // Formato simple para la base de datos, ya que el parseo ahora es m√°s robusto
            return products.map(p => `${p.quantity} x ${p.name} @ ${p.price.toFixed(2)}`).join('\n');
        }

        async function updateRankings() {
            // Product Rankings
            const productsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/products`);
            const productsSnapshot = await getDocs(productsRef);
            const products = productsSnapshot.docs.map(doc => doc.data());

            const sortedByQuantity = [...products].sort((a, b) => b.totalQuantitySold - a.totalQuantitySold).slice(0, 5);
            ui.rankingByQuantity.innerHTML = sortedByQuantity.map((p, i) => `
                <div class="flex items-center text-sm">
                    <span class="font-bold text-gray-500 w-6">${i + 1}.</span>
                    <span class="flex-1 font-medium text-gray-700">${p.name}</span>
                    <span class="text-blue-600 font-bold">${p.totalQuantitySold} uds.</span>
                </div>
            `).join('') || '<p class="text-sm text-gray-500">No hay datos de productos.</p>';

            const sortedByRevenue = [...products].sort((a, b) => b.totalRevenue - a.totalRevenue).slice(0, 5);
            ui.rankingByRevenue.innerHTML = sortedByRevenue.map((p, i) => `
                <div class="flex items-center text-sm">
                    <span class="font-bold text-gray-500 w-6">${i + 1}.</span>
                    <span class="flex-1 font-medium text-gray-700">${p.name}</span>
                    <span class="text-green-600 font-bold">${formatCurrency(p.totalRevenue)}</span>
                </div>
            `).join('') || '<p class="text-sm text-gray-500">No hay datos de productos.</p>';

            // Client Rankings
             const sortedBySpent = [...allClients].sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0)).slice(0, 5);
             ui.rankingClientsBySpent.innerHTML = sortedBySpent.map((c, i) => `
                <div class="flex items-center text-sm">
                    <span class="font-bold text-gray-500 w-6">${i + 1}.</span>
                    <span class="flex-1 font-medium text-gray-700">${c.cliente}</span>
                    <span class="text-green-600 font-bold">${formatCurrency(c.totalSpent)}</span>
                </div>
            `).join('') || '<p class="text-sm text-gray-500">No hay datos de clientes.</p>';

            const sortedByPurchases = [...allClients].sort((a, b) => (b.purchaseCount || 0) - (a.purchaseCount || 0)).slice(0, 5);
             ui.rankingClientsByPurchases.innerHTML = sortedByPurchases.map((c, i) => `
                <div class="flex items-center text-sm">
                    <span class="font-bold text-gray-500 w-6">${i + 1}.</span>
                    <span class="flex-1 font-medium text-gray-700">${c.cliente}</span>
                    <span class="text-blue-600 font-bold">${c.purchaseCount} compras</span>
                </div>
            `).join('') || '<p class="text-sm text-gray-500">No hay datos de clientes.</p>';
        }

        function closeClientRankingModal() {
            const modal = ui.clientRankingModal;
            modal.querySelector('.bg-white').classList.add('opacity-0', '-translate-y-10');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function showClientProductRanking(clientId) {
            const client = allClients.find(c => c.id === clientId);
            if (!client) return;

            ui.clientRankingModalTitle.textContent = `Ranking de Productos para ${client.cliente}`;
            
            const purchases = await getClientPurchaseHistory(clientId);
            
            const productStats = {};

            purchases.forEach(p => {
                if (p.products && Array.isArray(p.products)) {
                    p.products.forEach(prod => {
                        const name = prod.name.trim();
                        if (!productStats[name]) {
                            productStats[name] = { name: name, totalQuantity: 0, totalRevenue: 0 };
                        }
                        productStats[name].totalQuantity += prod.quantity;
                        productStats[name].totalRevenue += prod.quantity * prod.price;
                    });
                }
            });

            const statsArray = Object.values(productStats);

            // Ranking por cantidad
            const sortedByQuantity = [...statsArray].sort((a, b) => b.totalQuantity - a.totalQuantity);
            ui.clientRankingByQuantity.innerHTML = sortedByQuantity.map((p, i) => `
                <li><span class="font-medium">${i + 1}. ${p.name}</span> - <span class="font-bold text-blue-600">${p.totalQuantity} unidades</span></li>
            `).join('') || '<p class="text-sm text-gray-500">No hay datos de productos para este cliente.</p>';

            // Ranking por ingresos
            const sortedByRevenue = [...statsArray].sort((a, b) => b.totalRevenue - a.totalRevenue);
            ui.clientRankingByRevenue.innerHTML = sortedByRevenue.map((p, i) => `
                <li><span class="font-medium">${i + 1}. ${p.name}</span> - <span class="font-bold text-green-600">${formatCurrency(p.totalRevenue)}</span></li>
            `).join('') || '<p class="text-sm text-gray-500">No hay datos de productos para este cliente.</p>';
            
            // Abrir el modal
            const modal = ui.clientRankingModal;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.querySelector('.bg-white').classList.remove('opacity-0', '-translate-y-10');
            }, 10);
        }

        function applyAndRenderClientFilters() {
            const searchTerm = ui.clientSearchInput.value.toLowerCase().trim();
            const minAvg = parseFloat(ui.minAvgPurchaseInput.value);
            const maxAvg = parseFloat(ui.maxAvgPurchaseInput.value);

            let filteredClients = allClients.filter(client => {
                // Filtro por t√©rmino de b√∫squeda (nombre o direcci√≥n)
                const matchesSearch = searchTerm === '' || 
                                    client.cliente.toLowerCase().includes(searchTerm) || 
                                    client.direccion.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;

                // Filtro por compra promedio
                const avgPurchase = (client.purchaseCount > 0) ? (client.totalSpent || 0) / client.purchaseCount : 0;
                
                const matchesMin = isNaN(minAvg) || avgPurchase >= minAvg;
                const matchesMax = isNaN(maxAvg) || avgPurchase <= maxAvg;

                return matchesMin && matchesMax;
            });

            renderClientsList(filteredClients);
            renderClientMap(filteredClients);
        }

        // --- FUNCI√ìN DE INICIO GLOBAL Y VERIFICACI√ìN ---
        window.initApp = function() {
            initializeGoogleMapsServices();
            initializeMaps();
            setupEventListeners();
            ui.initialLoadingScreen.classList.add('hidden');
            ui.appContent.classList.remove('hidden');
            listenToOrders();
            listenToClients();
        };

        function runStartupChecks() {
            if (Maps_API_KEY.includes("TU_API_KEY")) {
                ui.initialLoadingScreen.innerHTML = `<div class="text-center p-8 max-w-md mx-auto"><h2 class="text-2xl font-bold text-red-600 mb-2">Error de Configuraci√≥n de Mapas</h2><p class="text-gray-700">La clave de API de Google Maps no es v√°lida.</p></div>`;
                return;
            }

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${Maps_API_KEY}&callback=initApp&libraries=places,routes,visualization&v=weekly`;
            script.async = true;
            document.head.appendChild(script);
        }

        function main() {
            if (!firebaseConfig || Object.keys(firebaseConfig).length < 5 || (firebaseConfig.apiKey && firebaseConfig.apiKey.includes("PEGA AQU√ç"))) {
                ui.loginScreen.innerHTML = `<div class="text-center p-8 max-w-lg mx-auto"><h2 class="text-2xl font-bold text-red-600 mb-2">Error Cr√≠tico de Configuraci√≥n</h2><p class="text-gray-700">La configuraci√≥n de Firebase no se ha agregado al archivo <code class='bg-red-100 text-red-800 p-1 rounded'>gestor.html</code>. La aplicaci√≥n no puede iniciarse.</p><p class="mt-2 text-sm text-gray-500">Por favor, copia la configuraci√≥n desde tu proyecto de Firebase y p√©gala en el lugar indicado en el c√≥digo.</p></div>`;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setupAuthListener();
            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                ui.loginScreen.innerHTML = `<div class="text-center p-8 max-w-lg mx-auto"><h2 class="text-2xl font-bold text-red-600 mb-2">Error de Firebase</h2><p class="text-gray-700">No se pudo inicializar Firebase. Revisa la consola para ver los detalles del error. Es muy probable que la clave de API sea inv√°lida o que el dominio no est√© autorizado.</p></div>`;
            }
        }

        main();

    </script>
</body>
</html>