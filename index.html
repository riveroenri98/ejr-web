<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fidelidad - EJR.com.ar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Estilos Generales del Sitio */
        body {
            font-family: 'Lato', sans-serif;
            background-color: #F9F7F5;
            color: #5A5751;
        }
        .text-primary { color: #5A5751; }
        .text-secondary { color: #7d7a75; }
        .bg-primary { background-color: #5A5751; }
        .bg-primary-hover:hover { background-color: #4a4742; }
        .border-custom { border-color: #CCC3BA; }
        .ring-custom:focus { 
            --tw-ring-color: #5A5751;
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }
        .card-custom {
            background-color: #FFFFFF;
            border-color: #EAE6E1;
        }
        .icon-primary { color: #5A5751; }

        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 50; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 90%; max-width: 500px; }
        .modal-show { display: flex; }

        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 700; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); transition: bottom 0.5s ease-in-out; z-index: 100; }
        .toast.show { bottom: 20px; }
        
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-confirmed { background-color: #d1fae5; color: #065f46; }
        .status-declined { background-color: #fee2e2; color: #991b1b; }
        
        .star-icon { color: #facc15; }

        /* ESTILOS PARA EL DASHBOARD FINANCIERO */
        #financial-dashboard-page {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        #financial-dashboard-page .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }
        #financial-dashboard-page .modal-content {
            background-color: white; padding: 1.5rem; border-radius: 0.5rem;
            width: 90%; max-width: 500px;
        }
        #financial-dashboard-page .hidden {
            display: none;
        }
    </style>
</head>
<body class="antialiased">

    <div id="landing-page">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-black text-primary">EJR<span class="font-light">.com.ar</span></div>
                <div id="auth-nav-links" class="flex items-center gap-4">
                    </div>
            </nav>
        </header>
        <main>
            <section class="text-center py-20 sm:py-32 bg-white">
                <div class="container mx-auto px-6">
                    <h1 class="text-4xl md:text-6xl font-black text-primary leading-tight">C.P.N. Enrique Jose Rivero</h1>
                    <p class="mt-4 text-lg md:text-xl text-secondary max-w-3xl mx-auto">[Aquí puedes poner una breve descripción de tu negocio.]</p>
                    <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4 flex-wrap">
                        <button id="main-to-customers" class="w-full sm:w-auto px-8 py-4 bg-primary text-white font-bold rounded-lg bg-primary-hover transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                            Sistema de Clientes - SUPER21 <i class="fas fa-users"></i>
                        </button>
                        <button id="main-to-financial" class="w-full sm:w-auto px-8 py-4 bg-primary text-white font-bold rounded-lg bg-primary-hover transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                            Dashboard Financiero <i class="fas fa-chart-line"></i>
                        </button>
                        <a href="gestor.html" target="_blank" class="w-full sm:w-auto px-8 py-4 bg-primary text-white font-bold rounded-lg bg-primary-hover transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                            GESTION ENVIOS SUPER 21 <i class="fas fa-truck"></i>
                        </a>
                        <a href="controlventas.html" class="w-full sm:w-auto px-8 py-4 bg-primary text-white font-bold rounded-lg bg-primary-hover transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                            Sistema Control de Ventas <i class="fas fa-file-invoice-dollar"></i>
                        </a>
                    </div>
                </div>
            </section>
            <section class="py-20">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center text-primary mb-12">Nuestra Ubicación y Contacto</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                        <div class="card-custom border rounded-xl shadow-sm p-6 flex items-center gap-6"><i class="fas fa-map-marker-alt icon-primary text-4xl"></i><div><h3 class="text-xl font-bold text-primary">Dirección</h3><p class="text-secondary">[Tu Dirección, Ciudad, Provincia]</p></div></div>
                        <div class="card-custom border rounded-xl shadow-sm p-6 flex items-center gap-6"><i class="fas fa-phone icon-primary text-4xl"></i><div><h3 class="text-xl font-bold text-primary">Teléfono</h3><p class="text-secondary">[Tu Número de Teléfono]</p></div></div>
                    </div>
                </div>
            </section>
        </main>
        <footer class="bg-primary text-white py-6">
            <div class="container mx-auto px-6 text-center">
                <p class="text-gray-200">&copy; <span id="footer-year"></span> C.P.N. Enrique Jose Rivero. Todos los derechos reservados.</p>
                <p class="text-sm text-gray-400 mt-1">Powered by EJR.com.ar</p>
            </div>
        </footer>
    </div>
    
    <div id="login-page" style="display: none;" class="flex items-center justify-center min-h-screen">
        <div class="card-custom border rounded-xl shadow-lg w-full max-w-md mx-4">
            <div class="p-8 text-center">
                <h1 class="text-3xl font-black text-primary mb-2">Iniciar Sesión</h1>
                <p class="text-secondary mb-6">Acceso exclusivo para administradores.</p>
            </div>
            <div class="p-8 border-t border-custom">
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium mb-1 text-secondary">Correo Electrónico</label>
                        <input type="email" id="email" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium mb-1 text-secondary">Contraseña</label>
                        <input type="password" id="password" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                    <button type="submit" class="w-full bg-primary bg-primary-hover text-white font-bold rounded-lg py-3 flex items-center justify-center gap-2">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </form>
                <button id="back-to-home-from-login" class="w-full mt-4 bg-gray-200 text-gray-800 font-bold rounded-lg py-3 flex items-center justify-center gap-2 hover:bg-gray-300">
                    <i class="fas fa-arrow-left"></i> Volver al Inicio
                </button>
            </div>
        </div>
    </div>

    <div id="customer-system-page" style="display: none;">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-black text-primary">EJR<span class="font-light">.com.ar</span></div>
                <div class="flex items-center gap-4">
                    <button id="nav-to-home-from-customers" class="font-bold text-primary hover:opacity-70 transition-opacity">INICIO</button>
                    <button id="logout-btn-customers" class="font-bold text-red-500 hover:opacity-70 transition-opacity flex items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </nav>
        </header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <h1 class="text-4xl md:text-5xl font-black text-primary mb-10 text-center sm:text-left">Panel de Clientes - SUPER21</h1>
            <div class="card-custom border rounded-xl shadow-sm mb-8">
                <div class="p-6 border-b border-custom"><h2 class="text-xl font-bold flex items-center gap-3 text-primary"><i class="fas fa-user-plus"></i> Agregar Nuevo Cliente</h2></div>
                <div class="p-6">
                    <form id="add-client-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Nombre Completo</label><input id="new-client-name" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" placeholder="Ej: Juan Pérez" required /></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">DNI</label><input id="new-client-dni" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" placeholder="Ej: 30123456" required /></div>
                        <button type="submit" class="bg-primary bg-primary-hover text-white font-bold rounded-lg h-12 flex items-center justify-center gap-2"><i class="fas fa-user-plus"></i> Agregar Cliente</button>
                    </form>
                </div>
            </div>
            <div class="card-custom border rounded-xl shadow-sm">
                <div class="p-6 border-b border-custom">
                    <h2 class="text-xl font-bold text-primary">Lista de Clientes</h2>
                    <div class="relative mt-4">
                       <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                       <input id="search-client-input" placeholder="Buscar por nombre o DNI..." class="w-full p-3 pl-10 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                </div>
                <div class="p-0 overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-custom"><tr>
                            <th class="p-4 font-bold text-primary">Nombre</th><th class="p-4 font-bold text-primary">DNI</th><th class="p-4 font-bold text-primary">Saldo</th><th class="p-4 font-bold text-primary">Estrellas</th><th class="p-4 font-bold text-primary text-right">Acciones</th>
                        </tr></thead>
                        <tbody id="client-list-tbody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="supplier-management-page" style="display: none;">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-black text-primary">EJR<span class="font-light">.com.ar</span></div>
                <div class="flex items-center gap-4">
                    <button id="nav-to-home-from-suppliers" class="font-bold text-primary hover:opacity-70 transition-opacity">INICIO</button>
                    <button id="logout-btn-suppliers" class="font-bold text-red-500 hover:opacity-70 transition-opacity flex items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </nav>
        </header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <h1 class="text-4xl md:text-5xl font-black text-primary mb-10 text-center sm:text-left">Panel de Proveedores</h1>
            <div class="card-custom border rounded-xl shadow-sm">
                <div class="p-6 border-b border-custom">
                    <h2 class="text-xl font-bold text-primary">Lista de Proveedores</h2>
                    <div class="relative mt-4">
                       <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                       <input id="search-supplier-input" placeholder="Buscar por nombre o CUIT..." class="w-full p-3 pl-10 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                </div>
                <div class="p-0 overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-custom"><tr>
                            <th class="p-4 font-bold text-primary">Nombre</th>
                            <th class="p-4 font-bold text-primary">CUIT</th>
                            <th class="p-4 font-bold text-primary text-right">Acciones</th>
                        </tr></thead>
                        <tbody id="supplier-list-tbody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="financial-dashboard-page" style="display: none;">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-black text-primary">EJR<span class="font-light">.com.ar</span></div>
                <div class="flex items-center gap-4">
                     <button id="nav-to-home-from-financial" class="font-bold text-primary hover:opacity-70 transition-opacity">INICIO</button>
                    <button id="logout-btn-financial" class="font-bold text-red-500 hover:opacity-70 transition-opacity flex items-center gap-2"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
                </div>
            </nav>
        </header>
        <main class="bg-gray-100 text-gray-800">
             <div class="container mx-auto p-4 md:p-8">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Financial Dashboard</h1>
                    <p class="text-gray-600">Registrá tus compras y ventas diarias.</p>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Agregar Transacción</h2>
                        <form id="transaction-form" class="space-y-4">
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" id="date" name="date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="type" class="block text-sm font-medium text-gray-700">Tipo de Transacción</label>
                                <select id="type" name="type" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="purchase">Compra</option>
                                    <option value="sale">Venta</option>
                                </select>
                            </div>

                            <div id="purchase-fields" class="space-y-4">
                                <div>
                                    <label for="purchase-supplier" class="block text-sm font-medium text-gray-700">Proveedor</label>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <select id="purchase-supplier" name="supplier" required class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            </select>
                                        <button type="button" id="add-new-supplier-btn" class="flex-shrink-0 bg-blue-500 hover:bg-blue-600 text-white font-bold p-2 rounded-md" title="Agregar Nuevo Proveedor">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label for="purchase-cuit" class="block text-sm font-medium text-gray-700">CUIT</label>
                                    <input type="text" id="purchase-cuit" name="cuit" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Se completará automáticamente">
                                </div>
                                <div>
                                    <label for="purchase-paymentMethod" class="block text-sm font-medium text-gray-700">Método de Pago</label>
                                    <select id="purchase-paymentMethod" name="paymentMethod" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Transferencia">Transferencia</option>
                                        <option value="Cheque">Cheque</option>
                                        <option value="Cuenta Corriente">Cuenta Corriente</option>
                                    </select>
                                </div>
                                <div id="due-date-field" class="space-y-4 hidden">
                                    <div>
                                        <label id="due-date-label" for="due-date" class="block text-sm font-medium text-gray-700"></label>
                                        <input type="date" id="due-date" name="dueDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label for="purchase-amount" class="block text-sm font-medium text-gray-700">Importe</label>
                                    <input type="number" id="purchase-amount" name="amount" placeholder="0.00" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                            </div>

                            <div id="sale-fields" class="space-y-4 hidden">
                                <div>
                                    <label for="sale-customerName" class="block text-sm font-medium text-gray-700">Nombre del Cliente</label>
                                    <input type="text" id="sale-customerName" name="customerName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="sale-cuit" class="block text-sm font-medium text-gray-700">CUIT (Opcional)</label>
                                    <input type="text" id="sale-cuit" name="cuit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="sale-type" class="block text-sm font-medium text-gray-700">Tipo de Venta</label>
                                    <select id="sale-type" name="saleType" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <option value="ONLINE">ONLINE</option>
                                        <option value="SALON COMERCIAL">SALON COMERCIAL</option>
                                        <option value="BARES">BARES</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="sale-amount" class="block text-sm font-medium text-gray-700">Importe</label>
                                    <input type="number" id="sale-amount" name="amount" placeholder="0.00" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                            </div>
                            
                            <div id="error-message" class="text-red-600 text-sm font-medium p-3 bg-red-100 rounded-md hidden"></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                Agregar Transacción
                            </button>
                        </form>
                    </div>

                    <div class="lg:col-span-2 space-y-8">
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold mb-4">Análisis Diario (Ventas - Compras)</h2>
                            <div class="flex flex-col sm:flex-row items-center gap-4">
                                <div>
                                    <label for="day-selector" class="block text-sm font-medium text-gray-700">Seleccione un día:</label>
                                    <input type="date" id="day-selector" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div class="flex-1 text-center sm:text-left">
                                    <p class="text-gray-600">Resultado del día:</p>
                                    <div id="daily-difference-display" class="text-3xl font-bold">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold mb-4">Resumen de Transacciones (Global)</h2>
                            <div class="chart-container"><canvas id="transaction-chart"></canvas></div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                             <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                                <h2 class="text-2xl font-semibold">Resumen Mensual</h2>
                                <div class="mt-4 sm:mt-0">
                                    <label for="month-selector" class="text-sm font-medium text-gray-700 mr-2">Mes:</label>
                                    <select id="month-selector" class="p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                                </div>
                            </div>
                            <div class="chart-container"><canvas id="monthly-transaction-chart"></canvas></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-2xl font-semibold mb-4">Compras por Proveedor</h2>
                                <div class="chart-container"><canvas id="supplier-pie-chart"></canvas></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-2xl font-semibold mb-4">Compras por Método de Pago</h2>
                                <div class="chart-container"><canvas id="payment-method-pie-chart"></canvas></div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold mb-4">Historial de Transacciones</h2>
                            
                            <div id="history-filters" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                                <div>
                                    <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Fecha Desde</label>
                                    <input type="date" id="filter-start-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="filter-end-date" class="block text-sm font-medium text-gray-700">Fecha Hasta</label>
                                    <input type="date" id="filter-end-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="filter-name" class="block text-sm font-medium text-gray-700">Proveedor/Cliente</label>
                                    <input type="text" id="filter-name" placeholder="Buscar por nombre..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div class="flex items-end">
                                    <button id="clear-filters-btn" class="w-full bg-gray-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-600 transition duration-150 ease-in-out">Limpiar</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CUIT</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalles</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                                <h2 class="text-2xl font-semibold">Análisis Anual</h2>
                                <div class="mt-4 sm:mt-0">
                                    <label for="year-selector" class="text-sm font-medium text-gray-700 mr-2">Año:</label>
                                    <select id="year-selector" class="p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                                <div>
                                    <h3 class="text-xl font-semibold mb-4 text-center">Compras por Mes</h3>
                                    <div id="monthly-purchases-breakdown-container"></div>
                                </div>
                                <div>
                                    <h3 class="text-xl font-semibold mb-4 text-center">Ventas por Mes</h3>
                                    <div id="monthly-sales-breakdown-container"></div>
                                </div>
                            </div>
                        </div>
                        </div>
                </div>
            </div>

            <div id="edit-modal" class="modal-overlay hidden">
                <div class="modal-content">
                    <h2 class="text-2xl font-semibold mb-4">Editar Transacción</h2>
                    <form id="edit-form" class="space-y-4">
                        <input type="hidden" id="edit-id">
                        <input type="hidden" id="edit-transaction-type">
                        
                        <div id="edit-purchase-fields" class="hidden space-y-4">
                            <div>
                                <label for="edit-purchase-supplierName" class="block text-sm font-medium text-gray-700">Nombre del Proveedor</label>
                                <input type="text" id="edit-purchase-supplierName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="edit-purchase-cuit" class="block text-sm font-medium text-gray-700">CUIT</label>
                                <input type="text" id="edit-purchase-cuit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="edit-purchase-paymentMethod" class="block text-sm font-medium text-gray-700">Método de Pago</label>
                                <select id="edit-purchase-paymentMethod" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>
                             <div>
                                <label for="edit-purchase-amount" class="block text-sm font-medium text-gray-700">Importe</label>
                                <input type="number" id="edit-purchase-amount" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>

                        <div id="edit-sale-fields" class="hidden space-y-4">
                             <div>
                                <label for="edit-sale-customerName" class="block text-sm font-medium text-gray-700">Nombre del Cliente</label>
                                <input type="text" id="edit-sale-customerName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="edit-sale-cuit" class="block text-sm font-medium text-gray-700">CUIT (Opcional)</label>
                                <input type="text" id="edit-sale-cuit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="edit-sale-type" class="block text-sm font-medium text-gray-700">Tipo de Venta</label>
                                <select id="edit-sale-type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="ONLINE">ONLINE</option>
                                    <option value="SALON COMERCIAL">SALON COMERCIAL</option>
                                    <option value="BARES">BARES</option>
                                </select>
                            </div>
                             <div>
                                <label for="edit-sale-amount" class="block text-sm font-medium text-gray-700">Importe</label>
                                <input type="number" id="edit-sale-amount" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>
                        
                        <div id="edit-error-message" class="text-red-600 text-sm font-medium p-3 bg-red-100 rounded-md hidden"></div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="cancel-edit" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="add-supplier-modal" class="modal-overlay hidden">
                <div class="modal-content">
                    <h2 class="text-2xl font-semibold mb-4">Agregar Nuevo Proveedor</h2>
                    <form id="add-supplier-form" class="space-y-4">
                        <div>
                            <label for="new-supplier-name" class="block text-sm font-medium text-gray-700">Nombre del Proveedor</label>
                            <input type="text" id="new-supplier-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="new-supplier-cuit" class="block text-sm font-medium text-gray-700">CUIT</label>
                            <input type="text" id="new-supplier-cuit" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div id="new-supplier-error" class="text-red-600 text-sm font-medium p-3 bg-red-100 rounded-md hidden"></div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="cancel-add-supplier" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Guardar Proveedor</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
    
    <div id="add-change-modal" class="modal-backdrop"><div class="modal-content"><h3 class="text-lg font-bold text-primary p-6 border-b border-custom" id="add-change-modal-title">Agregar Vuelto</h3><form id="add-change-form"><div class="p-6 space-y-4"><div><label class="block text-sm font-medium mb-1 text-secondary">Total Compra</label><input name="purchaseTotal" type="number" step="0.01" required placeholder="80.00" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" /></div><div><label class="block text-sm font-medium mb-1 text-secondary">Monto Pagado</label><input name="amountPaid" type="number" step="0.01" required placeholder="100.00" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" /></div></div><div class="p-6 border-t border-custom flex justify-end gap-3"><button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Confirmar</button></div></form></div></div>
    <div id="use-balance-modal" class="modal-backdrop"><div class="modal-content"><h3 class="text-lg font-bold text-primary p-6 border-b border-custom" id="use-balance-modal-title">Usar Saldo</h3><form id="use-balance-form"><div class="p-6 space-y-4"><p class="text-secondary">Saldo disponible: <span class="font-bold text-primary" id="use-balance-current-saldo"></span></p><div><label class="block text-sm font-medium mb-1 text-secondary">Total Nueva Compra</label><input name="purchaseTotal" type="number" step="0.01" required placeholder="150.00" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition"/></div><div><label class="block text-sm font-medium mb-1 text-secondary">Pago en Efectivo</label><input name="cashPaid" type="number" step="0.01" required placeholder="110.00" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition"/></div></div><div class="p-6 border-t border-custom flex justify-end gap-3"><button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">Confirmar</button></div></form></div></div>
    <div id="history-modal" class="modal-backdrop"><div class="modal-content"><h3 class="text-lg font-bold text-primary p-6 border-b border-custom" id="history-modal-title">Historial</h3><div id="history-list-content" class="p-6 max-h-96 overflow-y-auto space-y-3"></div><div class="p-6 border-t border-custom flex justify-end"><button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cerrar</button></div></div></div>
    <div id="delete-modal" class="modal-backdrop"><div class="modal-content text-center"><h3 class="text-lg font-bold text-primary p-6" id="delete-modal-title">Confirmar Eliminación</h3><p id="delete-modal-text" class="px-6 pb-6 text-secondary"></p><div class="p-6 border-t border-custom flex justify-center gap-4"><button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Eliminar</button></div></div></div>
    <div id="redeem-stars-modal" class="modal-backdrop"><div class="modal-content text-center"><h3 class="text-lg font-bold text-primary p-6" id="redeem-stars-modal-title">Canjear Estrellas</h3><p id="redeem-stars-modal-text" class="px-6 pb-6 text-secondary"></p><div class="p-6 border-t border-custom flex justify-center gap-4"><button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button id="confirm-redeem-btn" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600">Confirmar Canje</button></div></div></div>
    <div id="edit-supplier-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-primary p-6 border-b border-custom">Editar Proveedor</h3>
            <form id="edit-supplier-form">
                <input type="hidden" id="edit-supplier-id">
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1 text-secondary">Nombre del Proveedor</label>
                        <input id="edit-supplier-name" type="text" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 text-secondary">CUIT</label>
                        <input id="edit-supplier-cuit" type="text" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                    <div id="edit-supplier-error" class="text-red-600 text-sm font-medium p-3 bg-red-100 rounded-md hidden"></div>
                </div>
                <div class="p-6 border-t border-custom flex justify-end gap-3">
                    <button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-primary text-white font-bold py-2 px-4 rounded-lg bg-primary-hover">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <div id="toast-notification" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, increment, serverTimestamp, query, orderBy, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJbCC1pR-CQTpOXBicC59Jqm32Rr7q9M8",
            authDomain: "sistemafidelidad-super-21.firebaseapp.com",
            projectId: "sistemafidelidad-super-21",
            storageBucket: "sistemafidelidad-super-21.firebasestorage.app",
            messagingSenderId: "221163223090",
            appId: "1:221163223090:web:ffe60b7a75758d591c242b",
            measurementId: "G-79RSPJE5L8"
        };

        // --- Global App State ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let allClients = [];
        let allSuppliers = [];
        let itemToDelete = null;
        let selectedClient = null;
        let intendedTargetPage = null; 
        
        let unsubscribeClients = null; 
        let unsubscribeFinancial = null;
        let unsubscribeSuppliers = null;

        let isFinancialDashboardInitialized = false;
        let isSupplierManagementInitialized = false;

        document.addEventListener('DOMContentLoaded', () => {
            setupListeners();
            setupAuthListener();
            document.getElementById('footer-year').textContent = new Date().getFullYear();
        });

        function setupAuthListener() {
            onAuthStateChanged(auth, user => {
                updateNavUI(user);
                if (user && intendedTargetPage) {
                    navigateTo(intendedTargetPage);
                    intendedTargetPage = null; 
                } else if (!user) {
                    navigateTo('landing');
                    if (unsubscribeClients) unsubscribeClients();
                    if (unsubscribeFinancial) unsubscribeFinancial();
                    if (unsubscribeSuppliers) unsubscribeSuppliers();
                    unsubscribeClients = null;
                    unsubscribeFinancial = null;
                    unsubscribeSuppliers = null;
                }
            });
        }

        function updateNavUI(user) {
            const authNavLinks = document.getElementById('auth-nav-links');
            if (user) {
                authNavLinks.innerHTML = `
                    <button id="nav-to-customers-auth" class="font-bold text-primary hover:opacity-70 transition-opacity">CLIENTES</button>
                    <button id="nav-to-suppliers" class="font-bold text-primary hover:opacity-70 transition-opacity">PROVEEDORES</button>
                    <button id="nav-to-financial-dashboard" class="font-bold text-primary hover:opacity-70 transition-opacity">FINANZAS</button>
                    <button id="logout-btn-main" class="font-bold text-red-500 hover:opacity-70 transition-opacity flex items-center gap-2"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
                `;
                document.getElementById('nav-to-customers-auth').addEventListener('click', () => handleProtectedRoute('customer-system'));
                document.getElementById('nav-to-suppliers').addEventListener('click', () => handleProtectedRoute('supplier-management'));
                document.getElementById('nav-to-financial-dashboard').addEventListener('click', () => handleProtectedRoute('financial-dashboard'));
                document.getElementById('logout-btn-main').addEventListener('click', handleSignOut);
            } else {
                authNavLinks.innerHTML = `<button id="login-nav-btn" class="font-bold text-primary hover:opacity-70 transition-opacity">LOGIN</button>`;
                document.getElementById('login-nav-btn').addEventListener('click', () => {
                    intendedTargetPage = 'customer-system';
                    navigateTo('login');
                });
            }
        }

        function navigateTo(page) {
            document.querySelectorAll('#landing-page, #customer-system-page, #supplier-management-page, #login-page, #financial-dashboard-page').forEach(p => p.style.display = 'none');
            const targetPage = document.getElementById(`${page}-page`);
            if (targetPage) {
                targetPage.style.display = page === 'login' ? 'flex' : 'block';
            }

            if (page === 'customer-system' && auth.currentUser && !unsubscribeClients) listenForClients();
            if (page === 'supplier-management' && auth.currentUser && !isSupplierManagementInitialized) { initializeSupplierManagement(); isSupplierManagementInitialized = true; }
            if (page === 'financial-dashboard' && auth.currentUser && !isFinancialDashboardInitialized) { initializeFinancialDashboard(); isFinancialDashboardInitialized = true; }
        }
        
        function handleProtectedRoute(targetPage) {
            if (auth.currentUser) {
                navigateTo(targetPage);
            } else {
                intendedTargetPage = targetPage;
                navigateTo('login');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Inicio de sesión exitoso.", "success");
            } catch (error) {
                showToast("Error: Correo o contraseña incorrectos.", "error");
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                showToast("Sesión cerrada.", "success");
            } catch (error) { console.error("Sign out failed:", error); }
        }
        
        function setupListeners() {
            const addListener = (id, event, handler) => {
                const element = document.getElementById(id);
                if (element) element.addEventListener(event, handler);
            };
            
            addListener('main-to-customers', 'click', () => handleProtectedRoute('customer-system'));
            addListener('main-to-financial', 'click', () => handleProtectedRoute('financial-dashboard'));
            
            addListener('nav-to-home-from-customers', 'click', () => navigateTo('landing'));
            addListener('nav-to-home-from-suppliers', 'click', () => navigateTo('landing'));
            addListener('nav-to-home-from-financial', 'click', () => navigateTo('landing'));
            addListener('back-to-home-from-login', 'click', () => navigateTo('landing'));

            addListener('add-client-form', 'submit', handleAddClient);
            addListener('search-client-input', 'input', renderClientList);
            addListener('login-form', 'submit', handleLogin);
            
            addListener('logout-btn-customers', 'click', handleSignOut);
            addListener('logout-btn-suppliers', 'click', handleSignOut);
            addListener('logout-btn-financial', 'click', handleSignOut);
            
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.modal-backdrop').style.display = 'none';
                });
            });
            
            addListener('add-change-form', 'submit', handleAddChange);
            addListener('use-balance-form', 'submit', handleUseBalance);
            addListener('confirm-delete-btn', 'click', handleConfirmDelete);
            addListener('confirm-redeem-btn', 'click', handleRedeemStars);
        }

        // --- LÓGICA DE CLIENTES ---
        function listenForClients() {
            if (!db || !auth.currentUser || unsubscribeClients) return;
            const q = query(collection(db, "customers"), orderBy('name'));
            unsubscribeClients = onSnapshot(q, (snapshot) => {
                allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClientList();
            }, (error) => console.error("Error listening to clients:", error));
        }
        function renderClientList() {
            const searchInput = document.getElementById('search-client-input');
            if (!searchInput) return;
            const searchTerm = searchInput.value.toLowerCase();
            const tbody = document.getElementById('client-list-tbody');
            if (!tbody) return;
            const filteredClients = allClients.filter(c => c.name.toLowerCase().includes(searchTerm) || c.dni.toLowerCase().includes(searchTerm));
            tbody.innerHTML = '';
            if (filteredClients.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-secondary">No se encontraron clientes.</td></tr>`;
                return;
            }
            filteredClients.forEach(client => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-custom last:border-none hover:bg-gray-50';
                const starsCount = client.stars || 0;
                let starsHTML = '';
                for (let i = 0; i < starsCount; i++) { starsHTML += '<i class="fas fa-star star-icon"></i>'; }
                let actionsHTML = `
                    <button data-action="add-change" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2"><i class="fas fa-wallet"></i><span class="hidden sm:inline">Vuelto</span></button>
                    <button data-action="use-balance" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2"><i class="fas fa-exchange-alt"></i><span class="hidden sm:inline">Usar</span></button>
                    <button data-action="history" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2"><i class="fas fa-history"></i><span class="hidden sm:inline">Historial</span></button>`;
                if (starsCount >= 5) {
                    actionsHTML += `<button data-action="redeem-stars" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2"><i class="fas fa-gift"></i><span class="hidden sm:inline">Canjear</span></button>`;
                }
                actionsHTML += `<button data-action="delete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2"><i class="fas fa-trash"></i><span class="hidden sm:inline">Eliminar</span></button>`;
                tr.innerHTML = `<td class="p-4 font-semibold text-primary">${client.name}</td><td class="p-4 text-secondary">${client.dni}</td><td class="p-4 font-bold text-green-600">${formatCurrency(client.balance)}</td><td class="p-4 text-secondary text-lg">${starsHTML || '0'}</td><td class="p-4 text-right"><div class="flex justify-end gap-2 flex-wrap">${actionsHTML}</div></td>`;
                tr.querySelector('[data-action="add-change"]').addEventListener('click', () => openModal('add-change', client));
                tr.querySelector('[data-action="use-balance"]').addEventListener('click', () => openModal('use-balance', client));
                tr.querySelector('[data-action="history"]').addEventListener('click', () => openModal('history', client));
                tr.querySelector('[data-action="delete"]').addEventListener('click', () => openDeleteModal('client', client.id, client.name));
                const redeemBtn = tr.querySelector('[data-action="redeem-stars"]');
                if (redeemBtn) { redeemBtn.addEventListener('click', () => openModal('redeem-stars', client)); }
                tbody.appendChild(tr);
            });
        }
        async function handleAddClient(e) {
            e.preventDefault();
            const name = document.getElementById('new-client-name').value.trim();
            const dni = document.getElementById('new-client-dni').value.trim();
            if (!name || !dni) return showToast("Nombre y DNI son obligatorios.", "error");
            const q = query(collection(db, "customers"), where("dni", "==", dni));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) return showToast(`El cliente ${querySnapshot.docs[0].data().name} ya está registrado.`, "error");
            try {
                await addDoc(collection(db, "customers"), { name, dni, balance: 0, stars: 0 });
                showToast("Cliente agregado exitosamente.", "success");
                e.target.reset();
            } catch (err) { showToast("Error al agregar el cliente.", "error"); }
        }
        
        function openModal(type, client) {
            selectedClient = client;
            const modal = document.getElementById(`${type}-modal`);
            if (type === 'add-change') { document.getElementById('add-change-modal-title').textContent = `Agregar Vuelto a ${client.name}`; } 
            else if (type === 'use-balance') { document.getElementById('use-balance-modal-title').textContent = `Usar Saldo de ${client.name}`; document.getElementById('use-balance-current-saldo').textContent = formatCurrency(client.balance); } 
            else if (type === 'history') { document.getElementById('history-modal-title').textContent = `Historial de ${client.name}`; loadHistory(client.id); } 
            else if (type === 'redeem-stars') { document.getElementById('redeem-stars-modal-text').textContent = `¿Confirmas canjear 5 estrellas de ${client.name} por un descuento especial?`; }
            modal.style.display = 'flex';
        }
        async function handleTransaction(type, amount, description) {
            const clientDocRef = doc(db, "customers", selectedClient.id);
            const balanceChange = type === 'credit' ? amount : -amount;
            try {
                await updateDoc(clientDocRef, { balance: increment(balanceChange) });
                await addDoc(collection(clientDocRef, "movements"), { type, amount, description, date: serverTimestamp() });
                showToast("Transacción exitosa.", "success");
            } catch (err) { showToast("Error en la transacción.", "error"); }
        }
        async function handleAddChange(e) {
            e.preventDefault();
            const form = e.target;
            const purchaseTotal = parseFloat(form.elements.purchaseTotal.value);
            const amountPaid = parseFloat(form.elements.amountPaid.value);
            const change = amountPaid - purchaseTotal;
            if (isNaN(purchaseTotal) || isNaN(amountPaid) || amountPaid < purchaseTotal) return showToast("Valores de compra inválidos.", "error");
            if (change > 0) { await handleTransaction('credit', change, 'Vuelto de compra'); }
            if (purchaseTotal >= 20000) {
                const clientDocRef = doc(db, "customers", selectedClient.id);
                await updateDoc(clientDocRef, { stars: increment(1) });
                await addDoc(collection(clientDocRef, "movements"), { type: 'star', description: 'Estrella ganada por compra', amount: purchaseTotal, date: serverTimestamp() });
                showToast(`¡${selectedClient.name} ha ganado una estrella! ⭐`, 'success');
            }
            form.closest('.modal-backdrop').style.display = 'none'; form.reset();
        }
        async function handleUseBalance(e) {
            e.preventDefault();
            const form = e.target;
            const purchaseTotal = parseFloat(form.elements.purchaseTotal.value);
            const cashPaid = parseFloat(form.elements.cashPaid.value);
            const amountToUse = purchaseTotal - cashPaid;
            if (isNaN(purchaseTotal) || isNaN(cashPaid) || amountToUse <= 0) return showToast("Valores de pago inválidos.", "error");
            if (selectedClient.balance < amountToUse) return showToast("Saldo insuficiente.", "error");
            await handleTransaction('debit', amountToUse, 'Uso de saldo en compra');
            if (purchaseTotal >= 20000) {
                 const clientDocRef = doc(db, "customers", selectedClient.id);
                 await updateDoc(clientDocRef, { stars: increment(1) });
                 await addDoc(collection(clientDocRef, "movements"), { type: 'star', description: 'Estrella ganada por compra', amount: purchaseTotal, date: serverTimestamp() });
                showToast(`¡${selectedClient.name} ha ganado una estrella! ⭐`, 'success');
            }
            form.closest('.modal-backdrop').style.display = 'none'; form.reset();
        }
        async function handleRedeemStars() {
            if (!selectedClient || (selectedClient.stars || 0) < 5) return;
            const clientDocRef = doc(db, "customers", selectedClient.id);
            try {
                await updateDoc(clientDocRef, { stars: increment(-5) });
                await addDoc(collection(clientDocRef, "movements"), { type: 'discount', description: 'Canje de 5 estrellas por descuento', date: serverTimestamp() });
                showToast("¡Estrellas canjeadas con éxito!", "success");
            } catch (error) { console.error("Error al canjear estrellas:", error); showToast("No se pudieron canjear las estrellas.", "error"); }
            document.getElementById('redeem-stars-modal').style.display = 'none';
        }
        async function loadHistory(clientId) {
            const contentDiv = document.getElementById('history-list-content');
            contentDiv.innerHTML = `<p class="text-center text-secondary">Cargando historial...</p>`;
            const q = query(collection(db, `customers/${clientId}/movements`), orderBy('date', 'desc'));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { contentDiv.innerHTML = `<p class="text-center text-secondary">No hay movimientos.</p>`; return; }
            contentDiv.innerHTML = snapshot.docs.map(doc => {
                const mov = doc.data(); let movHTML = '';
                switch(mov.type) {
                    case 'credit': movHTML = `<div class="p-3 rounded-lg flex justify-between items-center bg-green-50"><div><p class="font-semibold text-primary">${mov.description}</p><p class="text-sm text-secondary">${formatDate(mov.date)}</p></div><p class="font-bold text-lg text-green-700">+${formatCurrency(mov.amount)}</p></div>`; break;
                    case 'debit': movHTML = `<div class="p-3 rounded-lg flex justify-between items-center bg-red-50"><div><p class="font-semibold text-primary">${mov.description}</p><p class="text-sm text-secondary">${formatDate(mov.date)}</p></div><p class="font-bold text-lg text-red-700">-${formatCurrency(mov.amount)}</p></div>`; break;
                    case 'star': movHTML = `<div class="p-3 rounded-lg flex justify-between items-center bg-yellow-50"><div><p class="font-semibold text-amber-800">${mov.description} (${formatCurrency(mov.amount)})</p><p class="text-sm text-secondary">${formatDate(mov.date)}</p></div><p class="font-bold text-lg text-amber-500"><i class="fas fa-star"></i> +1</p></div>`; break;
                    case 'discount': movHTML = `<div class="p-3 rounded-lg flex justify-between items-center bg-blue-50"><div><p class="font-semibold text-blue-800">${mov.description}</p><p class="text-sm text-secondary">${formatDate(mov.date)}</p></div><p class="font-bold text-lg text-blue-600"><i class="fas fa-gift"></i> Canjeado</p></div>`; break;
                } return movHTML;
            }).join('');
        }

        // --- LÓGICA DEL DASHBOARD FINANCIERO ---
        function initializeFinancialDashboard() {
            const page = document.getElementById('financial-dashboard-page');
            if (!page) return;

            // --- INICIO: Declaraciones de elementos del DOM ---
            const transactionForm = page.querySelector('#transaction-form');
            const typeSelect = page.querySelector('#type');
            const purchaseFields = page.querySelector('#purchase-fields');
            const saleFields = page.querySelector('#sale-fields');
            const errorMessageDiv = page.querySelector('#error-message');
            const transactionList = page.querySelector('#transaction-list');
            const editModal = page.querySelector('#edit-modal');
            const editForm = page.querySelector('#edit-form');
            const cancelEditBtn = page.querySelector('#cancel-edit');
            const lineCtx = page.querySelector('#transaction-chart').getContext('2d');
            const supplierPieCtx = page.querySelector('#supplier-pie-chart').getContext('2d');
            const paymentPieCtx = page.querySelector('#payment-method-pie-chart').getContext('2d');
            const supplierSelect = page.querySelector('#purchase-supplier');
            const addNewSupplierBtn = page.querySelector('#add-new-supplier-btn');
            const addSupplierModal = page.querySelector('#add-supplier-modal');
            const addSupplierForm = page.querySelector('#add-supplier-form');
            const cancelAddSupplierBtn = page.querySelector('#cancel-add-supplier');
            const purchaseCuitInput = page.querySelector('#purchase-cuit');
            const yearSelector = page.querySelector('#year-selector');
            const monthlyPurchasesBreakdownContainer = page.querySelector('#monthly-purchases-breakdown-container');
            const monthlySalesBreakdownContainer = page.querySelector('#monthly-sales-breakdown-container');
            const filterStartDate = page.querySelector('#filter-start-date');
            const filterEndDate = page.querySelector('#filter-end-date');
            const filterName = page.querySelector('#filter-name');
            const clearFiltersBtn = page.querySelector('#clear-filters-btn');
            const paymentMethodSelect = page.querySelector('#purchase-paymentMethod');
            const dueDateField = page.querySelector('#due-date-field');
            const dueDateLabel = page.querySelector('#due-date-label');
            const dueDateInput = page.querySelector('#due-date');
            // --- FIN: Declaraciones de elementos del DOM ---
            
            // --- NUEVO: Elementos para resumen diario y mensual ---
            const daySelector = page.querySelector('#day-selector');
            const dailyDifferenceDisplay = page.querySelector('#daily-difference-display');
            const monthSelector = page.querySelector('#month-selector');
            const monthlyCtx = page.querySelector('#monthly-transaction-chart').getContext('2d');

            let lineChart, monthlyChart, supplierPieChart, paymentPieChart;
            let allTransactions = []; 
            let newlyAddedSupplierId = null;
            let detailedCheques = [];
            let detailedCtaCte = [];

            paymentMethodSelect.addEventListener('change', () => {
                const paymentMethod = paymentMethodSelect.value;
                if (paymentMethod === 'Cheque' || paymentMethod === 'Cuenta Corriente') {
                    dueDateField.classList.remove('hidden');
                    dueDateField.style.display = 'block';
                    dueDateLabel.textContent = paymentMethod === 'Cheque' ? 'Fecha de Vencimiento del Cheque' : 'Fecha de Pago Cta. Cte.';
                    dueDateInput.required = true;
                } else {
                    dueDateField.classList.add('hidden');
                    dueDateField.style.display = 'none';
                    dueDateInput.required = false;
                }
            });
            
            function applyFiltersAndRender() {
                const startDate = filterStartDate.value;
                const endDate = filterEndDate.value;
                const nameQuery = filterName.value.toLowerCase();
                let filteredTransactions = allTransactions;
                if (startDate) {
                    filteredTransactions = filteredTransactions.filter(t => t.date >= startDate);
                }
                if (endDate) {
                    filteredTransactions = filteredTransactions.filter(t => t.date <= endDate);
                }
                if (nameQuery) {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.partyName.toLowerCase().includes(nameQuery)
                    );
                }
                renderTransactions(filteredTransactions);
            }

            function listenForSuppliersInDashboard() {
                if (!auth.currentUser) return;
                if (unsubscribeSuppliers) unsubscribeSuppliers();
                const q = query(collection(db, "suppliers"), orderBy("name"));
                unsubscribeSuppliers = onSnapshot(q, (snapshot) => {
                    allSuppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const currentSelection = newlyAddedSupplierId || supplierSelect.value;
                    renderSupplierDropdown(currentSelection);
                    if (newlyAddedSupplierId) {
                        handleSupplierChange();
                        newlyAddedSupplierId = null; 
                    }
                }, (error) => console.error("Error al escuchar proveedores:", error));
            }

            function renderSupplierDropdown(selectedValue = null) {
                supplierSelect.innerHTML = '<option value="">-- Seleccione un Proveedor --</option>';
                allSuppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.id;
                    option.textContent = supplier.name;
                    if (supplier.id === selectedValue) option.selected = true;
                    supplierSelect.appendChild(option);
                });
            }

            function handleSupplierChange() {
                const selectedId = supplierSelect.value;
                purchaseCuitInput.value = selectedId ? (allSuppliers.find(s => s.id === selectedId)?.cuit || '') : '';
            }
            
            supplierSelect.addEventListener('change', handleSupplierChange);

            addNewSupplierBtn.addEventListener('click', () => {
                addSupplierModal.classList.remove('hidden');
                addSupplierModal.style.display = 'flex';
            });

            cancelAddSupplierBtn.addEventListener('click', () => {
                addSupplierModal.classList.add('hidden');
                addSupplierModal.style.display = 'none';
                addSupplierForm.reset();
            });

            addSupplierForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = addSupplierForm.querySelector('#new-supplier-name').value.trim();
                const newCuit = addSupplierForm.querySelector('#new-supplier-cuit').value.trim();
                const errorDiv = addSupplierForm.querySelector('#new-supplier-error');
                if (!newName || !newCuit) {
                    errorDiv.textContent = 'Nombre y CUIT son obligatorios.';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                const nameExists = allSuppliers.some(s => s.name.toLowerCase() === newName.toLowerCase());
                if (nameExists) {
                    errorDiv.textContent = `El proveedor "${newName}" ya se encuentra registrado.`;
                    errorDiv.classList.remove('hidden');
                    return;
                }
                const cuitExists = allSuppliers.some(s => s.cuit === newCuit);
                if (cuitExists) {
                    errorDiv.textContent = `Ya existe un proveedor con el CUIT ${newCuit}.`;
                    errorDiv.classList.remove('hidden');
                    return;
                }
                errorDiv.classList.add('hidden');
                try {
                    const docRef = await addDoc(collection(db, 'suppliers'), { name: newName, cuit: newCuit });
                    showToast('Proveedor agregado con éxito.', 'success');
                    newlyAddedSupplierId = docRef.id;
                    addSupplierModal.classList.add('hidden');
                    addSupplierModal.style.display = 'none';
                    addSupplierForm.reset();
                } catch (error) {
                    console.error("Error al agregar proveedor:", error);
                    showToast('Error al guardar el proveedor.', 'error');
                }
            });
            
            const handleFormDisplay = () => {
                const selectedType = typeSelect.value;
                const purchaseSupplierSelect = page.querySelector('#purchase-supplier');
                if (selectedType === 'purchase') {
                    purchaseFields.style.display = 'block';
                    saleFields.style.display = 'none';
                    purchaseSupplierSelect.required = true;
                } else {
                    purchaseFields.style.display = 'none';
                    saleFields.style.display = 'block';
                    purchaseSupplierSelect.required = false;
                }
            };
            
            typeSelect.addEventListener('change', handleFormDisplay);
            
            function listenForFinancialTransactions() {
                if (!auth.currentUser) return;
                if (unsubscribeFinancial) unsubscribeFinancial();
                const q = query(collection(db, "financial_transactions"), orderBy("createdAt", "desc"));
                unsubscribeFinancial = onSnapshot(q, (snapshot) => {
                    allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    applyFiltersAndRender();
                    updateAllCharts(allTransactions);
                    updateAllMonthlyAnalyses(allTransactions);
                    // --- NUEVO: Actualizar nuevas vistas ---
                    populateMonthSelector(allTransactions);
                    updateMonthlyView();
                    updateDailyDifference();
                }, (error) => {
                    console.error("Error al escuchar transacciones financieras:", error);
                    showToast("Error al cargar las transacciones.", "error");
                });
            }

            function renderTransactions(transactions) {
                transactionList.innerHTML = '';
                if (transactions.length === 0) {
                    transactionList.innerHTML = '<tr><td colspan="7" class="text-center py-4">No hay transacciones que coincidan con los filtros.</td></tr>';
                    return;
                }
                transactions.forEach(t => {
                    const row = document.createElement('tr');
                    const details = t.type === 'purchase' 
                        ? `Método: ${t.paymentMethod || 'N/A'}` 
                        : `Canal: ${t.saleType || 'N/A'}`;
                    row.className = t.type === 'sale' ? 'bg-green-50' : 'bg-red-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${t.type === 'sale' ? 'text-green-600' : 'text-red-600'}">${t.type.charAt(0).toUpperCase() + t.type.slice(1)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.partyName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.partyCuit || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${details}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${formatCurrency(t.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button data-id="${t.id}" class="text-indigo-600 hover:text-indigo-900 edit-btn">Editar</button>
                            <button data-id="${t.id}" class="text-red-600 hover:text-red-900 delete-btn">Eliminar</button>
                        </td>`;
                    transactionList.appendChild(row);
                });
            }

            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorMessageDiv.classList.add('hidden');
                const type = page.querySelector('#type').value;
                let newTransaction = {
                    date: page.querySelector('#date').value,
                    type: type,
                    createdAt: serverTimestamp()
                };
                if (type === 'purchase') {
                    const selectedSupplierId = supplierSelect.value;
                    const amount = parseFloat(page.querySelector('#purchase-amount').value);
                    if (!selectedSupplierId) {
                        errorMessageDiv.textContent = "Debe seleccionar un proveedor.";
                        errorMessageDiv.classList.remove('hidden');
                        return;
                    }
                    if (isNaN(amount) || amount <= 0) {
                        errorMessageDiv.textContent = "El importe es obligatorio.";
                        errorMessageDiv.classList.remove('hidden');
                        return;
                    }
                    const supplierData = allSuppliers.find(s => s.id === selectedSupplierId);
                    const paymentMethod = page.querySelector('#purchase-paymentMethod').value;
                    newTransaction.paymentMethod = paymentMethod;
                    if (paymentMethod === 'Cheque' || paymentMethod === 'Cuenta Corriente') {
                        const dueDate = page.querySelector('#due-date').value;
                        if (!dueDate) {
                            errorMessageDiv.textContent = "Debe especificar la fecha de pago/vencimiento.";
                            errorMessageDiv.classList.remove('hidden');
                            return;
                        }
                        newTransaction.dueDate = dueDate;
                    }
                    newTransaction.partyName = supplierData.name;
                    newTransaction.partyCuit = supplierData.cuit;
                    newTransaction.amount = amount;
                } else { // Venta
                    const partyName = page.querySelector('#sale-customerName').value.trim();
                    const amount = parseFloat(page.querySelector('#sale-amount').value);
                    if (!partyName || isNaN(amount) || amount <= 0) {
                        errorMessageDiv.textContent = "El nombre del cliente y el importe son obligatorios.";
                        errorMessageDiv.classList.remove('hidden');
                        return;
                    }
                    newTransaction.partyName = partyName;
                    newTransaction.partyCuit = page.querySelector('#sale-cuit').value.trim();
                    newTransaction.saleType = page.querySelector('#sale-type').value;
                    newTransaction.amount = amount;
                }
                try {
                    await addDoc(collection(db, 'financial_transactions'), newTransaction);
                    showToast("Transacción agregada con éxito.", "success");
                    transactionForm.reset();
                    page.querySelector('#date').valueAsDate = new Date();
                    handleFormDisplay();
                    handleSupplierChange();
                } catch (err) {
                    console.error("Error al agregar transacción:", err);
                    showToast("Error al guardar la transacción.", "error");
                }
            });

            transactionList.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;

                if (target.classList.contains('edit-btn')) {
                    const t = allTransactions.find(trans => trans.id === id);
                    if (t) {
                        editModal.querySelector('#edit-id').value = t.id;
                        editModal.querySelector('#edit-transaction-type').value = t.type;
                        const editPurchaseFields = editModal.querySelector('#edit-purchase-fields');
                        const editSaleFields = editModal.querySelector('#edit-sale-fields');
                        if (t.type === 'purchase') {
                            editSaleFields.classList.add('hidden');
                            editPurchaseFields.classList.remove('hidden');
                            editModal.querySelector('#edit-purchase-supplierName').value = t.partyName;
                            editModal.querySelector('#edit-purchase-cuit').value = t.partyCuit;
                            editModal.querySelector('#edit-purchase-paymentMethod').value = t.paymentMethod;
                            editModal.querySelector('#edit-purchase-amount').value = t.amount;
                        } else {
                            editPurchaseFields.classList.add('hidden');
                            editSaleFields.classList.remove('hidden');
                            editModal.querySelector('#edit-sale-customerName').value = t.partyName;
                            editModal.querySelector('#edit-sale-cuit').value = t.partyCuit;
                            editModal.querySelector('#edit-sale-type').value = t.saleType;
                            editModal.querySelector('#edit-sale-amount').value = t.amount;
                        }
                        editModal.classList.remove('hidden');
                        editModal.style.display = 'flex';
                    }
                } else if (target.classList.contains('delete-btn')) {
                    if (confirm("¿Estás seguro de que quieres eliminar esta transacción?")) {
                        try {
                            await deleteDoc(doc(db, "financial_transactions", id));
                            showToast("Transacción eliminada.", "success");
                        } catch (err) {
                            console.error("Error al eliminar transacción:", err);
                            showToast("No se pudo eliminar la transacción.", "error");
                        }
                    }
                }
            });

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = editModal.querySelector('#edit-id').value;
                const type = editModal.querySelector('#edit-transaction-type').value;
                let updatedData = {};
                if(type === 'purchase') {
                    updatedData = {
                        partyName: editModal.querySelector('#edit-purchase-supplierName').value,
                        partyCuit: editModal.querySelector('#edit-purchase-cuit').value,
                        paymentMethod: editModal.querySelector('#edit-purchase-paymentMethod').value,
                        amount: parseFloat(editModal.querySelector('#edit-purchase-amount').value)
                    };
                } else {
                     updatedData = {
                        partyName: editModal.querySelector('#edit-sale-customerName').value,
                        partyCuit: editModal.querySelector('#edit-sale-cuit').value,
                        saleType: editModal.querySelector('#edit-sale-type').value,
                        amount: parseFloat(editModal.querySelector('#edit-sale-amount').value)
                    };
                }
                try {
                    const transactionRef = doc(db, "financial_transactions", id);
                    await updateDoc(transactionRef, updatedData);
                    showToast("Transacción actualizada.", "success");
                    editModal.classList.add('hidden');
                    editModal.style.display = 'none';
                } catch (err) {
                    console.error("Error al actualizar la transacción:", err);
                    showToast("No se pudieron guardar los cambios.", "error");
                }
            });

            cancelEditBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
                editModal.style.display = 'none';
            });
            
            function setupCharts() {
                const tooltipCallbacks = {
                    callbacks: {
                        label: (context) => `${context.dataset.label || ''}: ${formatCurrency(context.parsed.y)}`,
                        footer: (tooltipItems) => {
                            const item = tooltipItems[0];
                            const date = item.label;
                            const datasetIndex = item.datasetIndex;
                            let footerLines = [];
                            if (datasetIndex === 2 || datasetIndex === 3) {
                                const sourceData = datasetIndex === 2 ? detailedCheques : detailedCtaCte;
                                const detailsForDate = sourceData.filter(t => t.dueDate === date);
                                if (detailsForDate.length > 0) {
                                    footerLines.push('');
                                    detailsForDate.slice(0, 5).forEach(t => { // Limitar a 5 para no saturar
                                        footerLines.push(`- ${t.partyName}: ${formatCurrency(t.amount)}`);
                                    });
                                    if (detailsForDate.length > 5) {
                                        footerLines.push(`...y ${detailsForDate.length - 5} más`);
                                    }
                                }
                            }
                            return footerLines;
                        }
                    }
                };

                if (lineChart) lineChart.destroy();
                lineChart = new Chart(lineCtx, {
                    type: 'line',
                    data: { labels: [], datasets: [
                        { label: 'Ventas', data: [], borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', tension: 0.1, fill: true },
                        { label: 'Compras', data: [], borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', tension: 0.1, fill: true },
                        { type: 'bar', label: 'Cheques Pendientes', data: [], borderColor: 'rgba(255, 206, 86, 1)', backgroundColor: 'rgba(255, 206, 86, 0.6)', borderWidth: 1 },
                        { type: 'bar', label: 'Cta. Cte. a Pagar', data: [], borderColor: 'rgba(255, 159, 64, 1)', backgroundColor: 'rgba(255, 159, 64, 0.6)', borderWidth: 1 },
                        { type: 'line', label: 'Ventas Promedio', data: [], borderColor: 'rgba(138, 43, 226, 1)', backgroundColor: 'rgba(138, 43, 226, 0.2)', tension: 0.1, fill: false, borderDash: [5, 5] },
                        { label: 'Tendencia de Ventas', data: [], borderColor: 'rgba(255, 99, 71, 1)', type: 'line', fill: false, borderWidth: 2, pointRadius: 0 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Fecha' } }, y: { title: { display: true, text: 'Monto' }, beginAtZero: true } }, plugins: { legend: { position: 'top' }, tooltip: tooltipCallbacks } }
                });
                
                if (monthlyChart) monthlyChart.destroy();
                monthlyChart = new Chart(monthlyCtx, {
                    type: 'line',
                    data: { labels: [], datasets: [
                        { label: 'Ventas', data: [], borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', tension: 0.1, fill: true },
                        { label: 'Compras', data: [], borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', tension: 0.1, fill: true },
                        { type: 'bar', label: 'Cheques Pendientes', data: [], borderColor: 'rgba(255, 206, 86, 1)', backgroundColor: 'rgba(255, 206, 86, 0.6)', borderWidth: 1 },
                        { type: 'bar', label: 'Cta. Cte. a Pagar', data: [], borderColor: 'rgba(255, 159, 64, 1)', backgroundColor: 'rgba(255, 159, 64, 0.6)', borderWidth: 1 },
                        { type: 'line', label: 'Ventas Promedio', data: [], borderColor: 'rgba(138, 43, 226, 1)', backgroundColor: 'rgba(138, 43, 226, 0.2)', tension: 0.1, fill: false, borderDash: [5, 5] },
                        { label: 'Tendencia de Ventas', data: [], borderColor: 'rgba(255, 99, 71, 1)', type: 'line', fill: false, borderWidth: 2, pointRadius: 0 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Día del Mes' } }, y: { title: { display: true, text: 'Monto' }, beginAtZero: true } }, plugins: { legend: { position: 'top' }, tooltip: tooltipCallbacks } }
                });

                if (supplierPieChart) supplierPieChart.destroy();
                supplierPieChart = new Chart(supplierPieCtx, { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: [], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (context) => { const label = context.label || ''; const value = context.raw; const total = context.chart.getDatasetMeta(0).total; const percentage = total > 0 ? ((value / total) * 100).toFixed(2) + '%' : '0.00%'; return `${label}: ${formatCurrency(value)} (${percentage})`; }}}}}});
                
                if (paymentPieChart) paymentPieChart.destroy();
                paymentPieChart = new Chart(paymentPieCtx, { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: [], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (context) => { const label = context.label || ''; const value = context.raw; const total = context.chart.getDatasetMeta(0).total; const percentage = total > 0 ? ((value / total) * 100).toFixed(2) + '%' : '0.00%'; return `${label}: ${formatCurrency(value)} (${percentage})`; }}}}}});
            }

            function updateAllCharts(transactions) {
                detailedCheques = transactions.filter(t => t.paymentMethod === 'Cheque' && t.dueDate);
                const pendingChequesData = {};
                detailedCheques.forEach(t => {
                    pendingChequesData[t.dueDate] = (pendingChequesData[t.dueDate] || 0) + t.amount;
                });

                detailedCtaCte = transactions.filter(t => t.paymentMethod === 'Cuenta Corriente' && t.dueDate);
                const pendingCtaCteData = {};
                detailedCtaCte.forEach(t => {
                    pendingCtaCteData[t.dueDate] = (pendingCtaCteData[t.dueDate] || 0) + t.amount;
                });
                
                const sortedByDate = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
                const transactionDates = sortedByDate.map(t => t.date);
                const chequeDueDates = Object.keys(pendingChequesData);
                const ctaCteDueDates = Object.keys(pendingCtaCteData);
                const allDates = [...new Set([...transactionDates, ...chequeDueDates, ...ctaCteDueDates])].sort();

                const salesData = {};
                const purchasesData = {};
                sortedByDate.forEach(t => {
                    if (t.type === 'sale') {
                        salesData[t.date] = (salesData[t.date] || 0) + t.amount;
                    } else {
                        purchasesData[t.date] = (purchasesData[t.date] || 0) + t.amount;
                    }
                });
                
                const globalSalesData = allDates.map(date => salesData[date] || 0);
                const globalTrendlineData = calculateLinearRegression(globalSalesData);

                lineChart.data.labels = allDates;
                lineChart.data.datasets[0].data = globalSalesData;
                lineChart.data.datasets[1].data = allDates.map(date => purchasesData[date] || 0);
                lineChart.data.datasets[2].data = allDates.map(date => pendingChequesData[date] || 0);
                lineChart.data.datasets[3].data = allDates.map(date => pendingCtaCteData[date] || 0);

                const salesValues = Object.values(salesData).filter(amount => amount > 0);
                const averageSale = salesValues.length > 0 ? salesValues.reduce((sum, amount) => sum + amount, 0) / salesValues.length : 0;
                lineChart.data.datasets[4].data = allDates.map(() => averageSale);
                lineChart.data.datasets[5].data = globalTrendlineData;

                lineChart.update();

                const purchases = transactions.filter(t => t.type === 'purchase');
                const supplierSpending = {};
                purchases.forEach(t => { supplierSpending[t.partyName] = (supplierSpending[t.partyName] || 0) + t.amount; });
                updatePieChart(supplierPieChart, supplierSpending);
                const paymentMethodSpending = {};
                purchases.forEach(t => { if (t.paymentMethod) { paymentMethodSpending[t.paymentMethod] = (paymentMethodSpending[t.paymentMethod] || 0) + t.amount; }});
                updatePieChart(paymentPieChart, paymentMethodSpending);
            }
            
            // --- NUEVO: Funciones para vistas diaria y mensual ---
            function updateDailyDifference() {
                const selectedDate = daySelector.value;
                if (!selectedDate || allTransactions.length === 0) {
                    dailyDifferenceDisplay.textContent = '-';
                    dailyDifferenceDisplay.className = 'text-3xl font-bold';
                    return;
                }

                const totalSales = allTransactions
                    .filter(t => t.type === 'sale' && t.date === selectedDate)
                    .reduce((sum, t) => sum + t.amount, 0);

                const totalPurchases = allTransactions
                    .filter(t => t.type === 'purchase' && t.date === selectedDate)
                    .reduce((sum, t) => sum + t.amount, 0);

                const difference = totalSales - totalPurchases;
                
                dailyDifferenceDisplay.textContent = formatCurrency(difference);
                if (difference >= 0) {
                    dailyDifferenceDisplay.className = 'text-3xl font-bold text-green-600';
                } else {
                    dailyDifferenceDisplay.className = 'text-3xl font-bold text-red-600';
                }
            }
            
            function populateMonthSelector(transactions) {
                const months = [...new Set(transactions.map(t => t.date.substring(0, 7)))].sort().reverse();
                monthSelector.innerHTML = '';
                months.forEach(month => {
                    const [year, m] = month.split('-');
                    const date = new Date(year, m - 1, 1);
                    const monthName = date.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                    monthSelector.appendChild(option);
                });
            }

            function updateMonthlyView() {
                const selectedMonth = monthSelector.value;
                if (!selectedMonth || allTransactions.length === 0) return;

                const monthlyTransactions = allTransactions.filter(t => t.date.startsWith(selectedMonth));
                
                const detailedChequesMonth = monthlyTransactions.filter(t => t.paymentMethod === 'Cheque' && t.dueDate);
                const pendingChequesData = {};
                detailedChequesMonth.forEach(t => { pendingChequesData[t.dueDate] = (pendingChequesData[t.dueDate] || 0) + t.amount; });

                const detailedCtaCteMonth = monthlyTransactions.filter(t => t.paymentMethod === 'Cuenta Corriente' && t.dueDate);
                const pendingCtaCteData = {};
                detailedCtaCteMonth.forEach(t => { pendingCtaCteData[t.dueDate] = (pendingCtaCteData[t.dueDate] || 0) + t.amount; });

                const daysInMonth = new Date(selectedMonth.split('-')[0], selectedMonth.split('-')[1], 0).getDate();
                const allDates = Array.from({ length: daysInMonth }, (_, i) => `${selectedMonth}-${String(i + 1).padStart(2, '0')}`);
                
                const salesData = {};
                const purchasesData = {};
                monthlyTransactions.forEach(t => {
                    if (t.type === 'sale') salesData[t.date] = (salesData[t.date] || 0) + t.amount;
                    else purchasesData[t.date] = (purchasesData[t.date] || 0) + t.amount;
                });
                
                const monthlySalesData = allDates.map(date => salesData[date] || 0);
                const monthlyTrendlineData = calculateLinearRegression(monthlySalesData);

                monthlyChart.data.labels = allDates.map(d => d.split('-')[2]); // Solo el día
                monthlyChart.data.datasets[0].data = monthlySalesData;
                monthlyChart.data.datasets[1].data = allDates.map(date => purchasesData[date] || 0);
                monthlyChart.data.datasets[2].data = allDates.map(date => pendingChequesData[date] || 0);
                monthlyChart.data.datasets[3].data = allDates.map(date => pendingCtaCteData[date] || 0);

                const monthlySalesValues = Object.values(salesData).filter(amount => amount > 0);
                const averageSaleInMonth = monthlySalesValues.length > 0 ? monthlySalesValues.reduce((sum, amount) => sum + amount, 0) / monthlySalesValues.length : 0;
                monthlyChart.data.datasets[4].data = allDates.map(() => averageSaleInMonth);
                monthlyChart.data.datasets[5].data = monthlyTrendlineData;
                
                monthlyChart.update();
            }

            function updatePieChart(chart, dataMap) {
                chart.data.labels = Object.keys(dataMap);
                chart.data.datasets[0].data = Object.values(dataMap);
                chart.data.datasets[0].backgroundColor = generateColors(Object.keys(dataMap).length);
                chart.update();
            }
            
            function updateAllMonthlyAnalyses(transactions) {
                const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))].sort((a, b) => b - a);
                const currentYearSelection = yearSelector.value;
                yearSelector.innerHTML = '';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelector.appendChild(option);
                });
                if (currentYearSelection && years.includes(parseInt(currentYearSelection))) {
                    yearSelector.value = currentYearSelection;
                } else if (years.length > 0) {
                    yearSelector.value = years[0];
                }
                renderMonthlyPurchasesBreakdown(transactions);
                renderMonthlySalesBreakdown(transactions);
            }

            function renderMonthlyPurchasesBreakdown(transactions) {
                const selectedYear = parseInt(yearSelector.value);
                monthlyPurchasesBreakdownContainer.innerHTML = '';
                if (isNaN(selectedYear)) return;
                const purchases = transactions.filter(t => t.type === 'purchase' && new Date(t.date).getFullYear() === selectedYear);
                const byMonth = purchases.reduce((acc, t) => {
                    const month = new Date(t.date).getMonth();
                    if (!acc[month]) acc[month] = [];
                    acc[month].push(t);
                    return acc;
                }, {});
                let content = '';
                for (let i = 11; i >= 0; i--) {
                    if (byMonth[i]) {
                        const monthTransactions = byMonth[i];
                        const totalMonthAmount = monthTransactions.reduce((sum, t) => sum + t.amount, 0);
                        const bySupplier = monthTransactions.reduce((acc, t) => {
                            if (!acc[t.partyName]) acc[t.partyName] = 0;
                            acc[t.partyName] += t.amount;
                            return acc;
                        }, {});
                        const sortedSuppliers = Object.entries(bySupplier).sort(([, a], [, b]) => b - a);
                        const monthName = new Date(selectedYear, i).toLocaleString('es-ES', { month: 'long' });
                        let suppliersHTML = sortedSuppliers.map(([name, total]) => {
                            const percentage = (total / totalMonthAmount) * 100;
                            return `
                                <li class="py-2">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-700">${name}</span>
                                        <span class="text-sm font-semibold text-gray-900">${formatCurrency(total)}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percentage.toFixed(2)}%"></div>
                                    </div>
                                    <div class="text-right text-xs text-gray-500 mt-1">${percentage.toFixed(2)}%</div>
                                </li>`;
                        }).join('');
                        content += `
                            <div class="bg-gray-50 p-4 rounded-lg border mb-4">
                                <h4 class="font-bold text-lg capitalize text-primary">${monthName} ${selectedYear}</h4>
                                <p class="text-sm text-secondary mb-3">Total Compras: ${formatCurrency(totalMonthAmount)}</p>
                                <ul class="space-y-2">${suppliersHTML}</ul>
                            </div>`;
                    }
                }
                monthlyPurchasesBreakdownContainer.innerHTML = content || `<p class="text-secondary text-center">No hay datos de compras para el año ${selectedYear}.</p>`;
            }

            function renderMonthlySalesBreakdown(transactions) {
                const selectedYear = parseInt(yearSelector.value);
                monthlySalesBreakdownContainer.innerHTML = '';
                if (isNaN(selectedYear)) return;
                const sales = transactions.filter(t => t.type === 'sale' && new Date(t.date).getFullYear() === selectedYear);
                const byMonth = sales.reduce((acc, t) => {
                    const month = new Date(t.date).getMonth();
                    if (!acc[month]) acc[month] = [];
                    acc[month].push(t);
                    return acc;
                }, {});
                let content = '';
                for (let i = 11; i >= 0; i--) {
                    if (byMonth[i]) {
                        const monthTransactions = byMonth[i];
                        const totalMonthAmount = monthTransactions.reduce((sum, t) => sum + t.amount, 0);
                        const byChannel = monthTransactions.reduce((acc, t) => {
                            const channel = t.saleType || 'No especificado';
                            if (!acc[channel]) acc[channel] = 0;
                            acc[channel] += t.amount;
                            return acc;
                        }, {});
                        const sortedChannels = Object.entries(byChannel).sort(([, a], [, b]) => b - a);
                        const monthName = new Date(selectedYear, i).toLocaleString('es-ES', { month: 'long' });
                        let channelsHTML = sortedChannels.map(([name, total]) => {
                            const percentage = (total / totalMonthAmount) * 100;
                            return `
                                <li class="py-2">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-700">${name}</span>
                                        <span class="text-sm font-semibold text-gray-900">${formatCurrency(total)}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-green-500 h-2.5 rounded-full" style="width: ${percentage.toFixed(2)}%"></div>
                                    </div>
                                    <div class="text-right text-xs text-gray-500 mt-1">${percentage.toFixed(2)}%</div>
                                </li>`;
                        }).join('');
                        content += `
                            <div class="bg-gray-50 p-4 rounded-lg border mb-4">
                                <h4 class="font-bold text-lg capitalize text-primary">${monthName} ${selectedYear}</h4>
                                <p class="text-sm text-secondary mb-3">Total Ventas: ${formatCurrency(totalMonthAmount)}</p>
                                <ul class="space-y-2">${channelsHTML}</ul>
                            </div>`;
                    }
                }
                monthlySalesBreakdownContainer.innerHTML = content || `<p class="text-secondary text-center">No hay datos de ventas para el año ${selectedYear}.</p>`;
            }
            
            yearSelector.addEventListener('change', () => updateAllMonthlyAnalyses(allTransactions));
            filterStartDate.addEventListener('change', applyFiltersAndRender);
            filterEndDate.addEventListener('change', applyFiltersAndRender);
            filterName.addEventListener('input', applyFiltersAndRender);
            clearFiltersBtn.addEventListener('click', () => {
                filterStartDate.value = '';
                filterEndDate.value = '';
                filterName.value = '';
                applyFiltersAndRender();
            });
            // --- NUEVO: Listeners para nuevas vistas ---
            daySelector.addEventListener('change', updateDailyDifference);
            monthSelector.addEventListener('change', updateMonthlyView);

            function generateColors(numColors) { const colors = []; for (let i = 0; i < numColors; i++) { colors.push(`hsl(${(i * 137.508) % 360}, 65%, 60%)`); } return colors; }

            page.querySelector('#date').valueAsDate = new Date();
            setupCharts();
            listenForFinancialTransactions();
            listenForSuppliersInDashboard();
            handleFormDisplay();
        }
        
        // --- LÓGICA DE GESTIÓN DE PROVEEDORES ---
        function initializeSupplierManagement() {
            const page = document.getElementById('supplier-management-page');
            if (!page) return;

            const searchInput = page.querySelector('#search-supplier-input');
            const tbody = page.querySelector('#supplier-list-tbody');
            const editModal = document.getElementById('edit-supplier-modal');
            const editForm = document.getElementById('edit-supplier-form');
            
            function listenForSuppliersInManagement() {
                if (!auth.currentUser) return;
                if (unsubscribeSuppliers) unsubscribeSuppliers();
                
                const q = query(collection(db, "suppliers"), orderBy("name"));
                unsubscribeSuppliers = onSnapshot(q, (snapshot) => {
                    allSuppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSupplierList();
                }, (error) => console.error("Error al escuchar proveedores:", error));
            }

            function renderSupplierList() {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredSuppliers = allSuppliers.filter(s => s.name.toLowerCase().includes(searchTerm) || s.cuit.toLowerCase().includes(searchTerm));
                
                tbody.innerHTML = '';
                if (filteredSuppliers.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-secondary">No se encontraron proveedores.</td></tr>`;
                    return;
                }

                filteredSuppliers.forEach(supplier => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-custom last:border-none hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="p-4 font-semibold text-primary">${supplier.name}</td>
                        <td class="p-4 text-secondary">${supplier.cuit}</td>
                        <td class="p-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button data-id="${supplier.id}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg edit-supplier-btn"><i class="fas fa-pencil-alt"></i></button>
                                <button data-id="${supplier.id}" data-name="${supplier.name}" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg delete-supplier-btn"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            tbody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-supplier-btn');
                const deleteBtn = e.target.closest('.delete-supplier-btn');

                if (editBtn) {
                    const supplierId = editBtn.dataset.id;
                    const supplier = allSuppliers.find(s => s.id === supplierId);
                    if (supplier) openEditSupplierModal(supplier);
                }

                if (deleteBtn) {
                    const supplierId = deleteBtn.dataset.id;
                    const supplierName = deleteBtn.dataset.name;
                    openDeleteModal('supplier', supplierId, supplierName);
                }
            });

            function openEditSupplierModal(supplier) {
                editForm.querySelector('#edit-supplier-id').value = supplier.id;
                editForm.querySelector('#edit-supplier-name').value = supplier.name;
                editForm.querySelector('#edit-supplier-cuit').value = supplier.cuit;
                editForm.querySelector('#edit-supplier-error').classList.add('hidden');
                editModal.style.display = 'flex';
            }

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = editForm.querySelector('#edit-supplier-id').value;
                const newName = editForm.querySelector('#edit-supplier-name').value.trim();
                const newCuit = editForm.querySelector('#edit-supplier-cuit').value.trim();
                const errorDiv = editForm.querySelector('#edit-supplier-error');

                if (!newName || !newCuit) {
                    errorDiv.textContent = 'Nombre y CUIT son obligatorios.';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                const nameExists = allSuppliers.some(s => s.id !== id && s.name.toLowerCase() === newName.toLowerCase());
                if (nameExists) {
                    errorDiv.textContent = `El proveedor "${newName}" ya existe.`;
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                const cuitExists = allSuppliers.some(s => s.id !== id && s.cuit === newCuit);
                if (cuitExists) {
                    errorDiv.textContent = `El CUIT ${newCuit} ya está registrado.`;
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                errorDiv.classList.add('hidden');

                try {
                    const supplierRef = doc(db, 'suppliers', id);
                    await updateDoc(supplierRef, { name: newName, cuit: newCuit });
                    showToast('Proveedor actualizado con éxito.', 'success');
                    editModal.style.display = 'none';
                } catch (error) {
                    console.error('Error updating supplier:', error);
                    showToast('Error al actualizar el proveedor.', 'error');
                }
            });

            searchInput.addEventListener('input', renderSupplierList);
            listenForSuppliersInManagement();
        }

        // --- LÓGICA DE ELIMINACIÓN GENERAL ---
        function openDeleteModal(type, id, name) {
            itemToDelete = { type, id, name };
            const modal = document.getElementById('delete-modal');
            const text = modal.querySelector('#delete-modal-text');
            text.textContent = `¿Estás seguro de que quieres eliminar a ${name}? Esta acción no se puede deshacer.`;
            modal.style.display = 'flex';
        }

        async function handleConfirmDelete() {
            if (!itemToDelete) return;

            const { type, id, name } = itemToDelete;
            let docRef;

            if (type === 'client') {
                docRef = doc(db, "customers", id);
                try {
                    const movementsRef = collection(docRef, "movements");
                    const movementsSnapshot = await getDocs(movementsRef);
                    for (const movementDoc of movementsSnapshot.docs) { await deleteDoc(movementDoc.ref); }
                    await deleteDoc(docRef);
                    showToast(`Cliente "${name}" eliminado.`, "success");
                } catch (error) { showToast("Error al eliminar el cliente.", "error"); }
            } else if (type === 'supplier') {
                docRef = doc(db, "suppliers", id);
                 try {
                    await deleteDoc(docRef);
                    showToast(`Proveedor "${name}" eliminado.`, "success");
                } catch (error) { showToast("Error al eliminar el proveedor.", "error"); }
            }
            
            document.getElementById('delete-modal').style.display = 'none';
            itemToDelete = null;
        }


        // --- FUNCIONES DE UTILIDAD ---
        const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value || 0);
        const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleString('es-AR') : 'N/A';
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast show ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }

        function calculateLinearRegression(data) {
            const n = data.length;
            if (n < 2) return []; // No se puede calcular tendencia con menos de 2 puntos

            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            data.forEach((y, i) => {
                const x = i;
                sumX += x;
                sumY += y;
                sumXY += x * y;
                sumXX += x * x;
            });

            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // Devuelve los valores Y para la línea de tendencia
            return data.map((_, i) => slope * i + intercept);
        }

    </script>
</body>
</html>