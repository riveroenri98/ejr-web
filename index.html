<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fidelidad - EJR.com.ar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Estilos Generales del Sitio */
        body {
            font-family: 'Lato', sans-serif;
            background-color: #F9F7F5;
            color: #5A5751;
        }
        .text-primary { color: #5A5751; }
        .text-secondary { color: #7d7a75; }
        .bg-primary { background-color: #5A5751; }
        .bg-primary-hover:hover { background-color: #4a4742; }
        .border-custom { border-color: #CCC3BA; }
        .ring-custom:focus { 
            --tw-ring-color: #5A5751;
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }
        .card-custom {
            background-color: #FFFFFF;
            border-color: #EAE6E1;
        }
        .icon-primary { color: #5A5751; }

        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 50; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 90%; max-width: 500px; }
        .modal-show { display: flex; }

        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 700; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); transition: bottom 0.5s ease-in-out; z-index: 100; }
        .toast.show { bottom: 20px; }
        
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-confirmed { background-color: #d1fae5; color: #065f46; }
        .status-declined { background-color: #fee2e2; color: #991b1b; }
        
        .star-icon { color: #facc15; }

        /* Estilos Específicos del Juego 1 */
        #game-1-page .game-container { font-family: 'Nunito', sans-serif; width: 100%; max-width: 800px; text-align: center; margin: 0 auto; }
        #game-1-page .game-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; perspective: 1000px; }
        #game-1-page .card { width: 100%; aspect-ratio: 1 / 1; position: relative; cursor: pointer; transform-style: preserve-3d; transition: transform 0.6s; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #game-1-page .card.is-flipped { transform: rotateY(180deg); }
        #game-1-page .card.is-matched { opacity: 0.5; cursor: default; }
        #game-1-page .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; justify-content: center; align-items: center; border-radius: 15px; overflow: hidden; }
        #game-1-page .card-face--front { background-color: #ffffff; border: 3px solid #b0c4de; }
        #game-1-page .card-face--front svg { width: 50%; height: 50%; color: #4682b4; }
        #game-1-page .card-face--back { background-color: #f0f8ff; transform: rotateY(180deg); padding: 10px; box-sizing: border-box; }
        #game-1-page .card-face--back svg { width: 80%; height: 80%; }
        #game-1-page .game-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        #game-1-page .game-modal-overlay.is-visible { opacity: 1; visibility: visible; }
        #game-1-page .game-modal-content { background-color: white; padding: 30px; border-radius: 15px; text-align: center; width: 90%; max-width: 500px; transform: scale(0.9); transition: transform 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #game-1-page .game-modal-overlay.is-visible .game-modal-content { transform: scale(1); }
        #game-1-page .modal-monster { width: 100px; height: 100px; margin: 0 auto 20px; }
        #game-1-page .modal-question { font-size: clamp(1.1rem, 4vw, 1.4rem); margin-bottom: 25px; line-height: 1.5; }
        #game-1-page .modal-choices { display: flex; flex-direction: column; gap: 10px; }
        #game-1-page .game-button { background-color: #4682b4; color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        #game-1-page .game-button:hover { background-color: #5a9bd8; transform: translateY(-2px); }
        #game-1-page .controls { margin-top: 30px; }

        /* Estilos Específicos del Juego 2 */
        #game-2-page .game-container { font-family: 'Nunito', sans-serif; width: 100%; max-width: 600px; background-color: #ffffff; border-radius: 20px; padding: clamp(20px, 5vw, 40px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s ease; border: 3px solid #fff; margin: 0 auto; }
        #game-2-page h1 { font-weight: 900; font-size: clamp(2rem, 6vw, 2.8rem); color: #ff6347; margin-top: 0; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        #game-2-page .scenario-card { margin-bottom: 30px; }
        #game-2-page .scenario-image { width: 160px; height: 160px; margin: 0 auto 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 6px solid #4682b4; background-color: #f0f8ff; overflow: hidden; }
        #game-2-page .scenario-image img { width: 100%; height: 100%; object-fit: cover; }
        #game-2-page .scenario-text { font-size: clamp(1.1rem, 4vw, 1.4rem); line-height: 1.6; min-height: 80px; color: #2c3e50; }
        #game-2-page .choices-container { display: flex; flex-direction: column; gap: 15px; }
        #game-2-page .choice-btn { background-color: #4682b4; color: white; border: none; padding: 15px 20px; border-radius: 15px; font-size: clamp(1rem, 3vw, 1.1rem); font-weight: 700; cursor: pointer; transition: all 0.3s; text-align: left; display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #game-2-page .choice-btn:hover { background-color: #5a9bd8; transform: translateY(-4px) scale(1.02); box-shadow: 0 8px 12px rgba(0,0,0,0.15); }
        #game-2-page .choice-btn .icon { flex-shrink: 0; font-size: 1.2em; }
        #game-2-page .game-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        #game-2-page .game-modal-overlay.is-visible { opacity: 1; visibility: visible; }
        #game-2-page .game-modal-content { background-color: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 500px; transform: scale(0.9); transition: transform 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-top: 10px solid #32cd32; }
        #game-2-page .game-modal-overlay.is-visible .game-modal-content { transform: scale(1); }
        #game-2-page .outcome-text { font-size: clamp(1.1rem, 4vw, 1.3rem); margin-bottom: 25px; line-height: 1.5; }
        #game-2-page .next-btn { background-color: #32cd32; color: white; border: none; padding: 14px 35px; border-radius: 30px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        #game-2-page .next-btn:hover { background-color: #38d838; transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

        /* ESTILOS PARA EL DASHBOARD FINANCIERO */
        #financial-dashboard-page {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        #financial-dashboard-page .modal-overlay, #sales-analyzer-page .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }
        #financial-dashboard-page .modal-content, #sales-analyzer-page .modal-content {
            background-color: white; padding: 1.5rem; border-radius: 0.5rem;
            width: 90%; max-width: 500px;
        }
        #financial-dashboard-page .hidden, #sales-analyzer-page .hidden {
            display: none;
        }

        /* ESTILOS PARA EL ANALIZADOR DE VENTAS */
        #sales-analyzer-page #drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        #sales-analyzer-page #drop-zone.dragover {
            border-color: #2563eb;
            background-color: #eff6ff;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #sales-analyzer-page .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="antialiased">

    <div id="landing-page">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-black text-primary">EJR<span class="font-light">.com.ar</span></div>
                <div id="auth-nav-links" class="flex items-center gap-4">
                    </div>
            </nav>
        </header>
        <main>
            <section class="text-center py-20 sm:py-32 bg-white">
                <div class="container mx-auto px-6">
                    <h1 class="text-4xl md:text-6xl font-black text-primary leading-tight">C.P.N. Enrique Jose Rivero</h1>
                    <p class="mt-4 text-lg md:text-xl text-secondary max-w-3xl mx-auto">[Aquí puedes poner una breve descripción de tu negocio.]</p>
                    <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4 flex-wrap">
                        <button id="main-to-customers" class="w-full sm:w-auto px-8 py-4 bg-primary text-white font-bold rounded-lg bg-primary-hover transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                            Sistema de Clientes - SUPER21 <i class="fas fa-users"></i>
                        </button>
                        <button id="main-to-financial" class="w-full sm:w-auto px-8 py-4 bg-primary text-white font-bold rounded-lg bg-primary-hover transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                            Dashboard Financiero <i class="fas fa-chart-line"></i>
                        </button>
                        <button id="main-to-sales-analyzer" class="w-full sm:w-auto px-8 py-4 bg-primary text-white font-bold rounded-lg bg-primary-hover transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                            Analizador de Ventas <i class="fas fa-search-dollar"></i>
                        </button>
                        <button id="main-to-licenciada" class="w-full sm:w-auto px-8 py-4 bg-gray-700 text-white font-bold rounded-lg hover:bg-gray-800 transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                            Lic. Maria de los Milagros Garcia Olivera <i class="fas fa-brain"></i>
                        </button>
                        <a href="gestor.html" target="_blank" class="w-full sm:w-auto px-8 py-4 bg-primary text-white font-bold rounded-lg bg-primary-hover transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
    GESTION ENVIOS SUPER 21 <i class="fas fa-truck"></i>
</a>


<a href="controlventas.html" class="w-full sm:w-auto px-8 py-4 bg-primary text-white font-bold rounded-lg bg-primary-hover transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
    Sistema Control de Ventas <i class="fas fa-file-invoice-dollar"></i>
</a>
                    </div>
                </div>
            </section>
            <section class="py-20">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center text-primary mb-12">Nuestra Ubicación y Contacto</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                        <div class="card-custom border rounded-xl shadow-sm p-6 flex items-center gap-6"><i class="fas fa-map-marker-alt icon-primary text-4xl"></i><div><h3 class="text-xl font-bold text-primary">Dirección</h3><p class="text-secondary">[Tu Dirección, Ciudad, Provincia]</p></div></div>
                        <div class="card-custom border rounded-xl shadow-sm p-6 flex items-center gap-6"><i class="fas fa-phone icon-primary text-4xl"></i><div><h3 class="text-xl font-bold text-primary">Teléfono</h3><p class="text-secondary">[Tu Número de Teléfono]</p></div></div>
                    </div>
                </div>
            </section>
        </main>
        <footer class="bg-primary text-white py-6">
            <div class="container mx-auto px-6 text-center">
                <p class="text-gray-200">&copy; <span id="footer-year"></span> C.P.N. Enrique Jose Rivero. Todos los derechos reservados.</p>
                <p class="text-sm text-gray-400 mt-1">Powered by EJR.com.ar</p>
            </div>
        </footer>
    </div>
    
    <div id="login-page" style="display: none;" class="flex items-center justify-center min-h-screen">
        <div class="card-custom border rounded-xl shadow-lg w-full max-w-md mx-4">
            <div class="p-8 text-center">
                <h1 class="text-3xl font-black text-primary mb-2">Iniciar Sesión</h1>
                <p class="text-secondary mb-6">Acceso exclusivo para administradores.</p>
            </div>
            <div class="p-8 border-t border-custom">
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium mb-1 text-secondary">Correo Electrónico</label>
                        <input type="email" id="email" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium mb-1 text-secondary">Contraseña</label>
                        <input type="password" id="password" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                    <button type="submit" class="w-full bg-primary bg-primary-hover text-white font-bold rounded-lg py-3 flex items-center justify-center gap-2">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </form>
                <button id="back-to-home-from-login" class="w-full mt-4 bg-gray-200 text-gray-800 font-bold rounded-lg py-3 flex items-center justify-center gap-2 hover:bg-gray-300">
                    <i class="fas fa-arrow-left"></i> Volver al Inicio
                </button>
            </div>
        </div>
    </div>

    <div id="customer-system-page" style="display: none;">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-black text-primary">EJR<span class="font-light">.com.ar</span></div>
                <div class="flex items-center gap-4">
                    <button id="nav-to-home-from-customers" class="font-bold text-primary hover:opacity-70 transition-opacity">INICIO</button>
                    <button id="logout-btn-customers" class="font-bold text-red-500 hover:opacity-70 transition-opacity flex items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </nav>
        </header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <h1 class="text-4xl md:text-5xl font-black text-primary mb-10 text-center sm:text-left">Panel de Clientes - SUPER21</h1>
            <div class="card-custom border rounded-xl shadow-sm mb-8">
                <div class="p-6 border-b border-custom"><h2 class="text-xl font-bold flex items-center gap-3 text-primary"><i class="fas fa-user-plus"></i> Agregar Nuevo Cliente</h2></div>
                <div class="p-6">
                    <form id="add-client-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Nombre Completo</label><input id="new-client-name" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" placeholder="Ej: Juan Pérez" required /></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">DNI</label><input id="new-client-dni" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" placeholder="Ej: 30123456" required /></div>
                        <button type="submit" class="bg-primary bg-primary-hover text-white font-bold rounded-lg h-12 flex items-center justify-center gap-2"><i class="fas fa-user-plus"></i> Agregar Cliente</button>
                    </form>
                </div>
            </div>
            <div class="card-custom border rounded-xl shadow-sm">
                <div class="p-6 border-b border-custom">
                    <h2 class="text-xl font-bold text-primary">Lista de Clientes</h2>
                    <div class="relative mt-4">
                       <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                       <input id="search-client-input" placeholder="Buscar por nombre o DNI..." class="w-full p-3 pl-10 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                </div>
                <div class="p-0 overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-custom"><tr>
                            <th class="p-4 font-bold text-primary">Nombre</th><th class="p-4 font-bold text-primary">DNI</th><th class="p-4 font-bold text-primary">Saldo</th><th class="p-4 font-bold text-primary">Estrellas</th><th class="p-4 font-bold text-primary text-right">Acciones</th>
                        </tr></thead>
                        <tbody id="client-list-tbody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="supplier-management-page" style="display: none;">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-black text-primary">EJR<span class="font-light">.com.ar</span></div>
                <div class="flex items-center gap-4">
                    <button id="nav-to-home-from-suppliers" class="font-bold text-primary hover:opacity-70 transition-opacity">INICIO</button>
                    <button id="logout-btn-suppliers" class="font-bold text-red-500 hover:opacity-70 transition-opacity flex items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </nav>
        </header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <h1 class="text-4xl md:text-5xl font-black text-primary mb-10 text-center sm:text-left">Panel de Proveedores</h1>
            <div class="card-custom border rounded-xl shadow-sm">
                <div class="p-6 border-b border-custom">
                    <h2 class="text-xl font-bold text-primary">Lista de Proveedores</h2>
                    <div class="relative mt-4">
                       <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                       <input id="search-supplier-input" placeholder="Buscar por nombre o CUIT..." class="w-full p-3 pl-10 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                </div>
                <div class="p-0 overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-custom"><tr>
                            <th class="p-4 font-bold text-primary">Nombre</th>
                            <th class="p-4 font-bold text-primary">CUIT</th>
                            <th class="p-4 font-bold text-primary text-right">Acciones</th>
                        </tr></thead>
                        <tbody id="supplier-list-tbody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    <div id="licenciada-hub-page" style="display: none;">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-black text-primary">EJR<span class="font-light">.com.ar</span></div>
                <button id="nav-to-home-from-licenciada" class="font-bold text-primary hover:opacity-70 transition-opacity flex items-center gap-2">
                    <i class="fas fa-home"></i> Volver al Inicio
                </button>
            </nav>
        </header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8 text-center">
            <h1 class="text-4xl md:text-5xl font-black text-primary mb-4">Lic. Maria de los Milagros Garcia Olivera</h1>
            <p class="text-xl text-secondary mb-10">Selecciona una opción</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                <button id="go-to-appointments" class="card-custom border rounded-xl shadow-sm p-8 text-center hover:shadow-lg hover:-translate-y-1 transition-all">
                    <i class="fas fa-calendar-check text-5xl text-primary mb-4"></i>
                    <h2 class="text-2xl font-bold text-primary">Solicitar Turno</h2>
                </button>
                <button id="play-game-1" class="card-custom border rounded-xl shadow-sm p-8 text-center hover:shadow-lg hover:-translate-y-1 transition-all">
                    <i class="fas fa-gamepad text-5xl text-primary mb-4"></i>
                    <h2 class="text-2xl font-bold text-primary">Monstruos de Emociones</h2>
                </button>
                <button id="play-game-2" class="card-custom border rounded-xl shadow-sm p-8 text-center hover:shadow-lg hover:-translate-y-1 transition-all">
                    <i class="fas fa-puzzle-piece text-5xl text-primary mb-4"></i>
                    <h2 class="text-2xl font-bold text-primary">Aventura Social</h2>
                </button>
            </div>
        </main>
    </div>

    <div id="appointments-page" style="display: none;">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-black text-primary">EJR<span class="font-light">.com.ar</span></div>
                <button id="back-to-hub-from-appointments" class="font-bold text-primary hover:opacity-70 transition-opacity flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Volver
                </button>
            </nav>
        </header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="appointments-public-view">
                <div class="max-w-2xl mx-auto text-center">
                    <h1 class="text-4xl md:text-5xl font-black text-primary mb-4">Solicitud de Turno</h1>
                    <p class="text-xl text-secondary mb-10">Completa el formulario para enviar tu solicitud.</p>
                </div>
                <div class="card-custom border rounded-xl shadow-sm max-w-2xl mx-auto">
                    <form id="request-appointment-form" class="p-8 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="appointment-name" class="block text-sm font-medium mb-1 text-secondary">Nombre</label><input type="text" id="appointment-name" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" /></div>
                            <div><label for="appointment-surname" class="block text-sm font-medium mb-1 text-secondary">Apellido</label><input type="text" id="appointment-surname" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" /></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="appointment-date" class="block text-sm font-medium mb-1 text-secondary">Fecha Deseada</label><input type="date" id="appointment-date" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" /></div>
                            <div><label for="appointment-time" class="block text-sm font-medium mb-1 text-secondary">Horario Deseado</label><input type="time" id="appointment-time" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" /></div>
                        </div>
                        <button type="submit" class="w-full bg-primary bg-primary-hover text-white font-bold rounded-lg py-3 flex items-center justify-center gap-2"><i class="fas fa-calendar-check"></i> Enviar Solicitud</button>
                    </form>
                </div>
            </div>
            <div id="appointments-admin-view" style="display: none;">
                <h1 class="text-4xl md:text-5xl font-black text-primary mb-10">Panel de Administración de Turnos</h1>
                <div class="card-custom border rounded-xl shadow-sm">
                    <div class="p-0 overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 border-b border-custom"><tr>
                                <th class="p-4 font-bold text-primary">Paciente</th><th class="p-4 font-bold text-primary">Fecha Solicitada</th><th class="p-4 font-bold text-primary">Estado</th><th class="p-4 font-bold text-primary text-right">Acciones</th>
                            </tr></thead>
                            <tbody id="appointments-list-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="game-1-page" style="display: none;">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h2 class="text-xl font-bold text-primary">Juego: Monstruos de las Emociones</h2>
                <button id="back-to-hub-from-game1" class="font-bold text-primary hover:opacity-70 transition-opacity flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Volver
                </button>
            </nav>
        </header>
        <main class="container mx-auto p-4">
            <div class="game-container">
                <div id="game-board" class="game-board"></div>
                <div class="controls">
                    <button id="restart-btn" class="game-button">Reiniciar Juego</button>
                </div>
            </div>
            <div id="prompt-modal" class="game-modal-overlay">
                <div class="game-modal-content">
                    <div id="modal-monster-container" class="modal-monster"></div>
                    <p id="modal-question" class="modal-question"></p>
                    <div id="modal-choices" class="modal-choices"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="game-2-page" style="display: none;">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h2 class="text-xl font-bold text-primary">Juego: Aventura Social</h2>
                <button id="back-to-hub-from-game2" class="font-bold text-primary hover:opacity-70 transition-opacity flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Volver
                </button>
            </nav>
        </header>
        <main class="container mx-auto p-4">
            <div id="game-2-container" class="game-container">
                <h1>Aventura Social</h1>
                <div id="scenario-card" class="scenario-card">
                    <div id="scenario-image" class="scenario-image"></div>
                    <p id="scenario-text" class="scenario-text"></p>
                </div>
                <div id="choices-container" class="choices-container"></div>
            </div>
            <div id="outcome-modal" class="game-modal-overlay">
                <div class="game-modal-content">
                    <p id="outcome-text" class="outcome-text"></p>
                    <button id="next-btn" class="next-btn">Siguiente</button>
                </div>
            </div>
        </main>
    </div>

    <div id="financial-dashboard-page" style="display: none;">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-black text-primary">EJR<span class="font-light">.com.ar</span></div>
                <div class="flex items-center gap-4">
                     <button id="nav-to-home-from-financial" class="font-bold text-primary hover:opacity-70 transition-opacity">INICIO</button>
                    <button id="logout-btn-financial" class="font-bold text-red-500 hover:opacity-70 transition-opacity flex items-center gap-2"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
                </div>
            </nav>
        </header>
        <main class="bg-gray-100 text-gray-800">
             <div class="container mx-auto p-4 md:p-8">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Financial Dashboard</h1>
                    <p class="text-gray-600">Registrá tus compras y ventas diarias.</p>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Agregar Transacción</h2>
                        <form id="transaction-form" class="space-y-4">
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" id="date" name="date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="type" class="block text-sm font-medium text-gray-700">Tipo de Transacción</label>
                                <select id="type" name="type" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="purchase">Compra</option>
                                    <option value="sale">Venta</option>
                                </select>
                            </div>

                            <div id="purchase-fields" class="space-y-4">
                                <div>
                                    <label for="purchase-supplier" class="block text-sm font-medium text-gray-700">Proveedor</label>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <select id="purchase-supplier" name="supplier" required class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            </select>
                                        <button type="button" id="add-new-supplier-btn" class="flex-shrink-0 bg-blue-500 hover:bg-blue-600 text-white font-bold p-2 rounded-md" title="Agregar Nuevo Proveedor">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label for="purchase-cuit" class="block text-sm font-medium text-gray-700">CUIT</label>
                                    <input type="text" id="purchase-cuit" name="cuit" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Se completará automáticamente">
                                </div>
                                <div>
                                    <label for="purchase-paymentMethod" class="block text-sm font-medium text-gray-700">Método de Pago</label>
                                    <select id="purchase-paymentMethod" name="paymentMethod" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Transferencia">Transferencia</option>
                                        <option value="Cheque">Cheque</option>
                                    </select>
                                </div>
                                <div id="cheque-due-date-field" class="space-y-4 hidden">
                                    <div>
                                        <label for="cheque-due-date" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento del Cheque</label>
                                        <input type="date" id="cheque-due-date" name="chequeDueDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label for="purchase-amount" class="block text-sm font-medium text-gray-700">Importe</label>
                                    <input type="number" id="purchase-amount" name="amount" placeholder="0.00" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                            </div>

                            <div id="sale-fields" class="space-y-4 hidden">
                                <div>
                                    <label for="sale-customerName" class="block text-sm font-medium text-gray-700">Nombre del Cliente</label>
                                    <input type="text" id="sale-customerName" name="customerName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="sale-cuit" class="block text-sm font-medium text-gray-700">CUIT (Opcional)</label>
                                    <input type="text" id="sale-cuit" name="cuit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="sale-type" class="block text-sm font-medium text-gray-700">Tipo de Venta</label>
                                    <select id="sale-type" name="saleType" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <option value="ONLINE">ONLINE</option>
                                        <option value="SALON COMERCIAL">SALON COMERCIAL</option>
                                        <option value="BARES">BARES</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="sale-amount" class="block text-sm font-medium text-gray-700">Importe</label>
                                    <input type="number" id="sale-amount" name="amount" placeholder="0.00" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                            </div>
                            
                            <div id="error-message" class="text-red-600 text-sm font-medium p-3 bg-red-100 rounded-md hidden"></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                Agregar Transacción
                            </button>
                        </form>
                    </div>

                    <div class="lg:col-span-2 space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-lg shadow-md md:col-span-2">
                                <h2 class="text-2xl font-semibold mb-4">Resumen de Transacciones</h2>
                                <div class="chart-container"><canvas id="transaction-chart"></canvas></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-2xl font-semibold mb-4">Compras por Proveedor</h2>
                                <div class="chart-container"><canvas id="supplier-pie-chart"></canvas></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-2xl font-semibold mb-4">Compras por Método de Pago</h2>
                                <div class="chart-container"><canvas id="payment-method-pie-chart"></canvas></div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold mb-4">Historial de Transacciones</h2>
                            
                            <div id="history-filters" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                                <div>
                                    <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Fecha Desde</label>
                                    <input type="date" id="filter-start-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="filter-end-date" class="block text-sm font-medium text-gray-700">Fecha Hasta</label>
                                    <input type="date" id="filter-end-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="filter-name" class="block text-sm font-medium text-gray-700">Proveedor/Cliente</label>
                                    <input type="text" id="filter-name" placeholder="Buscar por nombre..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div class="flex items-end">
                                    <button id="clear-filters-btn" class="w-full bg-gray-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-600 transition duration-150 ease-in-out">Limpiar</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CUIT</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalles</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                                <h2 class="text-2xl font-semibold">Análisis Anual</h2>
                                <div class="mt-4 sm:mt-0">
                                    <label for="year-selector" class="text-sm font-medium text-gray-700 mr-2">Año:</label>
                                    <select id="year-selector" class="p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                                <div>
                                    <h3 class="text-xl font-semibold mb-4 text-center">Compras por Mes</h3>
                                    <div id="monthly-purchases-breakdown-container"></div>
                                </div>
                                <div>
                                    <h3 class="text-xl font-semibold mb-4 text-center">Ventas por Mes</h3>
                                    <div id="monthly-sales-breakdown-container"></div>
                                </div>
                            </div>
                        </div>
                        </div>
                </div>
            </div>

            <div id="edit-modal" class="modal-overlay hidden">
                <div class="modal-content">
                    <h2 class="text-2xl font-semibold mb-4">Editar Transacción</h2>
                    <form id="edit-form" class="space-y-4">
                        <input type="hidden" id="edit-id">
                        <input type="hidden" id="edit-transaction-type">
                        
                        <div id="edit-purchase-fields" class="hidden space-y-4">
                            <div>
                                <label for="edit-purchase-supplierName" class="block text-sm font-medium text-gray-700">Nombre del Proveedor</label>
                                <input type="text" id="edit-purchase-supplierName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="edit-purchase-cuit" class="block text-sm font-medium text-gray-700">CUIT</label>
                                <input type="text" id="edit-purchase-cuit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="edit-purchase-paymentMethod" class="block text-sm font-medium text-gray-700">Método de Pago</label>
                                <select id="edit-purchase-paymentMethod" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>
                             <div>
                                <label for="edit-purchase-amount" class="block text-sm font-medium text-gray-700">Importe</label>
                                <input type="number" id="edit-purchase-amount" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>

                        <div id="edit-sale-fields" class="hidden space-y-4">
                             <div>
                                <label for="edit-sale-customerName" class="block text-sm font-medium text-gray-700">Nombre del Cliente</label>
                                <input type="text" id="edit-sale-customerName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="edit-sale-cuit" class="block text-sm font-medium text-gray-700">CUIT (Opcional)</label>
                                <input type="text" id="edit-sale-cuit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="edit-sale-type" class="block text-sm font-medium text-gray-700">Tipo de Venta</label>
                                <select id="edit-sale-type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="ONLINE">ONLINE</option>
                                    <option value="SALON COMERCIAL">SALON COMERCIAL</option>
                                    <option value="BARES">BARES</option>
                                </select>
                            </div>
                             <div>
                                <label for="edit-sale-amount" class="block text-sm font-medium text-gray-700">Importe</label>
                                <input type="number" id="edit-sale-amount" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>
                        
                        <div id="edit-error-message" class="text-red-600 text-sm font-medium p-3 bg-red-100 rounded-md hidden"></div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="cancel-edit" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="add-supplier-modal" class="modal-overlay hidden">
                <div class="modal-content">
                    <h2 class="text-2xl font-semibold mb-4">Agregar Nuevo Proveedor</h2>
                    <form id="add-supplier-form" class="space-y-4">
                        <div>
                            <label for="new-supplier-name" class="block text-sm font-medium text-gray-700">Nombre del Proveedor</label>
                            <input type="text" id="new-supplier-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="new-supplier-cuit" class="block text-sm font-medium text-gray-700">CUIT</label>
                            <input type="text" id="new-supplier-cuit" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div id="new-supplier-error" class="text-red-600 text-sm font-medium p-3 bg-red-100 rounded-md hidden"></div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="cancel-add-supplier" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Guardar Proveedor</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
    <div id="sales-analyzer-page" style="display: none;">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-2xl font-black text-primary">EJR<span class="font-light">.com.ar</span></div>
                <div class="flex items-center gap-4">
                     <button id="nav-to-home-from-analyzer" class="font-bold text-primary hover:opacity-70 transition-opacity">INICIO</button>
                    <button id="logout-btn-analyzer" class="font-bold text-red-500 hover:opacity-70 transition-opacity flex items-center gap-2"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
                </div>
            </nav>
        </header>
        <main class="text-gray-800">
            <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
                <header class="text-center mb-8">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Analizador de Ventas Avanzado</h1>
                    <p class="mt-2 text-lg text-gray-600">Sube tu archivo de ventas para un análisis completo.</p>
                </header>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div id="drop-zone" class="flex flex-col items-center justify-center p-8 rounded-lg text-center cursor-pointer">
                        <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h1.586A3 3 0 0111.172 4l1.414 1.414A1 1 0 0013 6h4a4 4 0 014 4v5a4 4 0 01-4 4H7z"></path></svg>
                        <p class="text-gray-700 font-semibold">Arrastra y suelta tu archivo Excel aquí</p>
                        <p class="text-gray-500 text-sm mt-1">o haz clic para seleccionar</p>
                        <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                    <div id="file-info" class="mt-4 text-center text-gray-600"></div>
                    <div id="analyzer-error-message" class="mt-4 text-center text-red-600 font-medium"></div>
                </div>

                <div id="results-section" class="hidden mt-8 space-y-8">
                    <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                            <div class="bg-blue-100 p-3 rounded-full">
                                <svg class="w-8 h-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0l.879-.659M7.5 14.25l.879.659c1.171.879 3.07.879 4.242 0l.879-.659M7.5 12l.879.659c1.171.879 3.07.879 4.242 0l.879-.659M7.5 9.75l.879.659c1.171.879 3.07.879 4.242 0l.879-.659M7.5 7.5l.879.659c1.171.879 3.07.879 4.242 0l.879-.659" /></svg>
                            </div>
                            <div>
                                <p class="text-gray-500">Ingresos Totales</p>
                                <p id="total-revenue" class="text-2xl font-bold text-gray-900">$0</p>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                            <div class="bg-purple-100 p-3 rounded-full">
                                <svg class="w-8 h-8 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.31h5.418a.562.562 0 01.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-3.35a.563.563 0 00-.586 0l-4.725 3.35a.562.562 0 01-.84-.61l1.285-5.385a.562.562 0 00-.182-.557l-4.204-3.602a.562.562 0 01.321-.988h5.418a.563.563 0 00.475-.31l2.125-5.111z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-gray-500">Ingresos Top 10</p>
                                <p id="top-10-revenue" class="text-2xl font-bold text-gray-900">$0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                            <div class="bg-green-100 p-3 rounded-full">
                                <svg class="w-8 h-8 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                            </div>
                            <div>
                                <p class="text-gray-500">Artículos Únicos Vendidos</p>
                                <p id="unique-products" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-md fade-in space-y-6" style="animation-delay: 0.1s;">
                            <h2 class="text-2xl font-bold text-gray-800">🚀 Top 10 por Unidades</h2>
                            <div id="table-container-units"></div>
                            <div class="relative h-96">
                                <canvas id="chart-units"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md fade-in space-y-6" style="animation-delay: 0.2s;">
                            <h2 class="text-2xl font-bold text-gray-800">💰 Top 10 por Ingresos</h2>
                            <div id="table-container-revenue"></div>
                            <div class="relative h-96">
                                <canvas id="chart-revenue"></canvas>
                            </div>
                        </div>
                    </div>

                    <div id="bottom-section" class="bg-white p-6 rounded-xl shadow-md fade-in space-y-6" style="animation-delay: 0.3s;">
                         <h2 class="text-2xl font-bold text-gray-800">📉 20 Productos Menos Vendidos</h2>
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                             <div>
                                 <div id="table-container-bottom-units"></div>
                             </div>
                             <div class="relative h-96">
                                 <canvas id="chart-bottom-units"></canvas>
                             </div>
                         </div>
                    </div>

                </div>
            </div>
        </main>
    </div>
    <div id="add-change-modal" class="modal-backdrop"><div class="modal-content"><h3 class="text-lg font-bold text-primary p-6 border-b border-custom" id="add-change-modal-title">Agregar Vuelto</h3><form id="add-change-form"><div class="p-6 space-y-4"><div><label class="block text-sm font-medium mb-1 text-secondary">Total Compra</label><input name="purchaseTotal" type="number" step="0.01" required placeholder="80.00" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" /></div><div><label class="block text-sm font-medium mb-1 text-secondary">Monto Pagado</label><input name="amountPaid" type="number" step="0.01" required placeholder="100.00" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" /></div></div><div class="p-6 border-t border-custom flex justify-end gap-3"><button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Confirmar</button></div></form></div></div>
    <div id="use-balance-modal" class="modal-backdrop"><div class="modal-content"><h3 class="text-lg font-bold text-primary p-6 border-b border-custom" id="use-balance-modal-title">Usar Saldo</h3><form id="use-balance-form"><div class="p-6 space-y-4"><p class="text-secondary">Saldo disponible: <span class="font-bold text-primary" id="use-balance-current-saldo"></span></p><div><label class="block text-sm font-medium mb-1 text-secondary">Total Nueva Compra</label><input name="purchaseTotal" type="number" step="0.01" required placeholder="150.00" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition"/></div><div><label class="block text-sm font-medium mb-1 text-secondary">Pago en Efectivo</label><input name="cashPaid" type="number" step="0.01" required placeholder="110.00" class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition"/></div></div><div class="p-6 border-t border-custom flex justify-end gap-3"><button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">Confirmar</button></div></form></div></div>
    <div id="history-modal" class="modal-backdrop"><div class="modal-content"><h3 class="text-lg font-bold text-primary p-6 border-b border-custom" id="history-modal-title">Historial</h3><div id="history-list-content" class="p-6 max-h-96 overflow-y-auto space-y-3"></div><div class="p-6 border-t border-custom flex justify-end"><button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cerrar</button></div></div></div>
    <div id="delete-modal" class="modal-backdrop"><div class="modal-content text-center"><h3 class="text-lg font-bold text-primary p-6" id="delete-modal-title">Confirmar Eliminación</h3><p id="delete-modal-text" class="px-6 pb-6 text-secondary"></p><div class="p-6 border-t border-custom flex justify-center gap-4"><button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Eliminar</button></div></div></div>
    <div id="redeem-stars-modal" class="modal-backdrop"><div class="modal-content text-center"><h3 class="text-lg font-bold text-primary p-6" id="redeem-stars-modal-title">Canjear Estrellas</h3><p id="redeem-stars-modal-text" class="px-6 pb-6 text-secondary"></p><div class="p-6 border-t border-custom flex justify-center gap-4"><button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button><button id="confirm-redeem-btn" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600">Confirmar Canje</button></div></div></div>
    <div id="edit-supplier-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-primary p-6 border-b border-custom">Editar Proveedor</h3>
            <form id="edit-supplier-form">
                <input type="hidden" id="edit-supplier-id">
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1 text-secondary">Nombre del Proveedor</label>
                        <input id="edit-supplier-name" type="text" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 text-secondary">CUIT</label>
                        <input id="edit-supplier-cuit" type="text" required class="w-full p-3 border border-custom rounded-lg focus:outline-none ring-custom transition" />
                    </div>
                    <div id="edit-supplier-error" class="text-red-600 text-sm font-medium p-3 bg-red-100 rounded-md hidden"></div>
                </div>
                <div class="p-6 border-t border-custom flex justify-end gap-3">
                    <button type="button" class="modal-close-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-primary text-white font-bold py-2 px-4 rounded-lg bg-primary-hover">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <div id="toast-notification" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, increment, serverTimestamp, query, orderBy, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJbCC1pR-CQTpOXBicC59Jqm32Rr7q9M8",
            authDomain: "sistemafidelidad-super-21.firebaseapp.com",
            projectId: "sistemafidelidad-super-21",
            storageBucket: "sistemafidelidad-super-21.firebasestorage.app",
            messagingSenderId: "221163223090",
            appId: "1:221163223090:web:ffe60b7a75758d591c242b",
            measurementId: "G-79RSPJE5L8"
        };

        // --- Global App State ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let allClients = [];
        let allSuppliers = [];
        let itemToDelete = null;
        let selectedClient = null;
        let intendedTargetPage = null; 
        
        let unsubscribeClients = null; 
        let unsubscribeAppointments = null;
        let unsubscribeFinancial = null;
        let unsubscribeSuppliers = null;

        let isGame1Initialized = false;
        let isGame2Initialized = false;
        let isFinancialDashboardInitialized = false;
        let isSalesAnalyzerInitialized = false;
        let isSupplierManagementInitialized = false;

        document.addEventListener('DOMContentLoaded', () => {
            setupListeners();
            setupAuthListener();
            document.getElementById('footer-year').textContent = new Date().getFullYear();
        });

        function setupAuthListener() {
            onAuthStateChanged(auth, user => {
                updateNavUI(user);
                updateAppointmentView(user);
                if (user && intendedTargetPage) {
                    navigateTo(intendedTargetPage);
                    intendedTargetPage = null; 
                } else if (!user) {
                    navigateTo('landing');
                    if (unsubscribeClients) unsubscribeClients();
                    if (unsubscribeAppointments) unsubscribeAppointments();
                    if (unsubscribeFinancial) unsubscribeFinancial();
                    if (unsubscribeSuppliers) unsubscribeSuppliers();
                    unsubscribeClients = null;
                    unsubscribeAppointments = null;
                    unsubscribeFinancial = null;
                    unsubscribeSuppliers = null;
                }
            });
        }

        function updateNavUI(user) {
            const authNavLinks = document.getElementById('auth-nav-links');
            if (user) {
                authNavLinks.innerHTML = `
                    <button id="nav-to-customers-auth" class="font-bold text-primary hover:opacity-70 transition-opacity">CLIENTES</button>
                    <button id="nav-to-suppliers" class="font-bold text-primary hover:opacity-70 transition-opacity">PROVEEDORES</button>
                    <button id="nav-to-financial-dashboard" class="font-bold text-primary hover:opacity-70 transition-opacity">FINANZAS</button>
                    <button id="nav-to-sales-analyzer" class="font-bold text-primary hover:opacity-70 transition-opacity">ANALIZADOR</button>
                    <button id="logout-btn-main" class="font-bold text-red-500 hover:opacity-70 transition-opacity flex items-center gap-2"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
                `;
                document.getElementById('nav-to-customers-auth').addEventListener('click', () => handleProtectedRoute('customer-system'));
                document.getElementById('nav-to-suppliers').addEventListener('click', () => handleProtectedRoute('supplier-management'));
                document.getElementById('nav-to-financial-dashboard').addEventListener('click', () => handleProtectedRoute('financial-dashboard'));
                document.getElementById('nav-to-sales-analyzer').addEventListener('click', () => handleProtectedRoute('sales-analyzer'));
                document.getElementById('logout-btn-main').addEventListener('click', handleSignOut);
            } else {
                authNavLinks.innerHTML = `<button id="login-nav-btn" class="font-bold text-primary hover:opacity-70 transition-opacity">LOGIN</button>`;
                document.getElementById('login-nav-btn').addEventListener('click', () => {
                    intendedTargetPage = 'customer-system';
                    navigateTo('login');
                });
            }
        }

        function navigateTo(page) {
            document.querySelectorAll('#landing-page, #customer-system-page, #supplier-management-page, #licenciada-hub-page, #appointments-page, #game-1-page, #game-2-page, #login-page, #financial-dashboard-page, #sales-analyzer-page').forEach(p => p.style.display = 'none');
            const targetPage = document.getElementById(`${page}-page`);
            if (targetPage) {
                targetPage.style.display = page === 'login' ? 'flex' : 'block';
            }

            if (page === 'customer-system' && auth.currentUser && !unsubscribeClients) listenForClients();
            if (page === 'supplier-management' && auth.currentUser && !isSupplierManagementInitialized) { initializeSupplierManagement(); isSupplierManagementInitialized = true; }
            if (page.startsWith('appointments') && auth.currentUser && !unsubscribeAppointments) listenForAppointments();
            if (page === 'financial-dashboard' && auth.currentUser && !isFinancialDashboardInitialized) { initializeFinancialDashboard(); isFinancialDashboardInitialized = true; }
            if (page === 'sales-analyzer' && auth.currentUser && !isSalesAnalyzerInitialized) { initializeSalesAnalyzer(); isSalesAnalyzerInitialized = true; }
            if (page === 'game-1' && !isGame1Initialized) { initializeGame1(); isGame1Initialized = true; }
            if (page === 'game-2' && !isGame2Initialized) { initializeGame2(); isGame2Initialized = true; }
        }
        
        function handleProtectedRoute(targetPage) {
            if (auth.currentUser) {
                navigateTo(targetPage);
            } else {
                intendedTargetPage = targetPage;
                navigateTo('login');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Inicio de sesión exitoso.", "success");
            } catch (error) {
                showToast("Error: Correo o contraseña incorrectos.", "error");
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                showToast("Sesión cerrada.", "success");
            } catch (error) { console.error("Sign out failed:", error); }
        }
        
        function setupListeners() {
            const addListener = (id, event, handler) => {
                const element = document.getElementById(id);
                if (element) element.addEventListener(event, handler);
            };
            
            addListener('main-to-customers', 'click', () => handleProtectedRoute('customer-system'));
            addListener('main-to-financial', 'click', () => handleProtectedRoute('financial-dashboard'));
            addListener('main-to-sales-analyzer', 'click', () => handleProtectedRoute('sales-analyzer'));
            addListener('main-to-licenciada', 'click', () => navigateTo('licenciada-hub'));
            
            addListener('nav-to-home-from-customers', 'click', () => navigateTo('landing'));
            addListener('nav-to-home-from-suppliers', 'click', () => navigateTo('landing'));
            addListener('nav-to-home-from-licenciada', 'click', () => navigateTo('landing'));
            addListener('nav-to-home-from-financial', 'click', () => navigateTo('landing'));
            addListener('nav-to-home-from-analyzer', 'click', () => navigateTo('landing'));
            addListener('back-to-home-from-login', 'click', () => navigateTo('landing'));
            addListener('back-to-hub-from-appointments', 'click', () => navigateTo('licenciada-hub'));

            addListener('go-to-appointments', 'click', () => navigateTo('appointments'));
            addListener('play-game-1', 'click', () => navigateTo('game-1'));
            addListener('play-game-2', 'click', () => navigateTo('game-2'));
            addListener('back-to-hub-from-game1', 'click', () => navigateTo('licenciada-hub'));
            addListener('back-to-hub-from-game2', 'click', () => navigateTo('licenciada-hub'));

            addListener('add-client-form', 'submit', handleAddClient);
            addListener('search-client-input', 'input', renderClientList);
            addListener('login-form', 'submit', handleLogin);
            
            addListener('logout-btn-customers', 'click', handleSignOut);
            addListener('logout-btn-suppliers', 'click', handleSignOut);
            addListener('logout-btn-financial', 'click', handleSignOut);
            addListener('logout-btn-analyzer', 'click', handleSignOut);
            
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.modal-backdrop').style.display = 'none';
                });
            });
            
            addListener('add-change-form', 'submit', handleAddChange);
            addListener('use-balance-form', 'submit', handleUseBalance);
            addListener('confirm-delete-btn', 'click', handleConfirmDelete);
            addListener('confirm-redeem-btn', 'click', handleRedeemStars);
            addListener('request-appointment-form', 'submit', handleRequestAppointment);
        }

        // --- LÓGICA DE TURNOS ---
        function updateAppointmentView(user) {
            const publicView = document.getElementById('appointments-public-view');
            const adminView = document.getElementById('appointments-admin-view');
            if (!publicView || !adminView) return;

            if (user) {
                publicView.style.display = 'none';
                adminView.style.display = 'block';
                if (!unsubscribeAppointments) listenForAppointments();
            } else {
                publicView.style.display = 'block';
                adminView.style.display = 'none';
            }
        }
        async function handleRequestAppointment(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.elements['appointment-name'].value;
            const surname = form.elements['appointment-surname'].value;
            const date = form.elements['appointment-date'].value;
            const time = form.elements['appointment-time'].value;
            if (!name || !surname || !date || !time) return showToast('Todos los campos son obligatorios.', 'error');
            try {
                await addDoc(collection(db, 'appointments'), { name, surname, date, time, status: 'pending', requestedAt: serverTimestamp() });
                showToast('Tu solicitud de turno ha sido enviada.', 'success');
                form.reset();
            } catch (error) {
                showToast('Error al enviar la solicitud.', 'error');
                console.error("Appointment request error:", error);
            }
        }
        function listenForAppointments() {
            if (!db || !auth.currentUser || unsubscribeAppointments) return;
            const q = query(collection(db, "appointments"), orderBy('requestedAt', 'desc'));
            unsubscribeAppointments = onSnapshot(q, (snapshot) => {
                const appointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAppointmentsList(appointments);
            });
        }
        function renderAppointmentsList(appointments) {
            const tbody = document.getElementById('appointments-list-tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (appointments.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-secondary">No hay solicitudes de turno.</td></tr>`;
                return;
            }
            appointments.forEach(app => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-custom last:border-none';
                const statusInfo = {
                    pending: { text: 'Pendiente', class: 'status-pending' },
                    confirmed: { text: 'Confirmado', class: 'status-confirmed' },
                    declined: { text: 'Rechazado', class: 'status-declined' }
                };
                const currentStatus = statusInfo[app.status] || { text: app.status, class: 'bg-gray-200 text-gray-800' };

                tr.innerHTML = `
                    <td class="p-4 font-semibold text-primary">${app.name} ${app.surname}</td>
                    <td class="p-4 text-secondary">${new Date(app.date + 'T00:00:00').toLocaleDateString('es-AR')} - ${app.time} hs</td>
                    <td class="p-4"><span class="status-badge ${currentStatus.class}">${currentStatus.text}</span></td>
                    <td class="p-4 text-right">
                        ${app.status === 'pending' ? `<div class="flex justify-end gap-2"><button data-action="confirm" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg"><i class="fas fa-check"></i></button><button data-action="decline" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg"><i class="fas fa-times"></i></button></div>` : ''}
                    </td>`;
                if (app.status === 'pending') {
                    tr.querySelector('[data-action="confirm"]').addEventListener('click', () => updateAppointmentStatus(app.id, 'confirmed'));
                    tr.querySelector('[data-action="decline"]').addEventListener('click', () => updateAppointmentStatus(app.id, 'declined'));
                }
                tbody.appendChild(tr);
            });
        }
        async function updateAppointmentStatus(id, newStatus) {
            const appointmentRef = doc(db, 'appointments', id);
            try {
                await updateDoc(appointmentRef, { status: newStatus });
                showToast(`Turno ${newStatus === 'confirmed' ? 'confirmado' : 'rechazado'}.`, 'success');
            } catch (error) { showToast('Error al actualizar el turno.', 'error'); }
        }

        // --- LÓGICA DE CLIENTES ---
        function listenForClients() {
            if (!db || !auth.currentUser || unsubscribeClients) return;
            const q = query(collection(db, "customers"), orderBy('name'));
            unsubscribeClients = onSnapshot(q, (snapshot) => {
                allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClientList();
            }, (error) => console.error("Error listening to clients:", error));
        }
        function renderClientList() {
            const searchInput = document.getElementById('search-client-input');
            if (!searchInput) return;
            const searchTerm = searchInput.value.toLowerCase();
            const tbody = document.getElementById('client-list-tbody');
            if (!tbody) return;
            const filteredClients = allClients.filter(c => c.name.toLowerCase().includes(searchTerm) || c.dni.toLowerCase().includes(searchTerm));
            tbody.innerHTML = '';
            if (filteredClients.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-secondary">No se encontraron clientes.</td></tr>`;
                return;
            }
            filteredClients.forEach(client => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-custom last:border-none hover:bg-gray-50';
                const starsCount = client.stars || 0;
                let starsHTML = '';
                for (let i = 0; i < starsCount; i++) { starsHTML += '<i class="fas fa-star star-icon"></i>'; }
                let actionsHTML = `
                    <button data-action="add-change" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2"><i class="fas fa-wallet"></i><span class="hidden sm:inline">Vuelto</span></button>
                    <button data-action="use-balance" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2"><i class="fas fa-exchange-alt"></i><span class="hidden sm:inline">Usar</span></button>
                    <button data-action="history" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2"><i class="fas fa-history"></i><span class="hidden sm:inline">Historial</span></button>`;
                if (starsCount >= 5) {
                    actionsHTML += `<button data-action="redeem-stars" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2"><i class="fas fa-gift"></i><span class="hidden sm:inline">Canjear</span></button>`;
                }
                actionsHTML += `<button data-action="delete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2"><i class="fas fa-trash"></i><span class="hidden sm:inline">Eliminar</span></button>`;
                tr.innerHTML = `<td class="p-4 font-semibold text-primary">${client.name}</td><td class="p-4 text-secondary">${client.dni}</td><td class="p-4 font-bold text-green-600">${formatCurrency(client.balance)}</td><td class="p-4 text-secondary text-lg">${starsHTML || '0'}</td><td class="p-4 text-right"><div class="flex justify-end gap-2 flex-wrap">${actionsHTML}</div></td>`;
                tr.querySelector('[data-action="add-change"]').addEventListener('click', () => openModal('add-change', client));
                tr.querySelector('[data-action="use-balance"]').addEventListener('click', () => openModal('use-balance', client));
                tr.querySelector('[data-action="history"]').addEventListener('click', () => openModal('history', client));
                tr.querySelector('[data-action="delete"]').addEventListener('click', () => openDeleteModal('client', client.id, client.name));
                const redeemBtn = tr.querySelector('[data-action="redeem-stars"]');
                if (redeemBtn) { redeemBtn.addEventListener('click', () => openModal('redeem-stars', client)); }
                tbody.appendChild(tr);
            });
        }
        async function handleAddClient(e) {
            e.preventDefault();
            const name = document.getElementById('new-client-name').value.trim();
            const dni = document.getElementById('new-client-dni').value.trim();
            if (!name || !dni) return showToast("Nombre y DNI son obligatorios.", "error");
            const q = query(collection(db, "customers"), where("dni", "==", dni));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) return showToast(`El cliente ${querySnapshot.docs[0].data().name} ya está registrado.`, "error");
            try {
                await addDoc(collection(db, "customers"), { name, dni, balance: 0, stars: 0 });
                showToast("Cliente agregado exitosamente.", "success");
                e.target.reset();
            } catch (err) { showToast("Error al agregar el cliente.", "error"); }
        }
        
        function openModal(type, client) {
            selectedClient = client;
            const modal = document.getElementById(`${type}-modal`);
            if (type === 'add-change') { document.getElementById('add-change-modal-title').textContent = `Agregar Vuelto a ${client.name}`; } 
            else if (type === 'use-balance') { document.getElementById('use-balance-modal-title').textContent = `Usar Saldo de ${client.name}`; document.getElementById('use-balance-current-saldo').textContent = formatCurrency(client.balance); } 
            else if (type === 'history') { document.getElementById('history-modal-title').textContent = `Historial de ${client.name}`; loadHistory(client.id); } 
            else if (type === 'redeem-stars') { document.getElementById('redeem-stars-modal-text').textContent = `¿Confirmas canjear 5 estrellas de ${client.name} por un descuento especial?`; }
            modal.style.display = 'flex';
        }
        async function handleTransaction(type, amount, description) {
            const clientDocRef = doc(db, "customers", selectedClient.id);
            const balanceChange = type === 'credit' ? amount : -amount;
            try {
                await updateDoc(clientDocRef, { balance: increment(balanceChange) });
                await addDoc(collection(clientDocRef, "movements"), { type, amount, description, date: serverTimestamp() });
                showToast("Transacción exitosa.", "success");
            } catch (err) { showToast("Error en la transacción.", "error"); }
        }
        async function handleAddChange(e) {
            e.preventDefault();
            const form = e.target;
            const purchaseTotal = parseFloat(form.elements.purchaseTotal.value);
            const amountPaid = parseFloat(form.elements.amountPaid.value);
            const change = amountPaid - purchaseTotal;
            if (isNaN(purchaseTotal) || isNaN(amountPaid) || amountPaid < purchaseTotal) return showToast("Valores de compra inválidos.", "error");
            if (change > 0) { await handleTransaction('credit', change, 'Vuelto de compra'); }
            if (purchaseTotal >= 20000) {
                const clientDocRef = doc(db, "customers", selectedClient.id);
                await updateDoc(clientDocRef, { stars: increment(1) });
                await addDoc(collection(clientDocRef, "movements"), { type: 'star', description: 'Estrella ganada por compra', amount: purchaseTotal, date: serverTimestamp() });
                showToast(`¡${selectedClient.name} ha ganado una estrella! ⭐`, 'success');
            }
            form.closest('.modal-backdrop').style.display = 'none'; form.reset();
        }
        async function handleUseBalance(e) {
            e.preventDefault();
            const form = e.target;
            const purchaseTotal = parseFloat(form.elements.purchaseTotal.value);
            const cashPaid = parseFloat(form.elements.cashPaid.value);
            const amountToUse = purchaseTotal - cashPaid;
            if (isNaN(purchaseTotal) || isNaN(cashPaid) || amountToUse <= 0) return showToast("Valores de pago inválidos.", "error");
            if (selectedClient.balance < amountToUse) return showToast("Saldo insuficiente.", "error");
            await handleTransaction('debit', amountToUse, 'Uso de saldo en compra');
            if (purchaseTotal >= 20000) {
                 const clientDocRef = doc(db, "customers", selectedClient.id);
                 await updateDoc(clientDocRef, { stars: increment(1) });
                 await addDoc(collection(clientDocRef, "movements"), { type: 'star', description: 'Estrella ganada por compra', amount: purchaseTotal, date: serverTimestamp() });
                showToast(`¡${selectedClient.name} ha ganado una estrella! ⭐`, 'success');
            }
            form.closest('.modal-backdrop').style.display = 'none'; form.reset();
        }
        async function handleRedeemStars() {
            if (!selectedClient || (selectedClient.stars || 0) < 5) return;
            const clientDocRef = doc(db, "customers", selectedClient.id);
            try {
                await updateDoc(clientDocRef, { stars: increment(-5) });
                await addDoc(collection(clientDocRef, "movements"), { type: 'discount', description: 'Canje de 5 estrellas por descuento', date: serverTimestamp() });
                showToast("¡Estrellas canjeadas con éxito!", "success");
            } catch (error) { console.error("Error al canjear estrellas:", error); showToast("No se pudieron canjear las estrellas.", "error"); }
            document.getElementById('redeem-stars-modal').style.display = 'none';
        }
        async function loadHistory(clientId) {
            const contentDiv = document.getElementById('history-list-content');
            contentDiv.innerHTML = `<p class="text-center text-secondary">Cargando historial...</p>`;
            const q = query(collection(db, `customers/${clientId}/movements`), orderBy('date', 'desc'));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { contentDiv.innerHTML = `<p class="text-center text-secondary">No hay movimientos.</p>`; return; }
            contentDiv.innerHTML = snapshot.docs.map(doc => {
                const mov = doc.data(); let movHTML = '';
                switch(mov.type) {
                    case 'credit': movHTML = `<div class="p-3 rounded-lg flex justify-between items-center bg-green-50"><div><p class="font-semibold text-primary">${mov.description}</p><p class="text-sm text-secondary">${formatDate(mov.date)}</p></div><p class="font-bold text-lg text-green-700">+${formatCurrency(mov.amount)}</p></div>`; break;
                    case 'debit': movHTML = `<div class="p-3 rounded-lg flex justify-between items-center bg-red-50"><div><p class="font-semibold text-primary">${mov.description}</p><p class="text-sm text-secondary">${formatDate(mov.date)}</p></div><p class="font-bold text-lg text-red-700">-${formatCurrency(mov.amount)}</p></div>`; break;
                    case 'star': movHTML = `<div class="p-3 rounded-lg flex justify-between items-center bg-yellow-50"><div><p class="font-semibold text-amber-800">${mov.description} (${formatCurrency(mov.amount)})</p><p class="text-sm text-secondary">${formatDate(mov.date)}</p></div><p class="font-bold text-lg text-amber-500"><i class="fas fa-star"></i> +1</p></div>`; break;
                    case 'discount': movHTML = `<div class="p-3 rounded-lg flex justify-between items-center bg-blue-50"><div><p class="font-semibold text-blue-800">${mov.description}</p><p class="text-sm text-secondary">${formatDate(mov.date)}</p></div><p class="font-bold text-lg text-blue-600"><i class="fas fa-gift"></i> Canjeado</p></div>`; break;
                } return movHTML;
            }).join('');
        }

        // --- LÓGICA DE JUEGOS ---
        function initializeGame1() { /* ...código sin cambios... */ }
        function initializeGame2() { /* ...código sin cambios... */ }

        // --- LÓGICA DEL DASHBOARD FINANCIERO ---
        function initializeFinancialDashboard() {
            const page = document.getElementById('financial-dashboard-page');
            if (!page) return;

            const transactionForm = page.querySelector('#transaction-form');
            const typeSelect = page.querySelector('#type');
            const purchaseFields = page.querySelector('#purchase-fields');
            const saleFields = page.querySelector('#sale-fields');
            const errorMessageDiv = page.querySelector('#error-message');
            const transactionList = page.querySelector('#transaction-list');
            const editModal = page.querySelector('#edit-modal');
            const editForm = page.querySelector('#edit-form');
            const cancelEditBtn = page.querySelector('#cancel-edit');
            const lineCtx = page.querySelector('#transaction-chart').getContext('2d');
            const supplierPieCtx = page.querySelector('#supplier-pie-chart').getContext('2d');
            const paymentPieCtx = page.querySelector('#payment-method-pie-chart').getContext('2d');
            const supplierSelect = page.querySelector('#purchase-supplier');
            const addNewSupplierBtn = page.querySelector('#add-new-supplier-btn');
            const addSupplierModal = page.querySelector('#add-supplier-modal');
            const addSupplierForm = page.querySelector('#add-supplier-form');
            const cancelAddSupplierBtn = page.querySelector('#cancel-add-supplier');
            const purchaseCuitInput = page.querySelector('#purchase-cuit');
            const yearSelector = page.querySelector('#year-selector');
            const monthlyPurchasesBreakdownContainer = page.querySelector('#monthly-purchases-breakdown-container');
            const monthlySalesBreakdownContainer = page.querySelector('#monthly-sales-breakdown-container');
            
            // ---> INICIO: VARIABLES Y LISTENERS PARA FILTROS
            const filterStartDate = page.querySelector('#filter-start-date');
            const filterEndDate = page.querySelector('#filter-end-date');
            const filterName = page.querySelector('#filter-name');
            const clearFiltersBtn = page.querySelector('#clear-filters-btn');
            // ---> FIN: VARIABLES Y LISTENERS PARA FILTROS

            let lineChart, supplierPieChart, paymentPieChart;
            let allTransactions = []; 
            let newlyAddedSupplierId = null;

            // --- NUEVO: Listener para mostrar/ocultar el campo de fecha de cheque (MODIFICADO) ---
            const paymentMethodSelect = page.querySelector('#purchase-paymentMethod');
            const chequeDateField = page.querySelector('#cheque-due-date-field');
            const chequeDateInput = page.querySelector('#cheque-due-date');

            paymentMethodSelect.addEventListener('change', () => {
                if (paymentMethodSelect.value === 'Cheque') {
                    chequeDateField.classList.remove('hidden');
                    chequeDateField.style.display = 'block';
                    chequeDateInput.required = true;
                } else {
                    chequeDateField.classList.add('hidden');
                    chequeDateField.style.display = 'none';
                    chequeDateInput.required = false;
                }
            });
            
            // ---> INICIO: FUNCIÓN PARA APLICAR FILTROS Y RENDERIZAR
            function applyFiltersAndRender() {
                const startDate = filterStartDate.value;
                const endDate = filterEndDate.value;
                const nameQuery = filterName.value.toLowerCase();

                let filteredTransactions = allTransactions;

                if (startDate) {
                    filteredTransactions = filteredTransactions.filter(t => t.date >= startDate);
                }
                if (endDate) {
                    filteredTransactions = filteredTransactions.filter(t => t.date <= endDate);
                }
                if (nameQuery) {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.partyName.toLowerCase().includes(nameQuery)
                    );
                }

                renderTransactions(filteredTransactions);
            }
            // ---> FIN: FUNCIÓN PARA APLICAR FILTROS Y RENDERIZAR

            function listenForSuppliersInDashboard() {
                if (!auth.currentUser) return;
                if (unsubscribeSuppliers) unsubscribeSuppliers();
                
                const q = query(collection(db, "suppliers"), orderBy("name"));
                unsubscribeSuppliers = onSnapshot(q, (snapshot) => {
                    allSuppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    const currentSelection = newlyAddedSupplierId || supplierSelect.value;
                    renderSupplierDropdown(currentSelection);
                    
                    if (newlyAddedSupplierId) {
                        handleSupplierChange();
                        newlyAddedSupplierId = null; 
                    }
                }, (error) => console.error("Error al escuchar proveedores:", error));
            }

            function renderSupplierDropdown(selectedValue = null) {
                supplierSelect.innerHTML = '<option value="">-- Seleccione un Proveedor --</option>';
                allSuppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.id;
                    option.textContent = supplier.name;
                    if (supplier.id === selectedValue) option.selected = true;
                    supplierSelect.appendChild(option);
                });
            }

            function handleSupplierChange() {
                const selectedId = supplierSelect.value;
                purchaseCuitInput.value = selectedId ? (allSuppliers.find(s => s.id === selectedId)?.cuit || '') : '';
            }
            
            supplierSelect.addEventListener('change', handleSupplierChange);

            addNewSupplierBtn.addEventListener('click', () => {
                addSupplierModal.classList.remove('hidden');
                addSupplierModal.style.display = 'flex';
            });

            cancelAddSupplierBtn.addEventListener('click', () => {
                addSupplierModal.classList.add('hidden');
                addSupplierModal.style.display = 'none';
                addSupplierForm.reset();
            });

            addSupplierForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = addSupplierForm.querySelector('#new-supplier-name').value.trim();
                const newCuit = addSupplierForm.querySelector('#new-supplier-cuit').value.trim();
                const errorDiv = addSupplierForm.querySelector('#new-supplier-error');
                
                if (!newName || !newCuit) {
                    errorDiv.textContent = 'Nombre y CUIT son obligatorios.';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                const nameExists = allSuppliers.some(s => s.name.toLowerCase() === newName.toLowerCase());
                if (nameExists) {
                    errorDiv.textContent = `El proveedor "${newName}" ya se encuentra registrado.`;
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                const cuitExists = allSuppliers.some(s => s.cuit === newCuit);
                if (cuitExists) {
                    errorDiv.textContent = `Ya existe un proveedor con el CUIT ${newCuit}.`;
                    errorDiv.classList.remove('hidden');
                    return;
                }

                errorDiv.classList.add('hidden');

                try {
                    const docRef = await addDoc(collection(db, 'suppliers'), { name: newName, cuit: newCuit });
                    showToast('Proveedor agregado con éxito.', 'success');
                    newlyAddedSupplierId = docRef.id;
                    addSupplierModal.classList.add('hidden');
                    addSupplierModal.style.display = 'none';
                    addSupplierForm.reset();
                } catch (error) {
                    console.error("Error al agregar proveedor:", error);
                    showToast('Error al guardar el proveedor.', 'error');
                }
            });
            
            const handleFormDisplay = () => {
                const selectedType = typeSelect.value;
                const purchaseSupplierSelect = page.querySelector('#purchase-supplier');

                if (selectedType === 'purchase') {
                    purchaseFields.style.display = 'block';
                    saleFields.style.display = 'none';
                    purchaseSupplierSelect.required = true; // Lo hacemos obligatorio
                } else { // Para 'sale'
                    purchaseFields.style.display = 'none';
                    saleFields.style.display = 'block';
                    purchaseSupplierSelect.required = false; // DEJA de ser obligatorio
                }
            };
            
            typeSelect.addEventListener('change', handleFormDisplay);
            
            function listenForFinancialTransactions() {
                if (!auth.currentUser) return;
                if (unsubscribeFinancial) unsubscribeFinancial();
                const q = query(collection(db, "financial_transactions"), orderBy("createdAt", "desc"));

                unsubscribeFinancial = onSnapshot(q, (snapshot) => {
                    allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    applyFiltersAndRender(); // MODIFICADO: Llama a la función de filtro en lugar de render directo
                    updateAllCharts(allTransactions);
                    updateAllMonthlyAnalyses(allTransactions);
                }, (error) => {
                    console.error("Error al escuchar transacciones financieras:", error);
                    showToast("Error al cargar las transacciones.", "error");
                });
            }

            function renderTransactions(transactions) {
                transactionList.innerHTML = '';
                if (transactions.length === 0) {
                    transactionList.innerHTML = '<tr><td colspan="7" class="text-center py-4">No hay transacciones que coincidan con los filtros.</td></tr>';
                    return;
                }
                transactions.forEach(t => {
                    const row = document.createElement('tr');
                    const details = t.type === 'purchase' 
                        ? `Método: ${t.paymentMethod || 'N/A'}` 
                        : `Canal: ${t.saleType || 'N/A'}`;
                    row.className = t.type === 'sale' ? 'bg-green-50' : 'bg-red-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${t.type === 'sale' ? 'text-green-600' : 'text-red-600'}">${t.type.charAt(0).toUpperCase() + t.type.slice(1)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.partyName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.partyCuit || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${details}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${formatCurrency(t.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button data-id="${t.id}" class="text-indigo-600 hover:text-indigo-900 edit-btn">Editar</button>
                            <button data-id="${t.id}" class="text-red-600 hover:text-red-900 delete-btn">Eliminar</button>
                        </td>`;
                    transactionList.appendChild(row);
                });
            }

            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorMessageDiv.classList.add('hidden');

                const type = page.querySelector('#type').value;
                let newTransaction = {
                    date: page.querySelector('#date').value,
                    type: type,
                    createdAt: serverTimestamp()
                };

                if (type === 'purchase') {
                    const selectedSupplierId = supplierSelect.value;
                    const amount = parseFloat(page.querySelector('#purchase-amount').value);

                    // Validación para compras
                    if (!selectedSupplierId) {
                        errorMessageDiv.textContent = "Debe seleccionar un proveedor.";
                        errorMessageDiv.classList.remove('hidden');
                        return;
                    }
                    if (isNaN(amount) || amount <= 0) {
                        errorMessageDiv.textContent = "El importe es obligatorio.";
                        errorMessageDiv.classList.remove('hidden');
                        return;
                    }
                    
                    const supplierData = allSuppliers.find(s => s.id === selectedSupplierId);

                    // --- NUEVO: Lógica para guardar fecha de cheque (MODIFICADO) ---
                    const paymentMethod = page.querySelector('#purchase-paymentMethod').value;

                    if (paymentMethod === 'Cheque') {
                        const dueDate = page.querySelector('#cheque-due-date').value;
                        if (!dueDate) {
                            errorMessageDiv.textContent = "Debe especificar la fecha de vencimiento del cheque.";
                            errorMessageDiv.classList.remove('hidden');
                            return;
                        }
                        newTransaction.checkDueDate = dueDate;
                    }

                    newTransaction.partyName = supplierData.name;
                    newTransaction.partyCuit = supplierData.cuit;
                    newTransaction.paymentMethod = paymentMethod;
                    newTransaction.amount = amount;

                } else { // Venta
                    const partyName = page.querySelector('#sale-customerName').value.trim();
                    const amount = parseFloat(page.querySelector('#sale-amount').value);

                    // Validación para ventas
                    if (!partyName || isNaN(amount) || amount <= 0) {
                        errorMessageDiv.textContent = "El nombre del cliente y el importe son obligatorios.";
                        errorMessageDiv.classList.remove('hidden');
                        return;
                    }
                    
                    newTransaction.partyName = partyName;
                    newTransaction.partyCuit = page.querySelector('#sale-cuit').value.trim();
                    newTransaction.saleType = page.querySelector('#sale-type').value;
                    newTransaction.amount = amount;
                }

                try {
                    await addDoc(collection(db, 'financial_transactions'), newTransaction);
                    showToast("Transacción agregada con éxito.", "success");
                    transactionForm.reset();
                    page.querySelector('#date').valueAsDate = new Date();
                    handleFormDisplay();
                    handleSupplierChange(); // Resetea el CUIT
                } catch (err) {
                    console.error("Error al agregar transacción:", err);
                    showToast("Error al guardar la transacción.", "error");
                }
            });

            transactionList.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;

                if (target.classList.contains('edit-btn')) {
                    const t = allTransactions.find(trans => trans.id === id);
                    if (t) {
                        editModal.querySelector('#edit-id').value = t.id;
                        editModal.querySelector('#edit-transaction-type').value = t.type;
                        
                        const editPurchaseFields = editModal.querySelector('#edit-purchase-fields');
                        const editSaleFields = editModal.querySelector('#edit-sale-fields');

                        if (t.type === 'purchase') {
                            editSaleFields.classList.add('hidden');
                            editPurchaseFields.classList.remove('hidden');
                            editModal.querySelector('#edit-purchase-supplierName').value = t.partyName;
                            editModal.querySelector('#edit-purchase-cuit').value = t.partyCuit;
                            editModal.querySelector('#edit-purchase-paymentMethod').value = t.paymentMethod;
                            editModal.querySelector('#edit-purchase-amount').value = t.amount;
                        } else {
                            editPurchaseFields.classList.add('hidden');
                            editSaleFields.classList.remove('hidden');
                            editModal.querySelector('#edit-sale-customerName').value = t.partyName;
                            editModal.querySelector('#edit-sale-cuit').value = t.partyCuit;
                            editModal.querySelector('#edit-sale-type').value = t.saleType;
                            editModal.querySelector('#edit-sale-amount').value = t.amount;
                        }
                        editModal.classList.remove('hidden');
                        editModal.style.display = 'flex';
                    }
                } else if (target.classList.contains('delete-btn')) {
                    if (confirm("¿Estás seguro de que quieres eliminar esta transacción?")) {
                        try {
                            await deleteDoc(doc(db, "financial_transactions", id));
                            showToast("Transacción eliminada.", "success");
                        } catch (err) {
                            console.error("Error al eliminar transacción:", err);
                            showToast("No se pudo eliminar la transacción.", "error");
                        }
                    }
                }
            });

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = editModal.querySelector('#edit-id').value;
                const type = editModal.querySelector('#edit-transaction-type').value;
                let updatedData = {};

                if(type === 'purchase') {
                    updatedData = {
                        partyName: editModal.querySelector('#edit-purchase-supplierName').value,
                        partyCuit: editModal.querySelector('#edit-purchase-cuit').value,
                        paymentMethod: editModal.querySelector('#edit-purchase-paymentMethod').value,
                        amount: parseFloat(editModal.querySelector('#edit-purchase-amount').value)
                    };
                } else { // Venta
                     updatedData = {
                        partyName: editModal.querySelector('#edit-sale-customerName').value,
                        partyCuit: editModal.querySelector('#edit-sale-cuit').value,
                        saleType: editModal.querySelector('#edit-sale-type').value,
                        amount: parseFloat(editModal.querySelector('#edit-sale-amount').value)
                    };
                }

                try {
                    const transactionRef = doc(db, "financial_transactions", id);
                    await updateDoc(transactionRef, updatedData);
                    showToast("Transacción actualizada.", "success");
                    editModal.classList.add('hidden');
                    editModal.style.display = 'none';
                } catch (err) {
                    console.error("Error al actualizar la transacción:", err);
                    showToast("No se pudieron guardar los cambios.", "error");
                }
            });

            cancelEditBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
                editModal.style.display = 'none';
            });
            
            function setupCharts() {
                if (lineChart) lineChart.destroy();
                // --- NUEVA CONFIGURACIÓN DEL GRÁFICO (MODIFICADO) ---
                lineChart = new Chart(lineCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Ventas',
                                data: [],
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1,
                                fill: true
                            },
                            {
                                label: 'Compras',
                                data: [],
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.1,
                                fill: true
                            },
                            {
                                type: 'bar', 
                                label: 'Cheques Pendientes',
                                data: [],
                                borderColor: 'rgba(255, 206, 86, 1)', 
                                backgroundColor: 'rgba(255, 206, 86, 0.6)', 
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Fecha' } },
                            y: { title: { display: true, text: 'Monto' }, beginAtZero: true }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { callbacks: { label: (context) => `${context.dataset.label || ''}: ${formatCurrency(context.parsed.y)}` } }
                        }
                    }
                });

                if (supplierPieChart) supplierPieChart.destroy();
                supplierPieChart = new Chart(supplierPieCtx, { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: [], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (context) => { const label = context.label || ''; const value = context.raw; const total = context.chart.getDatasetMeta(0).total; const percentage = total > 0 ? ((value / total) * 100).toFixed(2) + '%' : '0.00%'; return `${label}: ${formatCurrency(value)} (${percentage})`; }}}}}});
                
                if (paymentPieChart) paymentPieChart.destroy();
                paymentPieChart = new Chart(paymentPieCtx, { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: [], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (context) => { const label = context.label || ''; const value = context.raw; const total = context.chart.getDatasetMeta(0).total; const percentage = total > 0 ? ((value / total) * 100).toFixed(2) + '%' : '0.00%'; return `${label}: ${formatCurrency(value)} (${percentage})`; }}}}}});
            }

            // --- FUNCIÓN DE ACTUALIZACIÓN DE GRÁFICOS COMPLETAMENTE REEMPLAZADA (MODIFICADO) ---
            function updateAllCharts(transactions) {
                const sortedByDate = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

                const pendingChecks = transactions.filter(t => t.type === 'purchase' && t.paymentMethod === 'Cheque' && t.checkDueDate);
                const pendingChecksData = {};
                pendingChecks.forEach(t => {
                    const dueDate = t.checkDueDate;
                    pendingChecksData[dueDate] = (pendingChecksData[dueDate] || 0) + t.amount;
                });
                
                const transactionDates = sortedByDate.map(t => t.date);
                const checkDueDates = Object.keys(pendingChecksData);
                const allDates = [...new Set([...transactionDates, ...checkDueDates])].sort();

                const salesData = {};
                const purchasesData = {};
                
                sortedByDate.forEach(t => {
                    const date = t.date;
                    if (t.type === 'sale') {
                        salesData[date] = (salesData[date] || 0) + t.amount;
                    } else {
                        purchasesData[date] = (purchasesData[date] || 0) + t.amount;
                    }
                });

                lineChart.data.labels = allDates;
                lineChart.data.datasets[0].data = allDates.map(date => salesData[date] || 0);
                lineChart.data.datasets[1].data = allDates.map(date => purchasesData[date] || 0);
                lineChart.data.datasets[2].data = allDates.map(date => pendingChecksData[date] || 0);
                lineChart.update();

                const purchases = transactions.filter(t => t.type === 'purchase');
                const supplierSpending = {};
                purchases.forEach(t => { supplierSpending[t.partyName] = (supplierSpending[t.partyName] || 0) + t.amount; });
                updatePieChart(supplierPieChart, supplierSpending);
                const paymentMethodSpending = {};
                purchases.forEach(t => { if (t.paymentMethod) { paymentMethodSpending[t.paymentMethod] = (paymentMethodSpending[t.paymentMethod] || 0) + t.amount; }});
                updatePieChart(paymentPieChart, paymentMethodSpending);
            }

            function updatePieChart(chart, dataMap) {
                chart.data.labels = Object.keys(dataMap);
                chart.data.datasets[0].data = Object.values(dataMap);
                chart.data.datasets[0].backgroundColor = generateColors(Object.keys(dataMap).length);
                chart.update();
            }
            
            function updateAllMonthlyAnalyses(transactions) {
                const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))].sort((a, b) => b - a);
                const currentYearSelection = yearSelector.value;
                yearSelector.innerHTML = '';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelector.appendChild(option);
                });

                if (currentYearSelection && years.includes(parseInt(currentYearSelection))) {
                    yearSelector.value = currentYearSelection;
                } else if (years.length > 0) {
                    yearSelector.value = years[0];
                }

                renderMonthlyPurchasesBreakdown(transactions);
                renderMonthlySalesBreakdown(transactions);
            }

            function renderMonthlyPurchasesBreakdown(transactions) {
                const selectedYear = parseInt(yearSelector.value);
                monthlyPurchasesBreakdownContainer.innerHTML = '';
                if (isNaN(selectedYear)) return;

                const purchases = transactions.filter(t => t.type === 'purchase' && new Date(t.date).getFullYear() === selectedYear);
                
                const byMonth = purchases.reduce((acc, t) => {
                    const month = new Date(t.date).getMonth();
                    if (!acc[month]) acc[month] = [];
                    acc[month].push(t);
                    return acc;
                }, {});

                let content = '';
                for (let i = 11; i >= 0; i--) {
                    if (byMonth[i]) {
                        const monthTransactions = byMonth[i];
                        const totalMonthAmount = monthTransactions.reduce((sum, t) => sum + t.amount, 0);
                        
                        const bySupplier = monthTransactions.reduce((acc, t) => {
                            if (!acc[t.partyName]) acc[t.partyName] = 0;
                            acc[t.partyName] += t.amount;
                            return acc;
                        }, {});

                        const sortedSuppliers = Object.entries(bySupplier).sort(([, a], [, b]) => b - a);
                        const monthName = new Date(selectedYear, i).toLocaleString('es-ES', { month: 'long' });
                        
                        let suppliersHTML = sortedSuppliers.map(([name, total]) => {
                            const percentage = (total / totalMonthAmount) * 100;
                            return `
                                <li class="py-2">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-700">${name}</span>
                                        <span class="text-sm font-semibold text-gray-900">${formatCurrency(total)}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percentage.toFixed(2)}%"></div>
                                    </div>
                                    <div class="text-right text-xs text-gray-500 mt-1">${percentage.toFixed(2)}%</div>
                                </li>`;
                        }).join('');

                        content += `
                            <div class="bg-gray-50 p-4 rounded-lg border mb-4">
                                <h4 class="font-bold text-lg capitalize text-primary">${monthName} ${selectedYear}</h4>
                                <p class="text-sm text-secondary mb-3">Total Compras: ${formatCurrency(totalMonthAmount)}</p>
                                <ul class="space-y-2">${suppliersHTML}</ul>
                            </div>`;
                    }
                }
                monthlyPurchasesBreakdownContainer.innerHTML = content || `<p class="text-secondary text-center">No hay datos de compras para el año ${selectedYear}.</p>`;
            }

            function renderMonthlySalesBreakdown(transactions) {
                const selectedYear = parseInt(yearSelector.value);
                monthlySalesBreakdownContainer.innerHTML = '';
                if (isNaN(selectedYear)) return;

                const sales = transactions.filter(t => t.type === 'sale' && new Date(t.date).getFullYear() === selectedYear);
                
                const byMonth = sales.reduce((acc, t) => {
                    const month = new Date(t.date).getMonth();
                    if (!acc[month]) acc[month] = [];
                    acc[month].push(t);
                    return acc;
                }, {});

                let content = '';
                for (let i = 11; i >= 0; i--) { // Loop from December to January
                    if (byMonth[i]) {
                        const monthTransactions = byMonth[i];
                        const totalMonthAmount = monthTransactions.reduce((sum, t) => sum + t.amount, 0);
                        
                        const byChannel = monthTransactions.reduce((acc, t) => {
                            const channel = t.saleType || 'No especificado';
                            if (!acc[channel]) acc[channel] = 0;
                            acc[channel] += t.amount;
                            return acc;
                        }, {});

                        const sortedChannels = Object.entries(byChannel).sort(([, a], [, b]) => b - a);
                        const monthName = new Date(selectedYear, i).toLocaleString('es-ES', { month: 'long' });
                        
                        let channelsHTML = sortedChannels.map(([name, total]) => {
                            const percentage = (total / totalMonthAmount) * 100;
                            return `
                                <li class="py-2">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-700">${name}</span>
                                        <span class="text-sm font-semibold text-gray-900">${formatCurrency(total)}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-green-500 h-2.5 rounded-full" style="width: ${percentage.toFixed(2)}%"></div>
                                    </div>
                                    <div class="text-right text-xs text-gray-500 mt-1">${percentage.toFixed(2)}%</div>
                                </li>`;
                        }).join('');

                        content += `
                            <div class="bg-gray-50 p-4 rounded-lg border mb-4">
                                <h4 class="font-bold text-lg capitalize text-primary">${monthName} ${selectedYear}</h4>
                                <p class="text-sm text-secondary mb-3">Total Ventas: ${formatCurrency(totalMonthAmount)}</p>
                                <ul class="space-y-2">${channelsHTML}</ul>
                            </div>`;
                    }
                }
                monthlySalesBreakdownContainer.innerHTML = content || `<p class="text-secondary text-center">No hay datos de ventas para el año ${selectedYear}.</p>`;
            }
            
            yearSelector.addEventListener('change', () => updateAllMonthlyAnalyses(allTransactions));
            
            // ---> INICIO: LISTENERS PARA LOS NUEVOS FILTROS
            filterStartDate.addEventListener('change', applyFiltersAndRender);
            filterEndDate.addEventListener('change', applyFiltersAndRender);
            filterName.addEventListener('input', applyFiltersAndRender);
            clearFiltersBtn.addEventListener('click', () => {
                filterStartDate.value = '';
                filterEndDate.value = '';
                filterName.value = '';
                applyFiltersAndRender();
            });
            // ---> FIN: LISTENERS PARA LOS NUEVOS FILTROS

            function generateColors(numColors) { const colors = []; for (let i = 0; i < numColors; i++) { colors.push(`hsl(${(i * 137.508) % 360}, 65%, 60%)`); } return colors; }

            page.querySelector('#date').valueAsDate = new Date();
            setupCharts();
            listenForFinancialTransactions();
            listenForSuppliersInDashboard();
            handleFormDisplay();
        }
        
        // --- INICIO: LÓGICA DEL ANALIZADOR DE VENTAS ---
        function initializeSalesAnalyzer() {
            const page = document.getElementById('sales-analyzer-page');
            if(!page) return;

            const dropZone = page.querySelector('#drop-zone');
            const fileInput = page.querySelector('#file-input');
            const fileInfo = page.querySelector('#file-info');
            const errorMessage = page.querySelector('#analyzer-error-message');
            const resultsSection = page.querySelector('#results-section');
            
            let unitsChart = null;
            let revenueChart = null;
            let bottomUnitsChart = null;

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) handleFile(fileInput.files[0]);
            });

            function handleFile(file) {
                fileInfo.textContent = `Archivo: ${file.name}`;
                errorMessage.textContent = '';
                resultsSection.classList.add('hidden');
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                        const headerRowIndex = 6; 
                        if (sheetData.length <= headerRowIndex) {
                            showError("El archivo no tiene suficientes filas. Se esperaba la cabecera en la fila 7.");
                            return;
                        }
                        const headerRow = sheetData[headerRowIndex];

                        const colIndices = {
                            articulos: headerRow.indexOf('ARTICULOS'),
                            unidades: headerRow.indexOf('UNIDADES'),
                            total: headerRow.indexOf('TOTAL')
                        };

                        if (colIndices.articulos === -1 || colIndices.unidades === -1 || colIndices.total === -1) {
                            showError("No se encontraron las columnas 'ARTICULOS', 'UNIDADES' y 'TOTAL' en la fila 7 del archivo.");
                            return;
                        }

                        const dataRows = sheetData.slice(headerRowIndex + 1);

                        const jsonData = dataRows.map(row => ({
                            'ARTICULOS': row[colIndices.articulos],
                            'UNIDADES': row[colIndices.unidades],
                            'TOTAL': row[colIndices.total]
                        })).filter(row => row.ARTICULOS); 

                        processData(jsonData);

                    } catch (error) {
                        showError('Error al procesar el archivo. Asegúrate de que es un Excel válido.');
                        console.error(error);
                    }
                };
                reader.onerror = () => showError('No se pudo leer el archivo.');
                reader.readAsArrayBuffer(file);
            }

            function processData(data) {
                if (data.length === 0) {
                    showError('No se encontraron datos de artículos para procesar después de la fila 7.');
                    return;
                }

                const productSales = {};
                let totalRevenue = 0;
                data.forEach(row => {
                    const product = row['ARTICULOS'];
                    const units = Number(row['UNIDADES']);
                    const total = Number(row['TOTAL']);
                    
                    if (product && typeof product === 'string' && product.trim().toUpperCase() !== 'TOTALES' && product.trim() !== '' && !isNaN(units) && !isNaN(total)) {
                        if (!productSales[product]) {
                            productSales[product] = { units: 0, total: 0 };
                        }
                        productSales[product].units += units;
                        productSales[product].total += total;
                        totalRevenue += total;
                    }
                });

                const allProducts = Object.entries(productSales);

                const top10ByUnits = [...allProducts].sort(([, a], [, b]) => b.units - a.units).slice(0, 10);
                const top10ByRevenue = [...allProducts].sort(([, a], [, b]) => b.total - a.total).slice(0, 10);
                const bottom20ByUnits = [...allProducts].sort(([, a], [, b]) => a.units - b.units).slice(0, 20);
                
                const top10RevenueSum = top10ByRevenue.reduce((sum, [, values]) => sum + values.total, 0);

                if (top10ByUnits.length === 0) {
                    showError('No se encontraron datos de ventas válidos para procesar.');
                    return;
                }
                displayResults(top10ByUnits, top10ByRevenue, bottom20ByUnits, totalRevenue, Object.keys(productSales).length, top10RevenueSum);
            }

            function displayResults(top10ByUnits, top10ByRevenue, bottom20ByUnits, totalRevenue, uniqueProductsCount, top10RevenueSum) {
                resultsSection.classList.remove('hidden');
                const currencyFormatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' });
                
                page.querySelector('#total-revenue').textContent = currencyFormatter.format(totalRevenue);
                page.querySelector('#top-10-revenue').textContent = currencyFormatter.format(top10RevenueSum);
                page.querySelector('#unique-products').textContent = uniqueProductsCount;

                createTable('table-container-units', top10ByUnits, currencyFormatter);
                createTable('table-container-revenue', top10ByRevenue, currencyFormatter);
                createTable('table-container-bottom-units', bottom20ByUnits, currencyFormatter);

                createChart('chart-units', 'Unidades Vendidas', top10ByUnits, 'units', currencyFormatter);
                createChart('chart-revenue', 'Ingresos Generados', top10ByRevenue, 'total', currencyFormatter);
                createChart('chart-bottom-units', 'Unidades Vendidas', bottom20ByUnits, 'units', currencyFormatter);
            }

            function createTable(containerId, data, formatter) {
                let tableHTML = `
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="p-2 font-semibold">Artículo</th>
                                <th class="p-2 font-semibold text-center">Unidades</th>
                                <th class="p-2 font-semibold text-right">Ingresos</th>
                            </tr>
                        </thead>
                        <tbody>`;
                data.forEach(([product, values]) => {
                    tableHTML += `
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="p-2 font-medium">${product}</td>
                            <td class="p-2 text-center font-bold">${values.units}</td>
                            <td class="p-2 text-right font-semibold">${formatter.format(values.total)}</td>
                        </tr>`;
                });
                tableHTML += `</tbody></table>`;
                page.querySelector(`#${containerId}`).innerHTML = tableHTML;
            }

            function createChart(canvasId, label, data, dataKey, formatter) {
                let chartInstance;
                let barColor;
                let borderColor;

                if (canvasId === 'chart-units') {
                    chartInstance = unitsChart;
                    barColor = 'rgba(59, 130, 246, 0.7)';
                    borderColor = 'rgba(59, 130, 246, 1)';
                } else if (canvasId === 'chart-revenue') {
                    chartInstance = revenueChart;
                    barColor = 'rgba(168, 85, 247, 0.7)';
                    borderColor = 'rgba(168, 85, 247, 1)';
                } else { // chart-bottom-units
                    chartInstance = bottomUnitsChart;
                    barColor = 'rgba(249, 115, 22, 0.7)';
                    borderColor = 'rgba(249, 115, 22, 1)';
                }

                if (chartInstance) chartInstance.destroy();

                const labels = data.map(item => item[0]);
                const chartData = data.map(item => item[1][dataKey]);
                const revenueData = data.map(item => item[1].total); 
                const unitsData = data.map(item => item[1].units);

                const ctx = page.querySelector(`#${canvasId}`).getContext('2d');
                const newChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: chartData,
                            backgroundColor: barColor,
                            borderColor: borderColor,
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                titleFont: { weight: 'bold' },
                                bodyFont: { weight: 'normal' },
                                padding: 10,
                                cornerRadius: 6,
                                callbacks: {
                                    label: function(context) {
                                        const unitLabel = `Unidades: ${unitsData[context.dataIndex]}`;
                                        const revenueLabel = `Ingresos: ${formatter.format(revenueData[context.dataIndex])}`;
                                        return [unitLabel, revenueLabel];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { beginAtZero: true, grid: { color: '#e5e7eb' } },
                            y: { grid: { display: false } }
                        }
                    }
                });

                if (canvasId === 'chart-units') {
                    unitsChart = newChart;
                } else if (canvasId === 'chart-revenue') {
                    revenueChart = newChart;
                } else {
                    bottomUnitsChart = newChart;
                }
            }

            function showError(message) {
                page.querySelector('#analyzer-error-message').textContent = message;
                page.querySelector('#results-section').classList.add('hidden');
            }
        }
        // --- FIN: LÓGICA DEL ANALIZADOR DE VENTAS ---

        // --- INICIO: LÓGICA DE GESTIÓN DE PROVEEDORES ---
        function initializeSupplierManagement() {
            const page = document.getElementById('supplier-management-page');
            if (!page) return;

            const searchInput = page.querySelector('#search-supplier-input');
            const tbody = page.querySelector('#supplier-list-tbody');
            const editModal = document.getElementById('edit-supplier-modal');
            const editForm = document.getElementById('edit-supplier-form');
            
            function listenForSuppliersInManagement() {
                if (!auth.currentUser) return;
                if (unsubscribeSuppliers) unsubscribeSuppliers();
                
                const q = query(collection(db, "suppliers"), orderBy("name"));
                unsubscribeSuppliers = onSnapshot(q, (snapshot) => {
                    allSuppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSupplierList();
                }, (error) => console.error("Error al escuchar proveedores:", error));
            }

            function renderSupplierList() {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredSuppliers = allSuppliers.filter(s => s.name.toLowerCase().includes(searchTerm) || s.cuit.toLowerCase().includes(searchTerm));
                
                tbody.innerHTML = '';
                if (filteredSuppliers.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-secondary">No se encontraron proveedores.</td></tr>`;
                    return;
                }

                filteredSuppliers.forEach(supplier => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-custom last:border-none hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="p-4 font-semibold text-primary">${supplier.name}</td>
                        <td class="p-4 text-secondary">${supplier.cuit}</td>
                        <td class="p-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button data-id="${supplier.id}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg edit-supplier-btn"><i class="fas fa-pencil-alt"></i></button>
                                <button data-id="${supplier.id}" data-name="${supplier.name}" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg delete-supplier-btn"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            tbody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-supplier-btn');
                const deleteBtn = e.target.closest('.delete-supplier-btn');

                if (editBtn) {
                    const supplierId = editBtn.dataset.id;
                    const supplier = allSuppliers.find(s => s.id === supplierId);
                    if (supplier) openEditSupplierModal(supplier);
                }

                if (deleteBtn) {
                    const supplierId = deleteBtn.dataset.id;
                    const supplierName = deleteBtn.dataset.name;
                    openDeleteModal('supplier', supplierId, supplierName);
                }
            });

            function openEditSupplierModal(supplier) {
                editForm.querySelector('#edit-supplier-id').value = supplier.id;
                editForm.querySelector('#edit-supplier-name').value = supplier.name;
                editForm.querySelector('#edit-supplier-cuit').value = supplier.cuit;
                editForm.querySelector('#edit-supplier-error').classList.add('hidden');
                editModal.style.display = 'flex';
            }

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = editForm.querySelector('#edit-supplier-id').value;
                const newName = editForm.querySelector('#edit-supplier-name').value.trim();
                const newCuit = editForm.querySelector('#edit-supplier-cuit').value.trim();
                const errorDiv = editForm.querySelector('#edit-supplier-error');

                if (!newName || !newCuit) {
                    errorDiv.textContent = 'Nombre y CUIT son obligatorios.';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                const nameExists = allSuppliers.some(s => s.id !== id && s.name.toLowerCase() === newName.toLowerCase());
                if (nameExists) {
                    errorDiv.textContent = `El proveedor "${newName}" ya existe.`;
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                const cuitExists = allSuppliers.some(s => s.id !== id && s.cuit === newCuit);
                if (cuitExists) {
                    errorDiv.textContent = `El CUIT ${newCuit} ya está registrado.`;
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                errorDiv.classList.add('hidden');

                try {
                    const supplierRef = doc(db, 'suppliers', id);
                    await updateDoc(supplierRef, { name: newName, cuit: newCuit });
                    showToast('Proveedor actualizado con éxito.', 'success');
                    editModal.style.display = 'none';
                } catch (error) {
                    console.error('Error updating supplier:', error);
                    showToast('Error al actualizar el proveedor.', 'error');
                }
            });

            searchInput.addEventListener('input', renderSupplierList);
            listenForSuppliersInManagement();
        }
        // --- FIN: LÓGICA DE GESTIÓN DE PROVEEDORES ---

        // --- LÓGICA DE ELIMINACIÓN GENERAL ---
        function openDeleteModal(type, id, name) {
            itemToDelete = { type, id, name };
            const modal = document.getElementById('delete-modal');
            const text = modal.querySelector('#delete-modal-text');
            text.textContent = `¿Estás seguro de que quieres eliminar a ${name}? Esta acción no se puede deshacer.`;
            modal.style.display = 'flex';
        }

        async function handleConfirmDelete() {
            if (!itemToDelete) return;

            const { type, id, name } = itemToDelete;
            let docRef;

            if (type === 'client') {
                docRef = doc(db, "customers", id);
                try {
                    const movementsRef = collection(docRef, "movements");
                    const movementsSnapshot = await getDocs(movementsRef);
                    for (const movementDoc of movementsSnapshot.docs) { await deleteDoc(movementDoc.ref); }
                    await deleteDoc(docRef);
                    showToast(`Cliente "${name}" eliminado.`, "success");
                } catch (error) { showToast("Error al eliminar el cliente.", "error"); }
            } else if (type === 'supplier') {
                docRef = doc(db, "suppliers", id);
                 try {
                    await deleteDoc(docRef);
                    showToast(`Proveedor "${name}" eliminado.`, "success");
                } catch (error) { showToast("Error al eliminar el proveedor.", "error"); }
            }
            
            document.getElementById('delete-modal').style.display = 'none';
            itemToDelete = null;
        }


        // --- FUNCIONES DE UTILIDAD ---
        const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value || 0);
        const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleString('es-AR') : 'N/A';
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast show ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }

    </script>
</body>
</html>